
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Validating PReSto2k &#8212; Assimilating PAGES 2k records with LinkedEarth tools</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/validation/C04_validating_PReSto2k';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Proxy Database Forensics" href="C03_b_comparison.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../README.html">
  
  
  
  
  
  
    <p class="title logo__title">Assimilating PAGES 2k records with LinkedEarth tools</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    Assimilating PAGES 2k records with LinkedEarth tools
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Assembly</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../data_assembly/C01_a_db_assembly_Tardif2019_pickle.html">Database Assembly using the LMRv2.1 pickle file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_assembly/C01_b_db_assembly_cfr_PAGES2k.html">Database Assembly using cfr’s built in PAGES 2k database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_assembly/C01_d_db_assembly_LiPDGraph.html">Assembling the proxy database from the LiPDGraph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Assimilation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../data_assimilation/C02_a_DA_with_class_based_seasonality.html">Run Data Assimilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_assimilation/C02_b_DA_with_individual_seasonality.html">Run Data Assimilation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Validation and Comparison</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="C03_a_validation.html">Validating a Reconstruction</a></li>
<li class="toctree-l1"><a class="reference internal" href="C03_b_comparison.html">Proxy Database Forensics</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Validating PReSto2k</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/tanaya-g/pages2k_cfr_pb" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/tanaya-g/pages2k_cfr_pb/issues/new?title=Issue%20on%20page%20%2Fnotebooks/validation/C04_validating_PReSto2k.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/validation/C04_validating_PReSto2k.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Validating PReSto2k</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#author">Author</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-reconstructions">Load the Reconstructions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gmst-plots">GMST plots</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#difference-plots">Difference Plots</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pens">Pens</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#instrumental-validation">Instrumental Validation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gmst-comparisons">GMST comparisons</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gistemp">GISTEMP</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hadcrut5">HADCRUT5</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#berkeley-earth-surface-temperature-best">Berkeley Earth Surface Temperature (BEST)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#consensus">Consensus</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#takeaways-from-the-results-table">Takeaways from the Results Table</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#validation-on-climate-fields">Validation on Climate Fields</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#best">BEST</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psm-calibration-statistics">PSM Calibration Statistics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-proxy-databases">Load Proxy Databases</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-plots">Make Plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#to-do-validation-against-withheld-proxies">To-Do: Validation Against Withheld Proxies</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="validating-presto2k">
<h1>Validating PReSto2k<a class="headerlink" href="#validating-presto2k" title="Link to this heading">#</a></h1>
<section id="author">
<h2>Author<a class="headerlink" href="#author" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://orcid.org/0009-0004-2440-3266">Tanaya Gondhalekar</a></p>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h2>
<p>For this notebook, we will be following a similar formula as the general <em>Validating a Reconstruction</em> Notebook. The goal is to evaluate the skill of the “PReSto2k” reconstructions, produced by adding records from <a class="reference external" href="https://pastglobalchanges.org/science/wg/2k-network/projects/iso2k/intro">Iso2k</a>, and <a class="reference external" href="https://pastglobalchanges.org/science/wg/2k-network/projects/coral-hydro/intro">CoralHydro2k</a> to the <a class="reference external" href="https://pastglobalchanges.org/science/wg/2k-network/Phase_2_Databases/Global_Temp/V2.0.0_2017">PAGES2k</a> compilation. Our baseline for the various comparisons are to <a class="reference external" href="https://doi.org/10.5194/cp-15-1251-2019">LMRv2.1</a>, which used only PAGES 2k records, specifically those from wood, coral and glacier ice archives with annual or better resolution.  Specifically, we seek to quantify improvements/changes made as part of the <a class="reference external" href="https://paleopresto.com/#:~:text=Presto%20is%20the%20Paleoclimate%20Reconstruction,our%20understanding%20of%20past%20climate."><em>PReSto</em></a>  project.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="kn">import</span><span class="w"> </span><span class="nn">cfr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cfr</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pens</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>

<span class="c1"># Plotting helpers  </span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.gridspec</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gridspec</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.crs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ccrs</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cartopy.feature</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cfeature</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScalarMappable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">Normalize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2025.7.28
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-the-reconstructions">
<h2>Load the Reconstructions<a class="headerlink" href="#load-the-reconstructions" title="Link to this heading">#</a></h2>
<p>Within PReSto2k, we have three separate reconstructions:</p>
<ul class="simple">
<li><p>PReSto2k with class-based seasonality</p></li>
<li><p>PReSto2k with metadata-based seasonality</p></li>
<li><p>PReSto2k with metadata-based seasonality and interpolation</p></li>
</ul>
<p>We will compare them against the base reconstruction of LMRv2.1 <a class="reference external" href="https://cp.copernicus.org/articles/15/1251/2019/">Tardif et al. 2019</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load class-based</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ReconRes</span><span class="p">(</span><span class="s1">&#39;./recons/lmr_reproduce_lipd/&#39;</span><span class="p">)</span>
<span class="n">res</span><span class="o">.</span><span class="n">load</span><span class="p">([</span><span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;tas_gm&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load meta-based</span>

<span class="n">res1</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ReconRes</span><span class="p">(</span><span class="s1">&#39;./recons/presto2k_season/&#39;</span><span class="p">)</span>
<span class="n">res1</span><span class="o">.</span><span class="n">load</span><span class="p">([</span><span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;tas_gm&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load meta-based with interpolation</span>

<span class="n">res2</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ReconRes</span><span class="p">(</span><span class="s1">&#39;./recons/presto2k_season_interp/&#39;</span><span class="p">)</span>
<span class="n">res2</span><span class="o">.</span><span class="n">load</span><span class="p">([</span><span class="s1">&#39;tas&#39;</span><span class="p">,</span> <span class="s1">&#39;tas_gm&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_ts</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">recons</span><span class="p">[</span><span class="s1">&#39;tas_gm&#39;</span><span class="p">]</span>
<span class="n">res1_ts</span> <span class="o">=</span> <span class="n">res1</span><span class="o">.</span><span class="n">recons</span><span class="p">[</span><span class="s1">&#39;tas_gm&#39;</span><span class="p">]</span>
<span class="n">res2_ts</span> <span class="o">=</span> <span class="n">res2</span><span class="o">.</span><span class="n">recons</span><span class="p">[</span><span class="s1">&#39;tas_gm&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load LMRv2.1 (offline DA) </span>

<span class="n">lmr_off</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;./prev_data/gmt_MCruns_ensemble_full_LMRv2.1.nc&#39;</span><span class="p">)</span>
<span class="n">ens_values</span> <span class="o">=</span> <span class="n">lmr_off</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">ensemble</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MCrun&#39;</span><span class="p">,</span> <span class="s1">&#39;members&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Shape: (time, MCrun*members)</span>
<span class="n">time_values</span> <span class="o">=</span> <span class="n">lmr_off</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span>
<span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_values</span><span class="p">])</span>
<span class="n">lmr_ens</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">EnsTS</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">years</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ens_values</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Temperature Anomaly (°C)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="gmst-plots">
<h2>GMST plots<a class="headerlink" href="#gmst-plots" title="Link to this heading">#</a></h2>
<p>We first plot the GMST ensembles for all four reconstructions. This is mainly to see if we can identify any striking differences and check if the variability appears similar or different within each of the reconstructions. Another thing we can check just with our eyes is to see if there is any variation in how each of the reconstructions captured extreme climate events.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="n">lmr_ens</span><span class="o">.</span><span class="n">plot_qs</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;LMRv2.1 (Offline w/ class based seasonality)&#39;</span><span class="p">)</span>

<span class="n">res_ts</span><span class="o">.</span><span class="n">plot_qs</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PReSto2k w/ class-based seasonality&#39;</span><span class="p">)</span>

<span class="n">res1_ts</span><span class="o">.</span><span class="n">plot_qs</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PReSto2k w/ meta-seasonality&#39;</span><span class="p">)</span>

<span class="n">res2_ts</span><span class="o">.</span><span class="n">plot_qs</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax4</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span> 
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PReSto2k w/ meta-seasonality + interpolation&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7e4c77c48394eb8c997fd332121b9b2cd09f0d5b61743be5de3b5a7e5eb93e8a.png" src="../../_images/7e4c77c48394eb8c997fd332121b9b2cd09f0d5b61743be5de3b5a7e5eb93e8a.png" />
</div>
</div>
<p>Upon first glance, all four reconstructions look very similar. Though you can notice that in LMRv2.1 and PReSto2k with class-based seasonality, there are more significant dips in temperature around 550 CE. In contrast, in the metadata-based reconstructions, there appears to be greater cooling around 1800 CE, which is not captured by the first two. We can examine this segment further to see if it coincides with the Tambora Eruption (1815).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">res2_ts</span><span class="o">.</span><span class="n">plot_qs</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="mi">1750</span><span class="p">,</span> <span class="mi">1850</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;PReSto2k meta season w/ interp (1750–1850)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/8744743bda59b386df99e280f15602512e3b7cbd8a436d2acb8e12286c206b61.png" src="../../_images/8744743bda59b386df99e280f15602512e3b7cbd8a436d2acb8e12286c206b61.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">median_ts</span> <span class="o">=</span> <span class="n">res2_ts</span><span class="o">.</span><span class="n">median</span>        
<span class="n">imin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">median_ts</span><span class="p">)</span>
<span class="n">t_min_median</span> <span class="o">=</span> <span class="n">res2_ts</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">imin</span><span class="p">]</span>
<span class="n">v_min_median</span> <span class="o">=</span> <span class="n">median_ts</span><span class="p">[</span><span class="n">imin</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Minimum: </span><span class="si">{</span><span class="n">v_min_median</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> at year </span><span class="si">{</span><span class="n">t_min_median</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Minimum: -0.725 at year 1815.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Looking at the spatial patterns of this minimum year</span>

<span class="n">res1</span><span class="o">.</span><span class="n">recons</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">][</span><span class="s1">&#39;1815&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>      
        <span class="n">cbar_labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>  
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;Figure size 1000x800 with 2 Axes&gt;, &lt;GeoAxes: title={&#39;center&#39;: &#39;tas, 1815&#39;}&gt;)
</pre></div>
</div>
<img alt="../../_images/6e096603655dbf80153e4271dc66cbdde087b85a09a00b2d61eef6f93e2ed7dd.png" src="../../_images/6e096603655dbf80153e4271dc66cbdde087b85a09a00b2d61eef6f93e2ed7dd.png" />
</div>
</div>
<section id="difference-plots">
<h3>Difference Plots<a class="headerlink" href="#difference-plots" title="Link to this heading">#</a></h3>
<p>Since we cannot tell (accurately) how similar or different reconstructions are at a glace, a difference plot of their ensemble mean can be a good way to identify specific instances where one reconstruction captures greater warming/cooling over another. Within this, instead of comparing each reconstruction to another, I thought it would be important to reduce it down to three main comparisons.</p>
<ul class="simple">
<li><p>PReSto2k class-based vs. LMRv2.1</p></li>
<li><p>PReSto2k meta-based vs. LMRv2.1</p></li>
<li><p>PReSto2k meta-based vs. class-based</p></li>
</ul>
<p>For comparison purposes, both metadata based seasonality approaches are treated as mostly the same. In a subsequent section (instrumental validation), we will see that the added interpolation tends to improve the reconstruction ever so slightly, but that can be added to these validation methods later on if we see fit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the ensemble means</span>

<span class="n">lmr_ens_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lmr_ens</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">res_ts_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">res_ts</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">res1_ts_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">res1_ts</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Use the minimum length for everything</span>
<span class="n">min_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lmr_ens_mean</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_ts_mean</span><span class="p">))</span>
<span class="n">difference</span> <span class="o">=</span> <span class="n">res_ts_mean</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span> <span class="o">-</span> <span class="n">lmr_ens_mean</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span> 
<span class="n">difference2</span> <span class="o">=</span> <span class="n">res1_ts_mean</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span> <span class="o">-</span> <span class="n">lmr_ens_mean</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span>
<span class="n">difference3</span> <span class="o">=</span> <span class="n">res1_ts_mean</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span> <span class="o">-</span> <span class="n">res_ts_mean</span><span class="p">[:</span><span class="n">min_len</span><span class="p">]</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find common y-axis limits</span>
<span class="n">y_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">difference</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">difference2</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.1</span>
<span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">difference</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">difference2</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.1</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Top plot: Class-based difference</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lmr_ens</span><span class="o">.</span><span class="n">time</span><span class="p">[:</span><span class="n">min_len</span><span class="p">],</span> <span class="n">difference</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Difference (°C)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;LMRv2.1 - PReSto2k (Class-based)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>

<span class="c1"># Bottom plot: Meta-based difference</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lmr_ens</span><span class="o">.</span><span class="n">time</span><span class="p">[:</span><span class="n">min_len</span><span class="p">],</span> <span class="n">difference2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Difference (°C)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;LMRv2.1 - PReSto2k (Meta-based)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>

<span class="c1"># Bottom plot: Meta-based difference</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lmr_ens</span><span class="o">.</span><span class="n">time</span><span class="p">[:</span><span class="n">min_len</span><span class="p">],</span> <span class="n">difference3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\Delta T$ (°C)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PReSto2k (class-based) - PReSto2k (Meta-based)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Difference Between Ensemble Means&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/cc03dd5625cad4950b66b7de03a60d98fd98989f4f639c03c5b33beaf8150f40.png" src="../../_images/cc03dd5625cad4950b66b7de03a60d98fd98989f4f639c03c5b33beaf8150f40.png" />
</div>
</div>
<p>Using these difference plots, it is immediately more noticeable that there are some spots (notably around 850 CE) where LMRv2.1 does not capture as great a cooling as either PReSto 2k reconstruction. It is also apparent that the differences between class-based and expert seasonality appear to be much smaller than compared to LMRv2.1. It is also clear that class-based seasonality predicts cooler overall temperature anomalies than compilation metadata (expert-based) before 1000 CE.</p>
</section>
</section>
<section id="pens">
<h2>Pens<a class="headerlink" href="#pens" title="Link to this heading">#</a></h2>
<p>As done in <em>Validating a Reconstruction</em>, we will use the plume framework introduced by <a class="reference external" href="https://journals.ametsoc.org/view/journals/clim/38/5/JCLI-D-24-0101.1.xml">Emile-Geay et al. (2025)</a> using the <em>pens</em> package. To summarize again, this framework compares collections of climate trajectories (plumes) by evaluating:</p>
<ul class="simple">
<li><p>Intra-ensemble distances, which describe the spread of trajectories within an ensemble.</p></li>
<li><p>Inter-ensemble distances, which measure differences between two ensembles.</p></li>
<li><p>The plume distance, a summary metric (°C) that captures the degree of similarity (or dissimilarity) between two plumes while accounting for internal variability.</p></li>
</ul>
<p>We compute these distances using the GMST ensembles from the original LMRv2.1 and our PReSto2k reconstructions. All are converted into <code class="docutils literal notranslate"><span class="pre">pens.EnsembleTS</span></code> objects for ease of comparison.</p>
<p><strong>Note</strong>: The closer the plume distance is to zero, the more similar the ensembles are.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pens</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
<span class="n">pens</span><span class="o">.</span><span class="n">set_style</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function for ease of plotting multiple comparisons</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_pens</span><span class="p">(</span><span class="n">ts1</span><span class="p">,</span> <span class="n">ts1_name</span><span class="p">,</span> <span class="n">ts2</span><span class="p">,</span> <span class="n">ts2_name</span><span class="p">):</span>
    <span class="c1"># Convert cfr EnsTS to pens EnsTS</span>
    <span class="n">ts1_pens</span> <span class="o">=</span> <span class="n">pens</span><span class="o">.</span><span class="n">EnsembleTS</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">ts1</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ts1</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">ts1_pens</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Original LMR&#39;</span>
    <span class="n">ts1_pens</span><span class="o">.</span><span class="n">time_unit</span> <span class="o">=</span> <span class="s1">&#39;years&#39;</span>
    <span class="n">ts1_pens</span><span class="o">.</span><span class="n">value_name</span> <span class="o">=</span> <span class="s1">&#39;GMST&#39;</span>
    <span class="n">ts1_pens</span><span class="o">.</span><span class="n">value_unit</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\N{DEGREE SIGN}</span><span class="s1">C&#39;</span>

    <span class="n">ts2_pens</span> <span class="o">=</span> <span class="n">pens</span><span class="o">.</span><span class="n">EnsembleTS</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">ts2</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">ts2</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">ts2_pens</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;PReSto2k-offlineDA&#39;</span>
    <span class="n">ts2_pens</span><span class="o">.</span><span class="n">time_unit</span> <span class="o">=</span> <span class="s1">&#39;years&#39;</span>
    <span class="n">ts2_pens</span><span class="o">.</span><span class="n">value_name</span> <span class="o">=</span> <span class="s1">&#39;GMST&#39;</span>
    <span class="n">ts2_pens</span><span class="o">.</span><span class="n">value_unit</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\N{DEGREE SIGN}</span><span class="s1">C&#39;</span>

    <span class="c1"># Align time dimension for both EnsTS</span>

    <span class="n">ts1_time</span> <span class="o">=</span> <span class="n">ts1</span><span class="o">.</span><span class="n">time</span>
    <span class="n">ts2_time</span> <span class="o">=</span> <span class="n">ts2</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span>

    <span class="n">common_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ts1_time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ts2_time</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">common_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ts1_time</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ts2_time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="c1"># Create time range array</span>
    <span class="n">timespan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">common_start</span><span class="p">,</span> <span class="n">common_end</span><span class="p">])</span>

    <span class="c1"># Slice to common period</span>
    <span class="n">ts1_pens_aligned</span> <span class="o">=</span> <span class="n">ts1_pens</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">timespan</span><span class="p">)</span>
    <span class="n">ts2_pens_aligned</span> <span class="o">=</span> <span class="n">ts2_pens</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">timespan</span><span class="p">)</span>

    <span class="c1"># Calculate stats </span>
    <span class="n">ts1_intra</span> <span class="o">=</span> <span class="n">ts1_pens_aligned</span><span class="o">.</span><span class="n">distance</span><span class="p">()</span>
    <span class="n">ts2_intra</span> <span class="o">=</span> <span class="n">ts2_pens_aligned</span><span class="o">.</span><span class="n">distance</span><span class="p">()</span>

    <span class="c1"># Calculate inter-ensemble distance </span>
    <span class="n">inter_dist</span> <span class="o">=</span> <span class="n">ts1_pens_aligned</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">ts2_pens_aligned</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        
    <span class="c1"># Calculate plume distance </span>
    <span class="n">plume_dist</span> <span class="o">=</span> <span class="n">ts1_pens_aligned</span><span class="o">.</span><span class="n">plume_distance</span><span class="p">(</span><span class="n">ts2_pens_aligned</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Distances between ensembles:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original intra-ensemble distance : </span><span class="si">{</span><span class="n">ts1_intra</span><span class="si">}</span><span class="s2">,\ len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ts1_intra</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reproduced intra-ensemble distance: </span><span class="si">{</span><span class="n">ts2_intra</span><span class="si">}</span><span class="s2">,\ len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ts2_intra</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inter-ensemble distance: </span><span class="si">{</span><span class="n">inter_dist</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plume distance: </span><span class="si">{</span><span class="n">plume_dist</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


    <span class="c1"># Create figure and plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

    <span class="c1"># Plot KDE for individual ensembles with explicit labels</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ts1_intra</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ts1_name</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ts2_intra</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ts2_name</span><span class="p">)</span>

    <span class="c1"># Add inter-ensemble distribution</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">inter_dist</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;silver&#39;</span><span class="p">,</span> 
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;inter-ensemble&#39;</span><span class="p">)</span>

    <span class="c1"># Add plume distance line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">plume_dist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;plume distance&#39;</span><span class="p">)</span>

    <span class="c1"># Axis + ticks</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>


    <span class="c1"># Add labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Distance&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distance Distributions&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_pens</span><span class="p">(</span><span class="n">lmr_ens</span><span class="p">,</span> <span class="s1">&#39;LMRv2.1 Offline&#39;</span><span class="p">,</span> <span class="n">res1_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k meta seasonality (no interp)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing intra-ensemble distance among possible pairs: 100%|██████████| 1999000/1999000 [00:42&lt;00:00, 47494.24it/s]
Computing intra-ensemble distance among possible pairs: 100%|██████████| 12497500/12497500 [03:58&lt;00:00, 52481.32it/s]
Computing inter-ensemble distance: 100%|██████████| 2000/2000 [03:30&lt;00:00,  9.51it/s]
Computing inter-ensemble distance: 100%|██████████| 2000/2000 [03:29&lt;00:00,  9.53it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distances between ensembles:
Original intra-ensemble distance : [0.40367679 0.21343417 0.04743079 ... 0.26221506 0.05118074 0.29547632],\ len=1999000
Reproduced intra-ensemble distance: [1.0092546  0.17004128 0.33781567 ... 0.19607017 0.12532675 0.07074343],\ len=12497500
Inter-ensemble distance: [0.31925129 0.6902534  0.15575017 ... 0.21786565 0.41357816 0.34283473]
Plume distance: 0.15510274440047797
</pre></div>
</div>
<img alt="../../_images/1e04c12351684e5f237bef68023bf01b00d131f6e03952169c2c67ea9035ee86.png" src="../../_images/1e04c12351684e5f237bef68023bf01b00d131f6e03952169c2c67ea9035ee86.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_pens</span><span class="p">(</span><span class="n">lmr_ens</span><span class="p">,</span> <span class="s1">&#39;LMRv2.1 Offline&#39;</span><span class="p">,</span> <span class="n">res_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k class-based&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing intra-ensemble distance among possible pairs: 100%|██████████| 1999000/1999000 [00:42&lt;00:00, 46933.43it/s]
Computing intra-ensemble distance among possible pairs: 100%|██████████| 12497500/12497500 [04:01&lt;00:00, 51812.75it/s]
Computing inter-ensemble distance: 100%|██████████| 2000/2000 [03:32&lt;00:00,  9.40it/s]
Computing inter-ensemble distance: 100%|██████████| 2000/2000 [03:31&lt;00:00,  9.44it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distances between ensembles:
Original intra-ensemble distance : [0.40367679 0.21343417 0.04743079 ... 0.26221506 0.05118074 0.29547632],\ len=1999000
Reproduced intra-ensemble distance: [0.91594323 0.13586752 0.2780244  ... 0.2092932  0.15233736 0.05700134],\ len=12497500
Inter-ensemble distance: [0.26008597 0.65616499 0.13131738 ... 0.2464135  0.45569422 0.39873838]
Plume distance: 0.15399506737029178
</pre></div>
</div>
<img alt="../../_images/fc454298ef20345699fd8d1742f96f6deb017f35f7bfce0eb2b8b8a7f71000e5.png" src="../../_images/fc454298ef20345699fd8d1742f96f6deb017f35f7bfce0eb2b8b8a7f71000e5.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_pens</span><span class="p">(</span><span class="n">res_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k class based&#39;</span><span class="p">,</span> <span class="n">res2_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k meta with interp&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing intra-ensemble distance among possible pairs: 100%|██████████| 12497500/12497500 [04:00&lt;00:00, 51859.78it/s]
Computing intra-ensemble distance among possible pairs: 100%|██████████| 12497500/12497500 [04:00&lt;00:00, 51873.87it/s]
Computing inter-ensemble distance: 100%|██████████| 5000/5000 [07:57&lt;00:00, 10.47it/s]
Computing inter-ensemble distance: 100%|██████████| 5000/5000 [07:54&lt;00:00, 10.55it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distances between ensembles:
Original intra-ensemble distance : [0.91594323 0.13586752 0.2780244  ... 0.2092932  0.15233736 0.05700134],\ len=12497500
Reproduced intra-ensemble distance: [1.00691248 0.16223658 0.33689253 ... 0.19224536 0.12171932 0.07052603],\ len=12497500
Inter-ensemble distance: [0.08145034 0.95276477 0.11608722 ... 0.15290283 0.07001891 0.0692549 ]
Plume distance: 0.14609708156212153
</pre></div>
</div>
<img alt="../../_images/02df08b1d2e7f0dbc218d490ca055bd49a1b731b6019150a2110f2c081e0ce86.png" src="../../_images/02df08b1d2e7f0dbc218d490ca055bd49a1b731b6019150a2110f2c081e0ce86.png" />
</div>
</div>
<p>As we see here, all three of the comparisons have plume distances ~0.15 °C, which is not negligible but still within range of the inter-ensemble spread. The smallest distance is between the PReSto2k metadata and class-based versions, which we also noted earlier in the difference plots as being most similar. Importantly, all plume distances fall within the spread of intra-ensemble variability and closely track the original distribution, indicating that the reconstructions are statistically compatible and not significantly different from each other.</p>
</section>
<section id="instrumental-validation">
<h2>Instrumental Validation<a class="headerlink" href="#instrumental-validation" title="Link to this heading">#</a></h2>
<p>While comparing against other reconstructions is important, we can only establish skill by comparising against instrumental (and independent) data. We will validate our PReSto2k reconstructions’ GMST against the original LMRv2.1 (offline) and some instrumental datasets (HadCRUT5, BEST, GISTEMP). These datasets were used to validate the original LMRv2.1 back in 2019; here we will be using the most updated versions of the datasets.</p>
<p><em>cfr</em>’s <code class="docutils literal notranslate"><span class="pre">EnsTS.compare()</span></code> will take the ensemble time series and the plot the median and the spread of our original dataset and plot it against the target, or validation, dataset.</p>
<p>The following function uses built-in <code class="docutils literal notranslate"><span class="pre">cfr</span></code> functionality to compare two GMST time series and returns the comparison data array as well as the validation statistics (<span class="math notranslate nohighlight">\(r\)</span>, <span class="math notranslate nohighlight">\(CE\)</span>).</p>
<p>To save space and for the reason of not making this step convoluted, we have opted out of making comparison plots for all the validations (3 instrumental data sets x 4 reconstructions… a lot). Instead, the validation statistics from this function will be output in a table at the end of the section.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_ensts_compare</span><span class="p">(</span><span class="n">target_ts</span><span class="p">,</span> <span class="n">target_name</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">ts_name</span><span class="p">,</span> <span class="n">timespan</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1880</span><span class="p">,</span><span class="mi">2000</span><span class="p">)):</span>
    <span class="n">compared</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="n">target_ts</span><span class="p">,</span> 
    <span class="n">ref_name</span><span class="o">=</span><span class="n">target_name</span> <span class="p">,</span> 
    <span class="n">timespan</span><span class="o">=</span> <span class="n">timespan</span>
    <span class="p">)</span>

    <span class="n">corr</span> <span class="o">=</span> <span class="n">compared</span><span class="o">.</span><span class="n">valid_stats</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">]</span>
    <span class="n">CE</span> <span class="o">=</span> <span class="n">compared</span><span class="o">.</span><span class="n">valid_stats</span><span class="p">[</span><span class="s1">&#39;CE&#39;</span><span class="p">]</span>

    <span class="c1">#fig, ax = compared.plot_qs(figsize=[12, 4], xlim=[1880,2000], title= f&#39;{ts_name} v {target_name}&#39;)</span>

    <span class="k">return</span> <span class="n">compared</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">CE</span>
</pre></div>
</div>
</div>
</div>
<section id="gmst-comparisons">
<h3>GMST comparisons<a class="headerlink" href="#gmst-comparisons" title="Link to this heading">#</a></h3>
<section id="gistemp">
<h4>GISTEMP<a class="headerlink" href="#gistemp" title="Link to this heading">#</a></h4>
<p>The first dataset we will use to validate is <a class="reference external" href="https://data.giss.nasa.gov/gistemp/news/2010summer/">GISTEMP</a>. Note that GISTEMPv4 is instrumental data, but it is not independent as it was used to calibrate our proxy system models. Given this, we expect the corr and CE for all reconstructions to be especially high for this dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gis</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;./analyses/GISTEMP/gistemp1200_ERSSTv4.nc&#39;</span><span class="p">)</span>
<span class="n">gis</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:      (lat: 5, lon: 5, time: 5, nv: 2)
Coordinates:
  * lat          (lat) float32 -89.0 -87.0 -85.0 -83.0 -81.0
  * lon          (lon) float32 -179.0 -177.0 -175.0 -173.0 -171.0
  * time         (time) datetime64[ns] 1880-01-15 1880-02-15 ... 1880-05-15
Dimensions without coordinates: nv
Data variables:
    time_bnds    (time, nv) datetime64[ns] 1880-01-01 1880-02-01 ... 1880-06-01
    tempanomaly  (time, lat, lon) float32 nan nan nan nan ... nan nan nan nan
Attributes:
    title:        GISTEMP Surface Temperature Analysis
    institution:  NASA Goddard Institute for Space Studies
    source:       http://data.giss.nasa.gov/gistemp/
    Conventions:  CF-1.6
    history:      Created 2017-05-12 10:40:20 by SBBX_to_nc 2.0 - ILAND=1200,...</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-e11ce840-6dca-44cd-9b68-1e1fa9246368' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-e11ce840-6dca-44cd-9b68-1e1fa9246368' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>lat</span>: 5</li><li><span class='xr-has-index'>lon</span>: 5</li><li><span class='xr-has-index'>time</span>: 5</li><li><span>nv</span>: 2</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-cf8ea85e-16c6-4437-981d-e98560987858' class='xr-section-summary-in' type='checkbox'  checked><label for='section-cf8ea85e-16c6-4437-981d-e98560987858' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>lat</span></div><div class='xr-var-dims'>(lat)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>-89.0 -87.0 -85.0 -83.0 -81.0</div><input id='attrs-6a57c91b-873d-46d2-b6c4-84f7249e2ce8' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-6a57c91b-873d-46d2-b6c4-84f7249e2ce8' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c04ea694-1fa2-4034-aeb9-0e70a1069bda' class='xr-var-data-in' type='checkbox'><label for='data-c04ea694-1fa2-4034-aeb9-0e70a1069bda' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>standard_name :</span></dt><dd>latitude</dd><dt><span>long_name :</span></dt><dd>Latitude</dd><dt><span>units :</span></dt><dd>degrees_north</dd></dl></div><div class='xr-var-data'><pre>array([-89., -87., -85., -83., -81.], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>lon</span></div><div class='xr-var-dims'>(lon)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>-179.0 -177.0 -175.0 -173.0 -171.0</div><input id='attrs-b49e8517-f327-4faf-8797-82876f410afa' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-b49e8517-f327-4faf-8797-82876f410afa' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-f09c3dae-235c-4eae-9715-f782ea3a0b48' class='xr-var-data-in' type='checkbox'><label for='data-f09c3dae-235c-4eae-9715-f782ea3a0b48' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>standard_name :</span></dt><dd>longitude</dd><dt><span>long_name :</span></dt><dd>Longitude</dd><dt><span>units :</span></dt><dd>degrees_east</dd></dl></div><div class='xr-var-data'><pre>array([-179., -177., -175., -173., -171.], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>1880-01-15 ... 1880-05-15</div><input id='attrs-1336c18f-cc9f-430d-9cef-c750d01e2f18' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-1336c18f-cc9f-430d-9cef-c750d01e2f18' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c7c6997f-9b47-450e-8dee-34ef9b5987b7' class='xr-var-data-in' type='checkbox'><label for='data-c7c6997f-9b47-450e-8dee-34ef9b5987b7' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>time</dd><dt><span>bounds :</span></dt><dd>time_bnds</dd></dl></div><div class='xr-var-data'><pre>array([&#x27;1880-01-15T00:00:00.000000000&#x27;, &#x27;1880-02-15T00:00:00.000000000&#x27;,
       &#x27;1880-03-15T00:00:00.000000000&#x27;, &#x27;1880-04-15T00:00:00.000000000&#x27;,
       &#x27;1880-05-15T00:00:00.000000000&#x27;], dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-0e96f0c6-6c4d-4376-bd48-7f35c787e243' class='xr-section-summary-in' type='checkbox'  checked><label for='section-0e96f0c6-6c4d-4376-bd48-7f35c787e243' class='xr-section-summary' >Data variables: <span>(2)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>time_bnds</span></div><div class='xr-var-dims'>(time, nv)</div><div class='xr-var-dtype'>datetime64[ns]</div><div class='xr-var-preview xr-preview'>1880-01-01 ... 1880-06-01</div><input id='attrs-516a49d7-8d0b-42a1-91c9-e9a11476af77' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-516a49d7-8d0b-42a1-91c9-e9a11476af77' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-ffcb8922-32a1-47f1-aa06-c55575d4eaf4' class='xr-var-data-in' type='checkbox'><label for='data-ffcb8922-32a1-47f1-aa06-c55575d4eaf4' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[&#x27;1880-01-01T00:00:00.000000000&#x27;, &#x27;1880-02-01T00:00:00.000000000&#x27;],
       [&#x27;1880-02-01T00:00:00.000000000&#x27;, &#x27;1880-03-01T00:00:00.000000000&#x27;],
       [&#x27;1880-03-01T00:00:00.000000000&#x27;, &#x27;1880-04-01T00:00:00.000000000&#x27;],
       [&#x27;1880-04-01T00:00:00.000000000&#x27;, &#x27;1880-05-01T00:00:00.000000000&#x27;],
       [&#x27;1880-05-01T00:00:00.000000000&#x27;, &#x27;1880-06-01T00:00:00.000000000&#x27;]],
      dtype=&#x27;datetime64[ns]&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>tempanomaly</span></div><div class='xr-var-dims'>(time, lat, lon)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>nan nan nan nan ... nan nan nan nan</div><input id='attrs-85cc88d7-97a6-4b04-b860-e91f7dcf8e99' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-85cc88d7-97a6-4b04-b860-e91f7dcf8e99' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-b9818020-b67f-46e7-8c2f-35982cf2d64b' class='xr-var-data-in' type='checkbox'><label for='data-b9818020-b67f-46e7-8c2f-35982cf2d64b' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>long_name :</span></dt><dd>Surface temperature anomaly</dd><dt><span>units :</span></dt><dd>K</dd><dt><span>cell_methods :</span></dt><dd>time: mean</dd></dl></div><div class='xr-var-data'><pre>array([[[nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan]],

       [[nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan]],

       [[nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan]],

       [[nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan]],

       [[nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan],
        [nan, nan, nan, nan, nan]]], dtype=float32)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-400e729d-4711-46a6-b9b7-9b188b0a47e4' class='xr-section-summary-in' type='checkbox'  ><label for='section-400e729d-4711-46a6-b9b7-9b188b0a47e4' class='xr-section-summary' >Indexes: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>lat</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-fd1b83b5-2c67-4e80-9a50-37393b2675df' class='xr-index-data-in' type='checkbox'/><label for='index-fd1b83b5-2c67-4e80-9a50-37393b2675df' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([-89.0, -87.0, -85.0, -83.0, -81.0], dtype=&#x27;float64&#x27;, name=&#x27;lat&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>lon</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-0ace3a1b-56e3-49f1-bc0a-9abd6442eada' class='xr-index-data-in' type='checkbox'/><label for='index-0ace3a1b-56e3-49f1-bc0a-9abd6442eada' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([-179.0, -177.0, -175.0, -173.0, -171.0], dtype=&#x27;float64&#x27;, name=&#x27;lon&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>time</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-c9469c81-6222-413e-87aa-0763e0498668' class='xr-index-data-in' type='checkbox'/><label for='index-c9469c81-6222-413e-87aa-0763e0498668' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(DatetimeIndex([&#x27;1880-01-15&#x27;, &#x27;1880-02-15&#x27;, &#x27;1880-03-15&#x27;, &#x27;1880-04-15&#x27;,
               &#x27;1880-05-15&#x27;],
              dtype=&#x27;datetime64[ns]&#x27;, name=&#x27;time&#x27;, freq=None))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-e3946f0f-40dc-4b28-a3f1-951fda339e89' class='xr-section-summary-in' type='checkbox'  checked><label for='section-e3946f0f-40dc-4b28-a3f1-951fda339e89' class='xr-section-summary' >Attributes: <span>(5)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>title :</span></dt><dd>GISTEMP Surface Temperature Analysis</dd><dt><span>institution :</span></dt><dd>NASA Goddard Institute for Space Studies</dd><dt><span>source :</span></dt><dd>http://data.giss.nasa.gov/gistemp/</dd><dt><span>Conventions :</span></dt><dd>CF-1.6</dd><dt><span>history :</span></dt><dd>Created 2017-05-12 10:40:20 by SBBX_to_nc 2.0 - ILAND=1200, IOCEAN=NCDC/ER4, Base: 1951-1980</dd></dl></div></li></ul></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Area weights ~ cos(lat)</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">gis</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]))</span>

<span class="c1"># Weighted mean over space</span>
<span class="n">gm</span> <span class="o">=</span> <span class="n">gis</span><span class="o">.</span><span class="n">tempanomaly</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span>

<span class="n">gis_annual</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Make sure values are properly shaped ([,:1])</span>
<span class="n">gis_values</span> <span class="o">=</span> <span class="n">gis_annual</span><span class="o">.</span><span class="n">values</span>
<span class="k">if</span> <span class="n">gis_values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">gis_values</span> <span class="o">=</span> <span class="n">gis_values</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> 

<span class="c1"># annualize GISTEMP</span>
<span class="n">gis_ts_annual</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">EnsTS</span><span class="p">(</span>
    <span class="n">time</span><span class="o">=</span><span class="n">gis_annual</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="n">gis_values</span><span class="p">,</span>
    <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Temperature Anomaly&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gis_res</span><span class="p">,</span> <span class="n">gis_rescor</span><span class="p">,</span> <span class="n">gis_resce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">gis_ts_annual</span><span class="p">,</span> <span class="s1">&#39;GISTEMPv4&#39;</span><span class="p">,</span> <span class="n">res_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k class-based&#39;</span><span class="p">)</span>
<span class="n">gis_res1</span><span class="p">,</span> <span class="n">gis_res1cor</span><span class="p">,</span> <span class="n">gis_res1ce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">gis_ts_annual</span><span class="p">,</span> <span class="s1">&#39;GISTEMPv4&#39;</span><span class="p">,</span> <span class="n">res1_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k meta season&#39;</span><span class="p">)</span>
<span class="n">gis_res2</span><span class="p">,</span> <span class="n">gis_res2cor</span><span class="p">,</span> <span class="n">gis_res2ce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">gis_ts_annual</span><span class="p">,</span> <span class="s1">&#39;GISTEMPv4&#39;</span><span class="p">,</span> <span class="n">res2_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k meta season w/ interp&#39;</span><span class="p">)</span>
<span class="n">gis_lmr</span><span class="p">,</span> <span class="n">gis_lmrcor</span><span class="p">,</span> <span class="n">gis_lmrce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">gis_ts_annual</span><span class="p">,</span> <span class="s1">&#39;GISTEMPv4&#39;</span><span class="p">,</span> <span class="n">lmr_ens</span><span class="p">,</span> <span class="s1">&#39;LMRv2.1&#39;</span><span class="p">)</span>

<span class="c1"># --- OPTIONAL PLOTTING ---</span>

<span class="c1"># fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(16, 12))</span>

<span class="c1"># gis_res.plot_qs(ax=ax1, ylim=[-0.8, 0.6], xlim=[1880,2000])</span>
<span class="c1"># ax1.set_title(&#39;PReSto2k w/ class-based seasonality&#39;)</span>

<span class="c1"># gis_res1.plot_qs(ax=ax2, ylim=[-0.8, 0.6],xlim=[1880,2000])</span>
<span class="c1"># ax2.set_title(&#39;PReSto2k w/ meta-seasonality&#39;)</span>

<span class="c1"># gis_res2.plot_qs(ax=ax3, ylim=[-0.8, 0.6], xlim=[1880,2000])</span>
<span class="c1"># ax3.set_title(&#39;PReSto2k w/ meta-seasonality w/ interp&#39;)</span>


<span class="c1"># plt.tight_layout()</span>
<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="hadcrut5">
<h4>HADCRUT5<a class="headerlink" href="#hadcrut5" title="Link to this heading">#</a></h4>
<p>Same process as before, but this time we use <a class="reference external" href="https://www.metoffice.gov.uk/hadobs/hadcrut5/">HadCRUT5</a>. LMRv2.1 used HADCRUT4 for their validations, but we are using the most updated dataset, since it exists. This time we load the dataset from the cloud, then convert the dataframe to a <code class="docutils literal notranslate"><span class="pre">cfr.EnsTS</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://www.metoffice.gov.uk/hadobs/hadcrut5/data/HadCRUT.5.0.2.0/analysis/diagnostics/HadCRUT.5.0.2.0.analysis.summary_series.global.annual.csv&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Time</th>
      <th>Anomaly (deg C)</th>
      <th>Lower confidence limit (2.5%)</th>
      <th>Upper confidence limit (97.5%)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1850</td>
      <td>-0.417711</td>
      <td>-0.589256</td>
      <td>-0.246166</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1851</td>
      <td>-0.233350</td>
      <td>-0.411868</td>
      <td>-0.054832</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1852</td>
      <td>-0.229399</td>
      <td>-0.409382</td>
      <td>-0.049416</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1853</td>
      <td>-0.270354</td>
      <td>-0.430009</td>
      <td>-0.110700</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1854</td>
      <td>-0.291521</td>
      <td>-0.432712</td>
      <td>-0.150330</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">had_ts_annual</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">EnsTS</span><span class="p">()</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">time_column</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">value_columns</span><span class="o">=</span><span class="s1">&#39;Anomaly (deg C)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">had_res</span><span class="p">,</span> <span class="n">had_rescor</span><span class="p">,</span> <span class="n">had_resce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">had_ts_annual</span><span class="p">,</span> <span class="s1">&#39;HADCRUT5&#39;</span><span class="p">,</span> <span class="n">res_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k class-based&#39;</span><span class="p">)</span>
<span class="n">had_res1</span><span class="p">,</span> <span class="n">had_res1cor</span><span class="p">,</span> <span class="n">had_res1ce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">had_ts_annual</span><span class="p">,</span> <span class="s1">&#39;HADCRUT5&#39;</span><span class="p">,</span> <span class="n">res1_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k meta season&#39;</span><span class="p">)</span>
<span class="n">had_res2</span><span class="p">,</span> <span class="n">had_res2cor</span><span class="p">,</span> <span class="n">had_res2ce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">had_ts_annual</span><span class="p">,</span> <span class="s1">&#39;HADCRUT5&#39;</span><span class="p">,</span> <span class="n">res2_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k meta season w/ interp&#39;</span><span class="p">)</span>
<span class="n">had_lmr</span><span class="p">,</span> <span class="n">had_lmrcor</span><span class="p">,</span> <span class="n">had_lmrce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">had_ts_annual</span><span class="p">,</span> <span class="s1">&#39;HADCRUT5&#39;</span><span class="p">,</span> <span class="n">lmr_ens</span><span class="p">,</span> <span class="s1">&#39;LMRv2.1&#39;</span><span class="p">)</span>

<span class="c1"># --- OPTIONAL PLOTTING ---</span>

<span class="c1"># fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(16, 12))</span>

<span class="c1"># had_res.plot_qs(ax=ax1, ylim=[-0.8, 0.6], xlim=[1880,2000])</span>
<span class="c1"># ax1.set_title(&#39;PReSto2k w/ class-based seasonality&#39;)</span>

<span class="c1"># had_res1.plot_qs(ax=ax2, ylim=[-0.8, 0.6],xlim=[1880,2000])</span>
<span class="c1"># ax2.set_title(&#39;PReSto2k w/ meta-seasonality&#39;)</span>

<span class="c1"># had_res2.plot_qs(ax=ax3, ylim=[-0.8, 0.6], xlim=[1880,2000])</span>
<span class="c1"># ax3.set_title(&#39;PReSto2k w/ meta-seasonality w/ interp&#39;)</span>

<span class="c1"># plt.tight_layout()</span>
<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="berkeley-earth-surface-temperature-best">
<h4>Berkeley Earth Surface Temperature (BEST)<a class="headerlink" href="#berkeley-earth-surface-temperature-best" title="Link to this heading">#</a></h4>
<p>Same process as before, but for <a class="reference external" href="https://berkeleyearth.org/data/">BEST</a>. We will also use BEST for our climate field validations later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;./analyses/BerkeleyEarth/Land_and_Ocean_LatLong1.nc&#39;</span><span class="p">)</span>
<span class="n">best</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:      (longitude: 360, latitude: 180, time: 1980, month_number: 12)
Coordinates:
  * longitude    (longitude) float32 -179.5 -178.5 -177.5 ... 177.5 178.5 179.5
  * latitude     (latitude) float32 -89.5 -88.5 -87.5 -86.5 ... 87.5 88.5 89.5
  * time         (time) float64 1.85e+03 1.85e+03 ... 2.015e+03 2.015e+03
Dimensions without coordinates: month_number
Data variables:
    land_mask    (latitude, longitude) float64 1.0 1.0 1.0 1.0 ... 0.0 0.0 0.0
    temperature  (time, latitude, longitude) float32 nan nan ... 0.4631 0.4641
    climatology  (month_number, latitude, longitude) float32 -28.21 ... -31.3
Attributes:
    Conventions:           Berkeley Earth Internal Convention (based on CF-1.5)
    title:                 Native Format Berkeley Earth Surface Temperature A...
    history:               17-Feb-2015 11:17:51
    institution:           Berkeley Earth Surface Temperature Project
    land_source_history:   16-Jan-2015 09:30:27
    ocean_source_history:  08-Jan-2015 06:07:03
    comment:               This file contains Berkeley Earth surface temperat...</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-7a8b7baa-2125-48c9-90d3-aeaa89fbc41e' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-7a8b7baa-2125-48c9-90d3-aeaa89fbc41e' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>longitude</span>: 360</li><li><span class='xr-has-index'>latitude</span>: 180</li><li><span class='xr-has-index'>time</span>: 1980</li><li><span>month_number</span>: 12</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-659309de-df84-47c4-8e4a-56d508495e31' class='xr-section-summary-in' type='checkbox'  checked><label for='section-659309de-df84-47c4-8e4a-56d508495e31' class='xr-section-summary' >Coordinates: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>longitude</span></div><div class='xr-var-dims'>(longitude)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>-179.5 -178.5 ... 178.5 179.5</div><input id='attrs-e57c10c4-27c0-4d63-9f24-d58e4f271332' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-e57c10c4-27c0-4d63-9f24-d58e4f271332' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-51270a5f-4a2d-4a5f-8d6e-7050329e9a40' class='xr-var-data-in' type='checkbox'><label for='data-51270a5f-4a2d-4a5f-8d6e-7050329e9a40' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>degrees_east</dd><dt><span>standard_name :</span></dt><dd>longitude</dd><dt><span>long_name :</span></dt><dd>Longitude</dd></dl></div><div class='xr-var-data'><pre>array([-179.5, -178.5, -177.5, ...,  177.5,  178.5,  179.5], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>latitude</span></div><div class='xr-var-dims'>(latitude)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>-89.5 -88.5 -87.5 ... 88.5 89.5</div><input id='attrs-81a4f687-dc1f-42ac-a319-c88090045206' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-81a4f687-dc1f-42ac-a319-c88090045206' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-564dd678-d964-4ecd-8fc2-24b9ec140dc4' class='xr-var-data-in' type='checkbox'><label for='data-564dd678-d964-4ecd-8fc2-24b9ec140dc4' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>degrees_north</dd><dt><span>standard_name :</span></dt><dd>latitude</dd><dt><span>long_name :</span></dt><dd>Latitude</dd></dl></div><div class='xr-var-data'><pre>array([-89.5, -88.5, -87.5, -86.5, -85.5, -84.5, -83.5, -82.5, -81.5, -80.5,
       -79.5, -78.5, -77.5, -76.5, -75.5, -74.5, -73.5, -72.5, -71.5, -70.5,
       -69.5, -68.5, -67.5, -66.5, -65.5, -64.5, -63.5, -62.5, -61.5, -60.5,
       -59.5, -58.5, -57.5, -56.5, -55.5, -54.5, -53.5, -52.5, -51.5, -50.5,
       -49.5, -48.5, -47.5, -46.5, -45.5, -44.5, -43.5, -42.5, -41.5, -40.5,
       -39.5, -38.5, -37.5, -36.5, -35.5, -34.5, -33.5, -32.5, -31.5, -30.5,
       -29.5, -28.5, -27.5, -26.5, -25.5, -24.5, -23.5, -22.5, -21.5, -20.5,
       -19.5, -18.5, -17.5, -16.5, -15.5, -14.5, -13.5, -12.5, -11.5, -10.5,
        -9.5,  -8.5,  -7.5,  -6.5,  -5.5,  -4.5,  -3.5,  -2.5,  -1.5,  -0.5,
         0.5,   1.5,   2.5,   3.5,   4.5,   5.5,   6.5,   7.5,   8.5,   9.5,
        10.5,  11.5,  12.5,  13.5,  14.5,  15.5,  16.5,  17.5,  18.5,  19.5,
        20.5,  21.5,  22.5,  23.5,  24.5,  25.5,  26.5,  27.5,  28.5,  29.5,
        30.5,  31.5,  32.5,  33.5,  34.5,  35.5,  36.5,  37.5,  38.5,  39.5,
        40.5,  41.5,  42.5,  43.5,  44.5,  45.5,  46.5,  47.5,  48.5,  49.5,
        50.5,  51.5,  52.5,  53.5,  54.5,  55.5,  56.5,  57.5,  58.5,  59.5,
        60.5,  61.5,  62.5,  63.5,  64.5,  65.5,  66.5,  67.5,  68.5,  69.5,
        70.5,  71.5,  72.5,  73.5,  74.5,  75.5,  76.5,  77.5,  78.5,  79.5,
        80.5,  81.5,  82.5,  83.5,  84.5,  85.5,  86.5,  87.5,  88.5,  89.5],
      dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>time</span></div><div class='xr-var-dims'>(time)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.85e+03 1.85e+03 ... 2.015e+03</div><input id='attrs-2812dd4c-8eef-4d3c-ad45-3d34629ec666' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-2812dd4c-8eef-4d3c-ad45-3d34629ec666' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-5aa17a6f-9223-4bf1-bb93-e40b92a7b468' class='xr-var-data-in' type='checkbox'><label for='data-5aa17a6f-9223-4bf1-bb93-e40b92a7b468' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>year A.D.</dd><dt><span>standard_name :</span></dt><dd>time</dd><dt><span>long_name :</span></dt><dd>Time</dd></dl></div><div class='xr-var-data'><pre>array([1850.041667, 1850.125   , 1850.208333, ..., 2014.791667, 2014.875   ,
       2014.958333])</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-28232728-7853-453c-9015-248f9c9af8c6' class='xr-section-summary-in' type='checkbox'  checked><label for='section-28232728-7853-453c-9015-248f9c9af8c6' class='xr-section-summary' >Data variables: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>land_mask</span></div><div class='xr-var-dims'>(latitude, longitude)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.0 1.0 1.0 1.0 ... 0.0 0.0 0.0 0.0</div><input id='attrs-090e17e5-0b4c-4493-a7d5-5818117b13c4' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-090e17e5-0b4c-4493-a7d5-5818117b13c4' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d60f7ebb-ec17-496b-a67c-a45319c4addd' class='xr-var-data-in' type='checkbox'><label for='data-d60f7ebb-ec17-496b-a67c-a45319c4addd' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>none</dd><dt><span>standard_name :</span></dt><dd>land_mask</dd><dt><span>long_name :</span></dt><dd>Land Mask</dd><dt><span>valid_min :</span></dt><dd>0.0</dd><dt><span>valid_max :</span></dt><dd>1.0</dd></dl></div><div class='xr-var-data'><pre>array([[1., 1., 1., ..., 1., 1., 1.],
       [1., 1., 1., ..., 1., 1., 1.],
       [1., 1., 1., ..., 1., 1., 1.],
       ...,
       [0., 0., 0., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.],
       [0., 0., 0., ..., 0., 0., 0.]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>temperature</span></div><div class='xr-var-dims'>(time, latitude, longitude)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>nan nan nan ... 0.4631 0.4641</div><input id='attrs-464298d3-c44e-4184-8506-0e86d7979373' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-464298d3-c44e-4184-8506-0e86d7979373' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-181db3e6-e835-444e-80c2-6cf1e2d32967' class='xr-var-data-in' type='checkbox'><label for='data-181db3e6-e835-444e-80c2-6cf1e2d32967' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>degree C</dd><dt><span>standard_name :</span></dt><dd>surface_temperature_anomaly</dd><dt><span>long_name :</span></dt><dd>Air Surface Temperature Anomaly</dd><dt><span>valid_min :</span></dt><dd>-17.481789826249717</dd><dt><span>valid_max :</span></dt><dd>23.132011428109774</dd></dl></div><div class='xr-var-data'><pre>array([[[        nan,         nan,         nan, ...,         nan,
                 nan,         nan],
        [        nan,         nan,         nan, ...,         nan,
                 nan,         nan],
        [        nan,         nan,         nan, ...,         nan,
                 nan,         nan],
        ...,
        [        nan,         nan,         nan, ...,         nan,
                 nan,         nan],
        [        nan,         nan,         nan, ...,         nan,
                 nan,         nan],
        [        nan,         nan,         nan, ...,         nan,
                 nan,         nan]],

       [[        nan,         nan,         nan, ...,         nan,
                 nan,         nan],
        [        nan,         nan,         nan, ...,         nan,
                 nan,         nan],
        [        nan,         nan,         nan, ...,         nan,
                 nan,         nan],
...
        [ 2.3392344 ,  2.3416731 ,  2.3426774 , ...,  2.3287082 ,
          2.331802  ,  2.3359811 ],
        [ 1.8885922 ,  1.8951684 ,  1.90155   , ...,  1.8655236 ,
          1.8740989 ,  1.8817985 ],
        [ 1.7705178 ,  1.7710365 ,  1.7715057 , ...,  1.7686385 ,
          1.7693107 ,  1.7699403 ]],

       [[ 0.03963067,  0.03888644,  0.03817474, ...,  0.0420571 ,
          0.04121615,  0.04040729],
        [-0.17415276, -0.17579378, -0.17733753, ..., -0.16864356,
         -0.17057788, -0.17241421],
        [-0.40269837, -0.4047508 , -0.40659848, ..., -0.39531836,
         -0.3979814 , -0.40044168],
        ...,
        [ 0.13773227,  0.13802898,  0.13384563, ...,  0.1468012 ,
          0.13957372,  0.13777146],
        [ 0.3981431 ,  0.40760106,  0.4171141 , ...,  0.36884215,
          0.3789063 ,  0.38869226],
        [ 0.4651999 ,  0.46628734,  0.46740958, ...,  0.46205625,
          0.46308073,  0.46413353]]], dtype=float32)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>climatology</span></div><div class='xr-var-dims'>(month_number, latitude, longitude)</div><div class='xr-var-dtype'>float32</div><div class='xr-var-preview xr-preview'>-28.21 -28.19 ... -31.3 -31.3</div><input id='attrs-866a3f2c-cc3d-4366-a251-56790e771c0e' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-866a3f2c-cc3d-4366-a251-56790e771c0e' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-a2c8e5a4-969e-4f12-b6cf-3edf82d9075b' class='xr-var-data-in' type='checkbox'><label for='data-a2c8e5a4-969e-4f12-b6cf-3edf82d9075b' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>units :</span></dt><dd>degree C</dd><dt><span>standard_name :</span></dt><dd>surface_temperature_climatology</dd><dt><span>long_name :</span></dt><dd>Air Surface Temperature Climatology (Jan 1951 - Dec 1980)</dd><dt><span>valid_min :</span></dt><dd>-67.54999096980748</dd><dt><span>valid_max :</span></dt><dd>38.80830696784267</dd></dl></div><div class='xr-var-data'><pre>array([[[-28.209646, -28.185844, -28.174889, ..., -28.23251 ,
         -28.22613 , -28.221445],
        [-30.286318, -30.316586, -30.36317 , ..., -30.223343,
         -30.248571, -30.267176],
        [-29.452799, -29.475773, -29.459503, ..., -29.466125,
         -29.473219, -29.453037],
        ...,
        [-33.14278 , -33.145897, -33.143448, ..., -33.144524,
         -33.145004, -33.141735],
        [-33.121456, -33.125107, -33.126717, ..., -33.128742,
         -33.126274, -33.121815],
        [-32.89023 , -32.893185, -32.8953  , ..., -32.894386,
         -32.892643, -32.89005 ]],

       [[-39.710506, -39.688927, -39.669518, ..., -39.776382,
         -39.75364 , -39.73247 ],
        [-40.93353 , -40.929295, -40.92758 , ..., -40.96677 ,
         -40.952946, -40.941998],
        [-39.301563, -39.248436, -39.15887 , ..., -39.41471 ,
         -39.384766, -39.344532],
...
        [-27.184605, -27.178143, -27.169827, ..., -27.211687,
         -27.201843, -27.192568],
        [-27.360273, -27.360073, -27.358185, ..., -27.373487,
         -27.369814, -27.36375 ],
        [-27.443104, -27.444664, -27.445543, ..., -27.44913 ,
         -27.446812, -27.443819]],

       [[-26.484667, -26.470825, -26.467033, ..., -26.533966,
         -26.51201 , -26.498785],
        [-28.621096, -28.65584 , -28.706444, ..., -28.627426,
         -28.609625, -28.60677 ],
        [-27.791721, -27.819614, -27.806576, ..., -27.87309 ,
         -27.842934, -27.79772 ],
        ...,
        [-31.610525, -31.60416 , -31.592031, ..., -31.648186,
         -31.63588 , -31.620626],
        [-31.556198, -31.555943, -31.55281 , ..., -31.580727,
         -31.572956, -31.561981],
        [-31.294294, -31.296576, -31.2977  , ..., -31.305628,
         -31.301338, -31.295885]]], dtype=float32)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-5e0a6a30-d866-474a-8c68-83774ffbdc8a' class='xr-section-summary-in' type='checkbox'  ><label for='section-5e0a6a30-d866-474a-8c68-83774ffbdc8a' class='xr-section-summary' >Indexes: <span>(3)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>longitude</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-da4f4ce0-78d5-45e6-bc88-9105bc3a85b9' class='xr-index-data-in' type='checkbox'/><label for='index-da4f4ce0-78d5-45e6-bc88-9105bc3a85b9' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([-179.5, -178.5, -177.5, -176.5, -175.5, -174.5, -173.5, -172.5,
              -171.5, -170.5,
              ...
               170.5,  171.5,  172.5,  173.5,  174.5,  175.5,  176.5,  177.5,
               178.5,  179.5],
             dtype=&#x27;float64&#x27;, name=&#x27;longitude&#x27;, length=360))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>latitude</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-0dd4ea00-6fc1-4919-bc75-4c8df8c22374' class='xr-index-data-in' type='checkbox'/><label for='index-0dd4ea00-6fc1-4919-bc75-4c8df8c22374' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([-89.5, -88.5, -87.5, -86.5, -85.5, -84.5, -83.5, -82.5, -81.5,
              -80.5,
              ...
               80.5,  81.5,  82.5,  83.5,  84.5,  85.5,  86.5,  87.5,  88.5,
               89.5],
             dtype=&#x27;float64&#x27;, name=&#x27;latitude&#x27;, length=180))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>time</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-f55357bc-5ab7-40ba-92ab-fe60b70fd703' class='xr-index-data-in' type='checkbox'/><label for='index-f55357bc-5ab7-40ba-92ab-fe60b70fd703' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Float64Index([1850.0416666666667,           1850.125, 1850.2083333333333,
              1850.2916666666667,           1850.375, 1850.4583333333333,
              1850.5416666666667,           1850.625, 1850.7083333333333,
              1850.7916666666667,
              ...
              2014.2083333333333, 2014.2916666666665,           2014.375,
              2014.4583333333333, 2014.5416666666665,           2014.625,
              2014.7083333333333, 2014.7916666666665,           2014.875,
              2014.9583333333333],
             dtype=&#x27;float64&#x27;, name=&#x27;time&#x27;, length=1980))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-226bb2db-cba7-42f2-9fbb-7046628ecdcd' class='xr-section-summary-in' type='checkbox'  checked><label for='section-226bb2db-cba7-42f2-9fbb-7046628ecdcd' class='xr-section-summary' >Attributes: <span>(7)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'><dt><span>Conventions :</span></dt><dd>Berkeley Earth Internal Convention (based on CF-1.5)</dd><dt><span>title :</span></dt><dd>Native Format Berkeley Earth Surface Temperature Anomaly Field</dd><dt><span>history :</span></dt><dd>17-Feb-2015 11:17:51</dd><dt><span>institution :</span></dt><dd>Berkeley Earth Surface Temperature Project</dd><dt><span>land_source_history :</span></dt><dd>16-Jan-2015 09:30:27</dd><dt><span>ocean_source_history :</span></dt><dd>08-Jan-2015 06:07:03</dd><dt><span>comment :</span></dt><dd>This file contains Berkeley Earth surface temperature anomaly field in our native equal-area format.</dd></dl></div></li></ul></div></div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define weights (area ∝ cos(lat))</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">best</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]))</span>

<span class="c1"># Area-weighted global mean</span>
<span class="n">gm</span> <span class="o">=</span> <span class="n">best</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">weighted</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">])</span>

<span class="c1"># Convert time coordinate to datetime index (specific to BEST)</span>
<span class="n">time_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;1850-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">best</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
<span class="n">gm</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time_index</span><span class="p">)</span>

<span class="n">best_annual</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Reshape values if needed</span>
<span class="n">best_values</span> <span class="o">=</span> <span class="n">best_annual</span><span class="o">.</span><span class="n">values</span>
<span class="k">if</span> <span class="n">best_values</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">best_values</span> <span class="o">=</span> <span class="n">best_values</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

<span class="c1"># annualize</span>
<span class="n">best_ts_annual</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">EnsTS</span><span class="p">(</span>
    <span class="n">time</span><span class="o">=</span><span class="n">best_annual</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="n">best_values</span><span class="p">,</span>
    <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Temperature Anomaly&#39;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_res</span><span class="p">,</span> <span class="n">best_rescor</span><span class="p">,</span> <span class="n">best_resce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">best_ts_annual</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">res_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k class-based&#39;</span><span class="p">)</span>
<span class="n">best_res1</span><span class="p">,</span> <span class="n">best_res1cor</span><span class="p">,</span> <span class="n">best_res1ce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">best_ts_annual</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">res1_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k meta season&#39;</span><span class="p">)</span>
<span class="n">best_res2</span><span class="p">,</span> <span class="n">best_res2cor</span><span class="p">,</span> <span class="n">best_res2ce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">best_ts_annual</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">res2_ts</span><span class="p">,</span> <span class="s1">&#39;PReSto2k meta season w/ interp&#39;</span><span class="p">)</span>
<span class="n">best_lmr</span><span class="p">,</span> <span class="n">best_lmrcor</span><span class="p">,</span> <span class="n">best_lmrce</span> <span class="o">=</span> <span class="n">plot_ensts_compare</span><span class="p">(</span><span class="n">best_ts_annual</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">lmr_ens</span><span class="p">,</span> <span class="s1">&#39;LMRv2.1&#39;</span><span class="p">)</span>

<span class="c1"># --- OPTIONAL PLOTTING ---</span>

<span class="c1"># fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(16, 12))</span>

<span class="c1"># best_res.plot_qs(ax=ax1, ylim=[-0.8, 0.6], xlim=[1880,2000])</span>
<span class="c1"># ax1.set_title(&#39;PReSto2k w/ class-based seasonality&#39;)</span>

<span class="c1"># best_res1.plot_qs(ax=ax2, ylim=[-0.8, 0.6],xlim=[1880,2000])</span>
<span class="c1"># ax2.set_title(&#39;PReSto2k w/ meta-seasonality&#39;)</span>

<span class="c1"># best_res2.plot_qs(ax=ax3, ylim=[-0.8, 0.6], xlim=[1880,2000])</span>
<span class="c1"># ax3.set_title(&#39;PReSto2k w/ meta-seasonality w/ interp&#39;)</span>

<span class="c1"># plt.tight_layout()</span>
<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="consensus">
<h4>Consensus<a class="headerlink" href="#consensus" title="Link to this heading">#</a></h4>
<p>In addition to the individual validation analyses, we can now plot them all together along with a ‘consensus’ time series, which is the mean of all the instrumental datasets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># combine all datasets to calculate mean (class based)</span>
<span class="n">all_refs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
   <span class="n">had_res</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">],</span>
   <span class="n">gis_res</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">],</span>
   <span class="n">best_res</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">]</span>
<span class="p">])</span>
<span class="n">mean_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_refs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">mean_ts_annual</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">EnsTS</span><span class="p">(</span>
    <span class="n">time</span><span class="o">=</span><span class="n">best_annual</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="o">-</span><span class="mi">14</span><span class="p">],</span> <span class="c1">#manually slice dates</span>
    <span class="n">value</span><span class="o">=</span><span class="n">mean_ref</span><span class="p">,</span>
    <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Temperature Anomaly&#39;</span>
<span class="p">)</span>

<span class="n">mean_ts_compared</span> <span class="o">=</span> <span class="n">res_ts</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="n">mean_ts_annual</span><span class="p">,</span>
    <span class="n">ref_name</span><span class="o">=</span><span class="s1">&#39;Consensus&#39;</span><span class="p">,</span>
    <span class="n">timespan</span><span class="o">=</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># combine all datasets to calculate mean (no interp)</span>
<span class="n">all_refs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
   <span class="n">had_res1</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">],</span>
   <span class="n">gis_res1</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">],</span>
   <span class="n">best_res1</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">]</span>
<span class="p">])</span>
<span class="n">mean_ref1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_refs1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">mean_ts1_annual</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">EnsTS</span><span class="p">(</span>
    <span class="n">time</span><span class="o">=</span><span class="n">best_annual</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="o">-</span><span class="mi">14</span><span class="p">],</span> <span class="c1">#manually slice dates</span>
    <span class="n">value</span><span class="o">=</span><span class="n">mean_ref1</span><span class="p">,</span>
    <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Temperature Anomaly&#39;</span>
<span class="p">)</span>

<span class="n">mean_ts1_compared</span> <span class="o">=</span> <span class="n">res1_ts</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="n">mean_ts1_annual</span><span class="p">,</span>
    <span class="n">ref_name</span><span class="o">=</span><span class="s1">&#39;Consensus&#39;</span><span class="p">,</span>
    <span class="n">timespan</span><span class="o">=</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># combine all datasets to calculate mean (with interp)</span>
<span class="n">all_refs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
   <span class="n">had_res2</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">],</span>
   <span class="n">gis_res2</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">],</span>
   <span class="n">best_res2</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">]</span>
<span class="p">])</span>
<span class="n">mean_ref2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_refs2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">mean_ts2_annual</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">EnsTS</span><span class="p">(</span>
    <span class="n">time</span><span class="o">=</span><span class="n">best_annual</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="o">-</span><span class="mi">14</span><span class="p">],</span> <span class="c1">#manually slice dates</span>
    <span class="n">value</span><span class="o">=</span><span class="n">mean_ref2</span><span class="p">,</span>
    <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Temperature Anomaly&#39;</span>
<span class="p">)</span>

<span class="n">mean_ts2_compared</span> <span class="o">=</span> <span class="n">res2_ts</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="n">mean_ts2_annual</span><span class="p">,</span>
    <span class="n">ref_name</span><span class="o">=</span><span class="s1">&#39;Consensus&#39;</span><span class="p">,</span>
    <span class="n">timespan</span><span class="o">=</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># combine all datasets to calculate mean (LMR)</span>
<span class="n">all_refsl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
   <span class="n">had_lmr</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">],</span>
   <span class="n">gis_lmr</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">],</span>
   <span class="n">best_lmr</span><span class="o">.</span><span class="n">ref_value</span><span class="p">[:</span><span class="mi">121</span><span class="p">]</span>
<span class="p">])</span>
<span class="n">mean_refl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_refsl</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">mean_tsl_annual</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">EnsTS</span><span class="p">(</span>
    <span class="n">time</span><span class="o">=</span><span class="n">best_annual</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="o">-</span><span class="mi">14</span><span class="p">],</span> <span class="c1">#manually slice dates</span>
    <span class="n">value</span><span class="o">=</span><span class="n">mean_refl</span><span class="p">,</span>
    <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Temperature Anomaly&#39;</span>
<span class="p">)</span>

<span class="n">mean_tsl_compared</span> <span class="o">=</span> <span class="n">lmr_ens</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
    <span class="n">mean_tsl_annual</span><span class="p">,</span>
    <span class="n">ref_name</span><span class="o">=</span><span class="s1">&#39;Consensus&#39;</span><span class="p">,</span>
    <span class="n">timespan</span><span class="o">=</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- OPTIONAL CONSENSUS PLOT ---</span>

<span class="c1"># fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(16, 12))</span>

<span class="c1"># mean_ts_compared.plot_qs(ax=ax1, ylim=[-0.8, 0.6], xlim=[1880,2000])</span>
<span class="c1"># ax1.set_title(&#39;PReSto2k w/ class-based seasonality&#39;)</span>

<span class="c1"># mean_ts1_compared.plot_qs(ax=ax2, ylim=[-0.8, 0.6],xlim=[1880,2000])</span>
<span class="c1"># ax2.set_title(&#39;PReSto2k w/ meta-seasonality&#39;)</span>

<span class="c1"># mean_ts2_compared.plot_qs(ax=ax3, ylim=[-0.8, 0.6], xlim=[1880,2000])</span>
<span class="c1"># ax3.set_title(&#39;PReSto2k w/ meta-seasonality w/ interp&#39;)</span>

<span class="c1"># plt.tight_layout()</span>
<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_table_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;HadCRUT5&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">had_rescor</span><span class="p">,</span> <span class="n">had_res1cor</span><span class="p">,</span> <span class="n">had_res2cor</span><span class="p">,</span> <span class="n">had_lmrcor</span><span class="p">,</span>
                 <span class="n">had_resce</span><span class="p">,</span> <span class="n">had_res1ce</span><span class="p">,</span> <span class="n">had_res2ce</span><span class="p">,</span> <span class="n">had_lmrce</span><span class="p">],</span>
    <span class="s1">&#39;GISTEMP&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">gis_rescor</span><span class="p">,</span> <span class="n">gis_res1cor</span><span class="p">,</span> <span class="n">gis_res2cor</span><span class="p">,</span> <span class="n">gis_lmrcor</span><span class="p">,</span>
                <span class="n">gis_resce</span><span class="p">,</span> <span class="n">gis_res1ce</span><span class="p">,</span> <span class="n">gis_res2ce</span><span class="p">,</span> <span class="n">gis_lmrce</span><span class="p">],</span>
    <span class="s1">&#39;Berkeley Earth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">best_rescor</span><span class="p">,</span> <span class="n">best_res1cor</span><span class="p">,</span> <span class="n">best_res2cor</span><span class="p">,</span> <span class="n">best_lmrcor</span><span class="p">,</span>
                       <span class="n">best_resce</span><span class="p">,</span> <span class="n">best_res1ce</span><span class="p">,</span> <span class="n">best_res2ce</span><span class="p">,</span> <span class="n">best_lmrce</span><span class="p">],</span>
    <span class="s1">&#39;Consensus&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">mean_ts_compared</span><span class="o">.</span><span class="n">valid_stats</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">],</span> <span class="n">mean_ts1_compared</span><span class="o">.</span><span class="n">valid_stats</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">],</span> <span class="n">mean_ts2_compared</span><span class="o">.</span><span class="n">valid_stats</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">],</span> <span class="n">mean_tsl_compared</span><span class="o">.</span><span class="n">valid_stats</span><span class="p">[</span><span class="s1">&#39;corr&#39;</span><span class="p">],</span>
                  <span class="n">mean_ts_compared</span><span class="o">.</span><span class="n">valid_stats</span><span class="p">[</span><span class="s1">&#39;CE&#39;</span><span class="p">],</span> <span class="n">mean_ts1_compared</span><span class="o">.</span><span class="n">valid_stats</span><span class="p">[</span><span class="s1">&#39;CE&#39;</span><span class="p">],</span> <span class="n">mean_ts2_compared</span><span class="o">.</span><span class="n">valid_stats</span><span class="p">[</span><span class="s1">&#39;CE&#39;</span><span class="p">],</span> <span class="n">mean_tsl_compared</span><span class="o">.</span><span class="n">valid_stats</span><span class="p">[</span><span class="s1">&#39;CE&#39;</span><span class="p">]]</span>
<span class="p">}</span>

<span class="c1"># Create multi-level index</span>
<span class="n">index_tuples</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;PReSto2k class-based&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;PReSto2k meta season&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">),</span> 
    <span class="p">(</span><span class="s1">&#39;PReSto2k meta season w/ interp&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;LMRv2.1&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;PReSto2k class-based&#39;</span><span class="p">,</span> <span class="s1">&#39;CE&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;PReSto2k meta season&#39;</span><span class="p">,</span> <span class="s1">&#39;CE&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;PReSto2k meta season w/ interp&#39;</span><span class="p">,</span> <span class="s1">&#39;CE&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;LMRv2.1&#39;</span><span class="p">,</span> <span class="s1">&#39;CE&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">multi_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">index_tuples</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Reconstruction&#39;</span><span class="p">,</span> <span class="s1">&#39;Metric&#39;</span><span class="p">])</span>

<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results_table_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">multi_index</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;COMPLETE RESULTS TABLE:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>COMPLETE RESULTS TABLE:
============================================================
                                       HadCRUT5  GISTEMP  Berkeley Earth  \
Reconstruction                 Metric                                      
PReSto2k class-based           R          0.928    0.919           0.917   
PReSto2k meta season           R          0.874    0.874           0.857   
PReSto2k meta season w/ interp R          0.891    0.889           0.877   
LMRv2.1                        R          0.933    0.932           0.921   
PReSto2k class-based           CE         0.608    0.827           0.744   
PReSto2k meta season           CE         0.612    0.765           0.698   
PReSto2k meta season w/ interp CE         0.659    0.787           0.739   
LMRv2.1                        CE         0.565    0.834           0.719   

                                       Consensus  
Reconstruction                 Metric             
PReSto2k class-based           R           0.927  
PReSto2k meta season           R           0.874  
PReSto2k meta season w/ interp R           0.891  
LMRv2.1                        R           0.934  
PReSto2k class-based           CE          0.757  
PReSto2k meta season           CE          0.724  
PReSto2k meta season w/ interp CE          0.762  
LMRv2.1                        CE          0.735  
</pre></div>
</div>
</div>
</div>
</section>
<section id="takeaways-from-the-results-table">
<h4>Takeaways from the Results Table<a class="headerlink" href="#takeaways-from-the-results-table" title="Link to this heading">#</a></h4>
<p><strong>Correlations (R)</strong></p>
<ul class="simple">
<li><p>LMRv2.1 is still the strongest overall, clearly better than all PReSto2k variants.</p></li>
<li><p>PReSto2k class-based comes very close to LMR (~ within 0.01–0.02 in most cases).</p></li>
<li><p>PReSto2k meta-seasonality lags somewhat, while meta w/ interpolation is marginally better.</p></li>
</ul>
<p><strong>Coefficient of Efficiency (CE)</strong></p>
<ul class="simple">
<li><p>PReSto2k class-based outperform LMRv2.1 in all cases.</p></li>
<li><p>Meta seasonality is weakest, but interpolation boosts it, and ends up being the best in terms of the consensus.</p></li>
<li><p>LMRv2.1 is middle of the road, but usually a bit lower than PReSto2k class-based or interpolated meta-based.</p></li>
</ul>
<p><strong>Overall</strong></p>
<ul class="simple">
<li><p>LMRv2.1 remains the standard in terms of correlation with observational data.</p></li>
<li><p>PReSto2k class-based nearly matches LMR’s correlations while showing better CE scores, which could imply improved predictive skill.</p></li>
<li><p>Meta seasonality with interpolation can match or exceed class-based in CE, but both meta-based reconstructions are still worse in correlation.</p></li>
</ul>
<p>So, PReSto2k reconstructions can safely rival (and sometimes surpass) LMRv2.1 in skill, depending on the metric, especially when class-based or meta-seasonality with interpolation are used.</p>
<blockquote>
<div><p>NOTE: These instrumental validations are only done from 1880-2000, which means its still missing a very large portion of the picture. Namely 1-1880, which misses the medieval climate anomaly, Little Ice Age, and many large volcanic events. There are also probably biases in validation due to the more recent proxy/instrumental overlaps, where data quality and density is higher.</p>
</div></blockquote>
</section>
</section>
<section id="validation-on-climate-fields">
<h3>Validation on Climate Fields<a class="headerlink" href="#validation-on-climate-fields" title="Link to this heading">#</a></h3>
<p>Load in both BEST climate field and the original LMR air (2m air temperature) climate field as <code class="docutils literal notranslate"><span class="pre">cfr.ClimateField</span></code> objects and modify the format so that we can more easily compare it with our validation datasets using <em>cfr</em>. In this step, we will plot both the correlation (corr) and the coefficient of efficiency (CE) of 2m air temperature against the Berkeley Earth Surface Temperature (BEST) climate field, since that was what Tardif et al. (2019) used to validate their field reconstructions.</p>
<section id="best">
<h4>BEST<a class="headerlink" href="#best" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;./analyses/BerkeleyEarth/Land_and_Ocean_LatLong1.nc&#39;</span><span class="p">)</span>

<span class="c1"># Convert decimal years to datetime</span>
<span class="n">years</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="nb">int</span><span class="p">((</span><span class="n">year</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">-15&quot;</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">])</span>

<span class="c1"># Create a new DataArray with proper coordinates</span>
<span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">temperature</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
        <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="n">ds</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span>
    <span class="p">},</span>
    <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;temperature&#39;</span>
<span class="p">)</span>

<span class="c1"># 3. create ClimateField object</span>
<span class="n">target_be</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ClimateField</span><span class="p">(</span><span class="n">da</span><span class="p">)</span><span class="o">.</span><span class="n">get_anom</span><span class="p">(</span><span class="n">ref_period</span><span class="o">=</span><span class="p">[</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1980</span><span class="p">])</span>
<span class="n">target_be</span> <span class="o">=</span> <span class="n">target_be</span><span class="o">.</span><span class="n">annualize</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">target_be</span><span class="o">.</span><span class="n">da</span>

<span class="c1"># Convert target data to 0-360 format first</span>
<span class="n">target_wrapped</span> <span class="o">=</span> <span class="n">target_be</span><span class="o">.</span><span class="n">wrap_lon</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;360&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lmr_tas</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ClimateField</span><span class="p">()</span><span class="o">.</span><span class="n">load_nc</span><span class="p">(</span>
    <span class="n">path</span><span class="o">=</span><span class="s1">&#39;./prev_data/air_MCruns_ensemble_mean_LMRv2.1.nc&#39;</span><span class="p">,</span>
    <span class="n">vn</span><span class="o">=</span><span class="s1">&#39;air&#39;</span><span class="p">,</span> 
    <span class="n">time_name</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>  
    <span class="n">lat_name</span><span class="o">=</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> 
    <span class="n">lon_name</span><span class="o">=</span><span class="s1">&#39;lon&#39;</span>
<span class="p">)</span>

<span class="n">target_lmr</span> <span class="o">=</span> <span class="n">lmr_tas</span><span class="o">.</span><span class="n">get_anom</span><span class="p">(</span><span class="n">ref_period</span><span class="o">=</span><span class="p">[</span><span class="mi">1951</span><span class="p">,</span> <span class="mi">1980</span><span class="p">])</span>
<span class="n">filtered_da</span> <span class="o">=</span> <span class="n">target_lmr</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">target_lmr</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">target_lmr</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ClimateField</span><span class="p">(</span><span class="n">da</span><span class="o">=</span><span class="n">filtered_da</span><span class="p">)</span>
<span class="n">target_lmr</span> <span class="o">=</span> <span class="n">target_lmr</span><span class="o">.</span><span class="n">annualize</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="n">target_lmr_mean</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ClimateField</span><span class="p">(</span><span class="n">da</span><span class="o">=</span><span class="n">target_lmr</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;MCrun&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function to get the comparison statistics from a climate field compare </span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_cf_stat</span><span class="p">(</span><span class="n">target_cf</span><span class="p">,</span> <span class="n">target_name</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">cf_name</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">valid_fdb</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span>
        <span class="n">target_cf</span><span class="p">,</span>
        <span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">,</span>
        <span class="n">timespan</span><span class="o">=</span><span class="p">(</span><span class="mi">1880</span><span class="p">,</span> <span class="mi">2000</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">valid_fdb</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lmrvbest</span> <span class="o">=</span> <span class="n">get_cf_stat</span><span class="p">(</span><span class="n">target_wrapped</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">target_lmr_mean</span><span class="p">,</span> <span class="s1">&#39;LMRv2.1&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;corr&#39;</span><span class="p">)</span>
<span class="n">p2kclassvbest</span> <span class="o">=</span> <span class="n">get_cf_stat</span><span class="p">(</span><span class="n">target_wrapped</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">recons</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">],</span> <span class="s1">&#39;PReSto2k class based&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;corr&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">p2kclassvbest</span> <span class="o">-</span> <span class="n">lmrvbest</span>

<span class="c1"># compute symmetric color scale</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">clim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>

<span class="n">diff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;PReSto2k class - LMRv2.1 (v. BEST) corr(recon, obs), mean=</span><span class="si">{</span><span class="n">diff</span><span class="o">.</span><span class="n">geo_mean</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">plot_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
    <span class="n">clim</span><span class="o">=</span><span class="n">clim</span>   <span class="c1"># enforce centered colormap</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/69f02ae5448ff4a4ad90372994221e3161caee566264b07c1b275ac742d4f252.png" src="../../_images/69f02ae5448ff4a4ad90372994221e3161caee566264b07c1b275ac742d4f252.png" />
</div>
</div>
<blockquote>
<div><p>KEY: Red – target better than LMRv2.1, Blue – LMRv2.1 better than target</p>
</div></blockquote>
<p>Here we see that the correlation between LMRv2.1 v Best and PReSto2k v BEST averages out at about 0.0. The stark difference here is that it appears PReSto2k class-based performs much better over Scandinavia and slightly worse in Antarctica.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p2kclassvbest</span> <span class="o">=</span> <span class="n">get_cf_stat</span><span class="p">(</span><span class="n">target_wrapped</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">recons</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">],</span> <span class="s1">&#39;PReSto2k class based&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;corr&#39;</span><span class="p">)</span>
<span class="n">p2kmetaintvbest</span> <span class="o">=</span> <span class="n">get_cf_stat</span><span class="p">(</span><span class="n">target_wrapped</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">res2</span><span class="o">.</span><span class="n">recons</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">],</span> <span class="s1">&#39;PReSto2k meta-season w/ interp&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;corr&#39;</span><span class="p">)</span>

<span class="n">diff2</span> <span class="o">=</span> <span class="n">p2kmetaintvbest</span> <span class="o">-</span> <span class="n">p2kclassvbest</span> 

<span class="c1"># compute symmetric color scale</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff2</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">clim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>

<span class="n">diff2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;PReSto2k meta - class (v. BEST) corr(recon, obs), mean=</span><span class="si">{</span><span class="n">diff</span><span class="o">.</span><span class="n">geo_mean</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">plot_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
    <span class="n">clim</span><span class="o">=</span><span class="n">clim</span>   <span class="c1"># enforce centered colormap</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2f84702f55a9db914bc2e37e6e30be3c83f3fb1f2607166da124922174ac2c08.png" src="../../_images/2f84702f55a9db914bc2e37e6e30be3c83f3fb1f2607166da124922174ac2c08.png" />
</div>
</div>
<blockquote>
<div><p>KEY: Red – target better than LMRv2.1, Blue – LMRv2.1 better than target</p>
</div></blockquote>
<p>While global average skill is similar, class-based seasonality outperforms meta-based across much of the Indian, Pacific and Southern Hemisphere oceans, whereas meta shows slight advantages in regions like the North Atlantic, Pacific Cold Tongue, and Antarctica. Overall  this analysis suggests that little is gained by using expert seasonality, as far as PReSto2k reconstructions go.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lmrvbest</span> <span class="o">=</span> <span class="n">get_cf_stat</span><span class="p">(</span><span class="n">target_wrapped</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">target_lmr_mean</span><span class="p">,</span> <span class="s1">&#39;LMRv2.1&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;CE&#39;</span><span class="p">)</span>
<span class="n">p2kclassvbest</span> <span class="o">=</span> <span class="n">get_cf_stat</span><span class="p">(</span><span class="n">target_wrapped</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">recons</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">],</span> <span class="s1">&#39;PReSto2k class based&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;CE&#39;</span><span class="p">)</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">p2kclassvbest</span> <span class="o">-</span> <span class="n">lmrvbest</span> 

<span class="c1"># compute symmetric color scale</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
<span class="n">clim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>

<span class="n">diff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;PReSto2k class - LMRv2.1 (v. BEST) CE(recon, obs), mean=</span><span class="si">{</span><span class="n">diff</span><span class="o">.</span><span class="n">geo_mean</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">plot_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
    <span class="n">clim</span><span class="o">=</span><span class="n">clim</span>   <span class="c1"># enforce centered colormap</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/98f8e6cbca13d7b2613ff8ac3eb1606714dc8c85ed6cfb8a54a89bdbcb50954f.png" src="../../_images/98f8e6cbca13d7b2613ff8ac3eb1606714dc8c85ed6cfb8a54a89bdbcb50954f.png" />
</div>
</div>
<blockquote>
<div><p>KEY: Red – target better than LMRv2.1, Blue – LMRv2.1 better than target</p>
</div></blockquote>
<p>Aside from masked-out gray regions (an upcoming fix), PReSto2k class-based and LMRv2.1 have nearly identical CE skill overall, with  minor regional differences (class-based doing slightly better over Scandinavia, while LMR has very small advantages in scattered locations along the North Atlantic and Austrialia).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p2kclassvbest</span> <span class="o">=</span> <span class="n">get_cf_stat</span><span class="p">(</span><span class="n">target_wrapped</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">recons</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">],</span> <span class="s1">&#39;PReSto2k class based&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;CE&#39;</span><span class="p">)</span>
<span class="n">p2kmetaintvbest</span> <span class="o">=</span> <span class="n">get_cf_stat</span><span class="p">(</span><span class="n">target_wrapped</span><span class="p">,</span> <span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="n">res2</span><span class="o">.</span><span class="n">recons</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">],</span> <span class="s1">&#39;PReSto2k meta-season w/ interp&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;CE&#39;</span><span class="p">)</span>

<span class="n">diff2</span> <span class="o">=</span>  <span class="n">p2kmetaintvbest</span> <span class="o">-</span> <span class="n">p2kclassvbest</span>

<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff2</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="mi">98</span><span class="p">)</span>
<span class="n">clim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>

<span class="c1"># clip just for plotting</span>
<span class="n">vals</span> <span class="o">=</span> <span class="n">diff2</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="o">-</span><span class="n">vmax</span><span class="p">,</span> <span class="n">vmax</span><span class="p">)</span>

<span class="n">diff2_clipped</span> <span class="o">=</span> <span class="n">diff2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">diff2_clipped</span><span class="o">.</span><span class="n">da</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">vals</span>

<span class="n">diff2_clipped</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;PReSto2k meta - class (v. BEST) CE(recon, obs), mean=</span><span class="si">{</span><span class="n">diff2</span><span class="o">.</span><span class="n">geo_mean</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">plot_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">,</span>
    <span class="n">clim</span><span class="o">=</span><span class="n">clim</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b802f097c2ff5739d59658b937120986bdea955c86ad6beb07f7c7d3bac83a32.png" src="../../_images/b802f097c2ff5739d59658b937120986bdea955c86ad6beb07f7c7d3bac83a32.png" />
</div>
</div>
<blockquote>
<div><p>KEY: Red – target better than LMRv2.1, Blue – LMRv2.1 better than target</p>
</div></blockquote>
<p>It is apparent for this one that class-based seasonality performs significantly better over southeast asia and parts of the North Atlantic (Caribbean region). Everywhere else is pretty even in terms of skill.</p>
</section>
</section>
</section>
<section id="psm-calibration-statistics">
<h2>PSM Calibration Statistics<a class="headerlink" href="#psm-calibration-statistics" title="Link to this heading">#</a></h2>
<p>One way to understand these results is to examine the calibration scores of the proxy system models (PSMs). Here we compare two seasonality approaches used by our PReSto2k reconstructions:</p>
<ul class="simple">
<li><p>Class-based: seasonalities are broadly defined for each proxy class.</p></li>
<li><p>Metadata-based: each proxy record uses an expert-designated seasonality defined in its metadata.</p></li>
</ul>
<p>These choices directly affect how the PSMs are calibrated within the data assimilation workflow (see: <em>Run Data Assimilation with Individual Seasonality</em>).</p>
<p>A well-calibrated proxy record is characterized by its PSM successfully explaining a significant portion of observed climate variability during the calibration period, typically reflected in a strong fit metric like R^2. This aligns with how PSMs are used in paleoclimate DA, where calibration makes sure that the proxy accurately reflects the climate signal and drives confidence in reconstruction results.</p>
<p>In this section, we compile calibration statistics and examine the spatial distribution of records with high R^2 values. This provides insight into the regional skill of the climate field reconstruction, beyond what we can infer from just GMST and instrumental validation.</p>
<section id="load-proxy-databases">
<h3>Load Proxy Databases<a class="headerlink" href="#load-proxy-databases" title="Link to this heading">#</a></h3>
<p>These proxy databases should have the post-calibration statsistics saved in their metadata for easier validation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./prev_data/calibrated/calibrated_lipd_pdb.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pdb_class_new</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">job_class_new</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ReconJob</span><span class="p">()</span>
<span class="n">job_class_new</span><span class="o">.</span><span class="n">proxydb</span> <span class="o">=</span> <span class="n">pdb_class_new</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./prev_data/calibrated/calibrated_pdb_w_seasonality_annual.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pdb_meta</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">job_meta</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ReconJob</span><span class="p">()</span>
<span class="n">job_meta</span><span class="o">.</span><span class="n">proxydb</span> <span class="o">=</span> <span class="n">pdb_meta</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./prev_data/calibrated/calibrated_pdb_w_seasonality_annual_interp.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pdb_meta_interp</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">job_meta_interp</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ReconJob</span><span class="p">()</span>
<span class="n">job_meta_interp</span><span class="o">.</span><span class="n">proxydb</span> <span class="o">=</span> <span class="n">pdb_meta_interp</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract calibration statistics from all three databases</span>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_calib_stats</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">approach_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract PSM calibration statistics from a ReconJob&quot;&quot;&quot;</span>
    <span class="n">calib_stats</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collecting PSM calibration statistics for </span><span class="si">{</span><span class="n">approach_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">proxydb</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s1">&#39;psm&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">psm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> 
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">psm</span><span class="p">,</span> <span class="s1">&#39;calib_details&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">psm</span><span class="o">.</span><span class="n">calib_details</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            
            <span class="n">details</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">psm</span><span class="o">.</span><span class="n">calib_details</span>
            <span class="n">calib_stats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">pid</span><span class="p">,</span>
                <span class="s1">&#39;r2_adj&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;fitR2adj&#39;</span><span class="p">],</span>
                <span class="s1">&#39;nobs&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;nobs&#39;</span><span class="p">],</span>
                <span class="s1">&#39;mse&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;PSMmse&#39;</span><span class="p">],</span>
                <span class="s1">&#39;snr&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;SNR&#39;</span><span class="p">],</span>
                <span class="s1">&#39;seasonality&#39;</span><span class="p">:</span> <span class="n">details</span><span class="p">[</span><span class="s1">&#39;seasonality&#39;</span><span class="p">],</span>
                <span class="s1">&#39;approach&#39;</span><span class="p">:</span> <span class="n">approach_name</span>
            <span class="p">})</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">calib_stats</span><span class="p">)</span><span class="si">}</span><span class="s2"> calibrated PSMs for </span><span class="si">{</span><span class="n">approach_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calib_stats</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract stats from all three approaches</span>
<span class="n">stats_class</span> <span class="o">=</span> <span class="n">extract_calib_stats</span><span class="p">(</span><span class="n">job_class_new</span><span class="p">,</span> <span class="s2">&quot;Class-based seasonality&quot;</span><span class="p">)</span>
<span class="n">stats_meta</span> <span class="o">=</span> <span class="n">extract_calib_stats</span><span class="p">(</span><span class="n">job_meta</span><span class="p">,</span> <span class="s2">&quot;Metadata seasonality&quot;</span><span class="p">)</span> 
<span class="n">stats_meta_interp</span> <span class="o">=</span> <span class="n">extract_calib_stats</span><span class="p">(</span><span class="n">job_meta_interp</span><span class="p">,</span> <span class="s2">&quot;Metadata + interpolation&quot;</span><span class="p">)</span>

<span class="c1"># Combine all stats</span>
<span class="n">all_stats</span> <span class="o">=</span>  <span class="n">stats_class</span> <span class="o">+</span> <span class="n">stats_meta</span> <span class="o">+</span> <span class="n">stats_meta_interp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Collecting PSM calibration statistics for Class-based seasonality...
Found 555 calibrated PSMs for Class-based seasonality
Collecting PSM calibration statistics for Metadata seasonality...
Found 501 calibrated PSMs for Metadata seasonality
Collecting PSM calibration statistics for Metadata + interpolation...
Found 522 calibrated PSMs for Metadata + interpolation
</pre></div>
</div>
</div>
</div>
</section>
<section id="make-plots">
<h3>Make Plots<a class="headerlink" href="#make-plots" title="Link to this heading">#</a></h3>
<p>We will have a histogram showing the distribution of the R^2 values, a summary table with statistics, and a spatial distribution with locations of well-calibrated records (threshold can be adjusted).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create comparison plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;PSM Calibration R² Distribution Comparison&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

<span class="n">approaches</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Class-based seasonality&quot;</span><span class="p">,</span> <span class="s2">&quot;Metadata seasonality&quot;</span><span class="p">,</span> <span class="s2">&quot;Metadata + interpolation&quot;</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="s1">&#39;forestgreen&#39;</span><span class="p">,</span> <span class="s1">&#39;darkorange&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">approach</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">approaches</span><span class="p">,</span> <span class="n">colors</span><span class="p">)):</span>
    <span class="c1"># Get R² values for this approach</span>
    <span class="n">approach_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">stat</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">all_stats</span> <span class="k">if</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;approach&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">approach</span><span class="p">]</span>
    <span class="n">r2_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;r2_adj&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">approach_stats</span><span class="p">]</span>
    
    <span class="c1"># Plot histogram</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">r2_values</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Adjusted R²&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Records&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">approach</span><span class="si">}</span><span class="se">\n</span><span class="s1">(n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">r2_values</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    
    <span class="c1"># Add median line</span>
    <span class="n">median_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">r2_values</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">median_r2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                   <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Median: </span><span class="si">{</span><span class="n">median_r2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="c1"># Add summary stats as text</span>
    <span class="n">mean_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_values</span><span class="p">)</span>
    <span class="n">std_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">r2_values</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Mean: </span><span class="si">{</span><span class="n">mean_r2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s1">Std: </span><span class="si">{</span><span class="n">std_r2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
                <span class="n">transform</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/d66681e0468a998a51f05b7a228c005702d9e234d7aa20c6e027288f548a0e35.png" src="../../_images/d66681e0468a998a51f05b7a228c005702d9e234d7aa20c6e027288f548a0e35.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print summary statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SUMMARY STATISTICS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

<span class="k">for</span> <span class="n">approach</span> <span class="ow">in</span> <span class="n">approaches</span><span class="p">:</span>
    <span class="n">approach_stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">stat</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">all_stats</span> <span class="k">if</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;approach&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">approach</span><span class="p">]</span>
    <span class="n">r2_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;r2_adj&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">approach_stats</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">approach</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Records: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">r2_values</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Mean R²: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_values</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Median R²: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">r2_values</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Std R²: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">r2_values</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Min R²: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r2_values</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Max R²: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r2_values</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Records with R² &gt; 0.5: </span><span class="si">{</span><span class="nb">len</span><span class="p">([</span><span class="n">r</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">r2_values</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.5</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Records with R² &gt; 0.7: </span><span class="si">{</span><span class="nb">len</span><span class="p">([</span><span class="n">r</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">r2_values</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.7</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============================================================
SUMMARY STATISTICS
============================================================

Class-based seasonality:
  Records: 555
  Mean R²: 0.1242
  Median R²: 0.0949
  Std R²: 0.1205
  Min R²: -0.0277
  Max R²: 0.6473
  Records with R² &gt; 0.5: 13
  Records with R² &gt; 0.7: 0

Metadata seasonality:
  Records: 501
  Mean R²: 0.0815
  Median R²: 0.0345
  Std R²: 0.1279
  Min R²: -0.0433
  Max R²: 0.9098
  Records with R² &gt; 0.5: 11
  Records with R² &gt; 0.7: 2

Metadata + interpolation:
  Records: 522
  Mean R²: 0.0826
  Median R²: 0.0357
  Std R²: 0.1269
  Min R²: -0.0433
  Max R²: 0.9098
  Records with R² &gt; 0.5: 11
  Records with R² &gt; 0.7: 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PlateCRS</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_add_base_map</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_global</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_prep_xy_r2</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">r2_key</span><span class="p">,</span> <span class="n">thr</span><span class="p">):</span>
    <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">r2s</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r2_key</span><span class="p">)</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">),</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lon</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">r2</span> <span class="o">&gt;</span> <span class="n">thr</span><span class="p">:</span>
            <span class="n">lons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lon</span><span class="p">);</span> <span class="n">lats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat</span><span class="p">);</span> <span class="n">r2s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lons</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r2s</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_high_r2_spatial_comparison</span><span class="p">(</span>
    <span class="n">stats_class</span><span class="p">,</span> <span class="n">stats_meta</span><span class="p">,</span> <span class="n">stats_meta_interp</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span> <span class="n">r2_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">r2_key</span><span class="o">=</span><span class="s2">&quot;r2_adj&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span>  <span class="c1"># &lt;- default False to avoid double display in notebooks</span>
<span class="p">):</span>
    <span class="n">approaches</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Class-based&quot;</span><span class="p">,</span> <span class="s2">&quot;Metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;Metadata + interp&quot;</span><span class="p">)</span>
    <span class="n">colors</span>     <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span> <span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span> <span class="s2">&quot;darkorange&quot;</span><span class="p">)</span>
    <span class="n">stats_sets</span> <span class="o">=</span> <span class="p">(</span><span class="n">stats_class</span><span class="p">,</span> <span class="n">stats_meta</span><span class="p">,</span> <span class="n">stats_meta_interp</span><span class="p">)</span>

    <span class="n">xy_r2</span> <span class="o">=</span> <span class="p">[</span> <span class="n">_prep_xy_r2</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">r2_key</span><span class="p">,</span> <span class="n">r2_threshold</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats_sets</span> <span class="p">]</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">int</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r2_key</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r2_key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">r2_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats_sets</span>
    <span class="p">]</span>

    <span class="c1"># Figure with a thin bottom row for the colorbar</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">],</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">PlateCRS</span><span class="p">),</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">PlateCRS</span><span class="p">),</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">PlateCRS</span><span class="p">),</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">PlateCRS</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>  <span class="c1"># dedicated colorbar axis</span>

    <span class="c1"># Panels 1–3 (colored by R²)</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">r2s</span><span class="p">),</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">approaches</span><span class="p">,</span> <span class="n">xy_r2</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
        <span class="n">_add_base_map</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span><span class="c1">#, with_labels=True)</span>
        <span class="k">if</span> <span class="n">r2s</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">r2s</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">PlateCRS</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">r2_threshold</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span>
            <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">(n=</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> with R² &gt; </span><span class="si">{</span><span class="n">r2_threshold</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

    <span class="c1"># Panel 4 (combined, colored by approach)</span>
    <span class="n">ax_c</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">_add_base_map</span><span class="p">(</span><span class="n">ax_c</span><span class="p">)</span><span class="c1">#, with_labels=True)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">approaches</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">xy_r2</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">ax_c</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">PlateCRS</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (n=</span><span class="si">{</span><span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
    <span class="n">ax_c</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined: R² &gt; </span><span class="si">{</span><span class="n">r2_threshold</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">ax_c</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Colorbar in its own axis</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">r2_threshold</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">);</span> <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Adjusted R²&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spatial Distribution of Well-Calibrated PSMs (R² &gt; </span><span class="si">{</span><span class="n">r2_threshold</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">])</span>  <span class="c1"># leave a bit for suptitle</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>   <span class="c1"># show once if you explicitly ask</span>
        <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># avoid echoing a Figure</span>
    <span class="k">return</span> <span class="n">fig</span>       <span class="c1"># otherwise return the Figure without calling show()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">extract_calib_stats_with_coords</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">approach_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">r2_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fitR2adj&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
                                   <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract PSM calibration stats incl. coordinates from a ReconJob-like object.</span>

<span class="sd">    Expects:</span>
<span class="sd">    - job.proxydb.records: mapping of pid -&gt; record</span>
<span class="sd">    - record.psm.calib_details: dict containing r², nobs, mse, SNR, seasonality</span>
<span class="sd">    - record.lat / record.lon / record.ptype</span>
<span class="sd">    - record.tags (dict-like) with optional &#39;name&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calib_stats</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collecting PSM calibration statistics for </span><span class="si">{</span><span class="n">approach_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;proxydb&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">psm</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;psm&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">details</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">psm</span><span class="p">,</span> <span class="s2">&quot;calib_details&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">psm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pid</span><span class="p">,</span>
            <span class="s2">&quot;r2_adj&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r2_key</span><span class="p">),</span>           <span class="c1"># normalize to &#39;r2_adj&#39; for plotting</span>
            <span class="s2">&quot;nobs&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nobs&quot;</span><span class="p">),</span>
            <span class="s2">&quot;mse&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PSMmse&quot;</span><span class="p">),</span>
            <span class="s2">&quot;snr&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SNR&quot;</span><span class="p">),</span>
            <span class="s2">&quot;seasonality&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seasonality&quot;</span><span class="p">),</span>
            <span class="s2">&quot;approach&quot;</span><span class="p">:</span> <span class="n">approach_name</span><span class="p">,</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;ptype&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;ptype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">calib_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">calib_stats</span><span class="p">)</span><span class="si">}</span><span class="s2"> calibrated PSMs for </span><span class="si">{</span><span class="n">approach_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calib_stats</span>
</pre></div>
</div>
</div>
</div>
<p>Plotting functions and helpers for spatial distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- CRS (axes + data are both geographic lon/lat) ---</span>
<span class="n">MAP_CRS</span>  <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>   <span class="c1"># for subplot projection</span>
<span class="n">DATA_CRS</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>   <span class="c1"># for the lon/lat data transform</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_add_base_map</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">COASTLINE</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">BORDERS</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_global</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_prep_xy_r2</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">r2_key</span><span class="p">,</span> <span class="n">thr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return lon/lat/r2 arrays filtered by threshold and finite values.&quot;&quot;&quot;</span>
    <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">r2s</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r2_key</span><span class="p">)</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">),</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lon</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">r2</span> <span class="o">&gt;</span> <span class="n">thr</span><span class="p">:</span>
            <span class="n">lons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lon</span><span class="p">);</span> <span class="n">lats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat</span><span class="p">);</span> <span class="n">r2s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">lons</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">r2s</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">,</span> <span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">r2s</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lons</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">r2s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lons</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">r2s</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_high_r2_spatial_comparison</span><span class="p">(</span>
    <span class="n">stats_class</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
    <span class="n">stats_meta</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
    <span class="n">stats_meta_interp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">r2_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>           <span class="c1"># &lt;- lower default so you see points</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="n">r2_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;r2_adj&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Reds&quot;</span><span class="p">,</span>
    <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">):</span>
    <span class="n">approaches</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Class-based&quot;</span><span class="p">,</span> <span class="s2">&quot;Metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;Metadata + interp&quot;</span><span class="p">)</span>
    <span class="n">colors</span>     <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span> <span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span> <span class="s2">&quot;darkorange&quot;</span><span class="p">)</span>
    <span class="n">stats_sets</span> <span class="o">=</span> <span class="p">(</span><span class="n">stats_class</span><span class="p">,</span> <span class="n">stats_meta</span><span class="p">,</span> <span class="n">stats_meta_interp</span><span class="p">)</span>

    <span class="n">xy_r2</span> <span class="o">=</span> <span class="p">[</span> <span class="n">_prep_xy_r2</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">r2_key</span><span class="p">,</span> <span class="n">r2_threshold</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats_sets</span> <span class="p">]</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">int</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r2_key</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r2_key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">r2_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats_sets</span>
    <span class="p">]</span>
    <span class="c1"># quick sanity print so you know data exist</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;counts (&gt;= threshold):&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xy_r2</span><span class="p">],</span> <span class="s2">&quot; | threshold:&quot;</span><span class="p">,</span> <span class="n">r2_threshold</span><span class="p">)</span>

    <span class="c1"># figure with a dedicated colorbar row</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">],</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">MAP_CRS</span><span class="p">),</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">MAP_CRS</span><span class="p">),</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">MAP_CRS</span><span class="p">),</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="n">MAP_CRS</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>  <span class="c1"># shared colorbar axis</span>

    <span class="c1"># panels 1–3 (colored by R²)</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">r2s</span><span class="p">),</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">approaches</span><span class="p">,</span> <span class="n">xy_r2</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
        <span class="n">_add_base_map</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r2s</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">r2s</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">DATA_CRS</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">r2_threshold</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span>
            <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">(n=</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> with R² &gt; </span><span class="si">{</span><span class="n">r2_threshold</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

    <span class="c1"># combined panel (colored by approach)</span>
    <span class="n">ax_c</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">_add_base_map</span><span class="p">(</span><span class="n">ax_c</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">_count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">approaches</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">xy_r2</span><span class="p">,</span> <span class="n">counts</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">ax_c</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">DATA_CRS</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (n=</span><span class="si">{</span><span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
    <span class="n">ax_c</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined: R² &gt; </span><span class="si">{</span><span class="n">r2_threshold</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
    <span class="n">ax_c</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="c1"># shared colorbar</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">r2_threshold</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">);</span> <span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Adjusted R²&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spatial Distribution of Well-Calibrated PSMs (R² &gt; </span><span class="si">{</span><span class="n">r2_threshold</span><span class="si">:</span><span class="s2">g</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.98</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">fig</span>

<span class="c1"># ---- stats extractor (with coords) ----</span>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_calib_stats_with_coords</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">approach_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">r2_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fitR2adj&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract PSM calibration stats incl. lat/lon.&quot;&quot;&quot;</span>
    <span class="n">calib_stats</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Collecting PSM calibration statistics for </span><span class="si">{</span><span class="n">approach_name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s2">&quot;proxydb&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">psm</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;psm&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">details</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">psm</span><span class="p">,</span> <span class="s2">&quot;calib_details&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">psm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">calib_stats</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;pid&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pid</span><span class="p">,</span>
            <span class="s2">&quot;r2_adj&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r2_key</span><span class="p">),</span>
            <span class="s2">&quot;nobs&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nobs&quot;</span><span class="p">),</span>
            <span class="s2">&quot;mse&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PSMmse&quot;</span><span class="p">),</span>
            <span class="s2">&quot;snr&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SNR&quot;</span><span class="p">),</span>
            <span class="s2">&quot;seasonality&quot;</span><span class="p">:</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seasonality&quot;</span><span class="p">),</span>
            <span class="s2">&quot;approach&quot;</span><span class="p">:</span> <span class="n">approach_name</span><span class="p">,</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;ptype&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="s2">&quot;ptype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">})</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">calib_stats</span><span class="p">)</span><span class="si">}</span><span class="s2"> calibrated PSMs for </span><span class="si">{</span><span class="n">approach_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calib_stats</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stats_class</span> <span class="o">=</span> <span class="n">extract_calib_stats_with_coords</span><span class="p">(</span><span class="n">job_class_new</span><span class="p">,</span> <span class="s2">&quot;Class-based&quot;</span><span class="p">)</span>
<span class="n">stats_meta</span>  <span class="o">=</span> <span class="n">extract_calib_stats_with_coords</span><span class="p">(</span><span class="n">job_meta</span><span class="p">,</span> <span class="s2">&quot;Metadata&quot;</span><span class="p">)</span>
<span class="n">stats_int</span>   <span class="o">=</span> <span class="n">extract_calib_stats_with_coords</span><span class="p">(</span><span class="n">job_meta_interp</span><span class="p">,</span> <span class="s2">&quot;Metadata + interp&quot;</span><span class="p">)</span>

<span class="n">plot_high_r2_spatial_comparison</span><span class="p">(</span><span class="n">stats_class</span><span class="p">,</span> <span class="n">stats_meta</span><span class="p">,</span> <span class="n">stats_int</span><span class="p">,</span> <span class="n">r2_threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Collecting PSM calibration statistics for Class-based...
Found 555 calibrated PSMs for Class-based
Collecting PSM calibration statistics for Metadata...
Found 501 calibrated PSMs for Metadata
Collecting PSM calibration statistics for Metadata + interp...
Found 522 calibrated PSMs for Metadata + interp
counts (&gt;= threshold): [107, 63, 65]  | threshold: 0.2
</pre></div>
</div>
<img alt="../../_images/0f1548e004a8ee2d07da7d68f1935f184c8a5022bca4a6ee871149d293c23c54.png" src="../../_images/0f1548e004a8ee2d07da7d68f1935f184c8a5022bca4a6ee871149d293c23c54.png" />
</div>
</div>
</section>
<section id="key-takeaways">
<h3>Key Takeaways<a class="headerlink" href="#key-takeaways" title="Link to this heading">#</a></h3>
<p><strong>Calibration distributions and table</strong>:</p>
<ul class="simple">
<li><p>Class-based seasonality achieves the highest mean and median R^2 (~0.12 / 0.095), with more consistently skillful records.</p></li>
<li><p>Metadata approaches have lower average skill (mean ~0.08 / median ~0.035), though they occasionally produce very high outliers</p></li>
<li><p>Interpolation increases record count but does not improve overall calibration quality, which could still contribute to the overall skill of the reconstruction.</p></li>
</ul>
<p><strong>“Well-calibrated” records (R^2 &gt; 0.2)</strong>:</p>
<ul class="simple">
<li><p>Class-based has the largest number (n=107) compared to metadata (n=63) and metadata + interpolation (n=65).</p></li>
<li><p>High-skill records are located mainly in Europe, North America, and parts of Asia (for class-based), with lower coverage in the tropics, oceans in general, and Southern Hemisphere.</p></li>
</ul>
<p><strong>Overall</strong>:</p>
<ul class="simple">
<li><p>Class-based calibration provides broader and more robust spatial coverage.</p></li>
<li><p>Metadata-based adds a tiny number of high correlated sites (that require deeper investigation), but overall performance is worse and patchier</p></li>
<li><p>The combined view of all three shows that class-based is the strongest by default, with the metadata approach potentially contributing to some skill in very specific sites.</p></li>
<li><p>It is important to note here that the network loses about 10% of its records once we whittle it down from class-based to metadata-based despite both starting from the same initial proxy database. Further investigations will show how much of an impact this has and if there are other combinations of databases (class-based with interp, etc.) that we can use to improve upon the baseline set by LMRv2.1.</p></li>
</ul>
</section>
</section>
<section id="to-do-validation-against-withheld-proxies">
<h2>To-Do: Validation Against Withheld Proxies<a class="headerlink" href="#to-do-validation-against-withheld-proxies" title="Link to this heading">#</a></h2>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/validation"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="C03_b_comparison.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Proxy Database Forensics</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#author">Author</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-reconstructions">Load the Reconstructions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gmst-plots">GMST plots</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#difference-plots">Difference Plots</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pens">Pens</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#instrumental-validation">Instrumental Validation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gmst-comparisons">GMST comparisons</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#gistemp">GISTEMP</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#hadcrut5">HADCRUT5</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#berkeley-earth-surface-temperature-best">Berkeley Earth Surface Temperature (BEST)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#consensus">Consensus</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#takeaways-from-the-results-table">Takeaways from the Results Table</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#validation-on-climate-fields">Validation on Climate Fields</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#best">BEST</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psm-calibration-statistics">PSM Calibration Statistics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#load-proxy-databases">Load Proxy Databases</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#make-plots">Make Plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#key-takeaways">Key Takeaways</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#to-do-validation-against-withheld-proxies">To-Do: Validation Against Withheld Proxies</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Tanaya Gondhalekar, Deborah Khider, Julien Emile-Geay
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>