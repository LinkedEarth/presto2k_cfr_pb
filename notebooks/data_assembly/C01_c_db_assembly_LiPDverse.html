
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Assembling the proxy database from the LiPDVerse &#8212; Assimilating PAGES 2k records with LinkedEarth tools</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/data_assembly/C01_c_db_assembly_LiPDverse';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Assembling the proxy database from the LiPDGraph" href="C01_d_db_assembly_LiPDGraph.html" />
    <link rel="prev" title="Database Assembly using cfr’s built in PAGES 2k database" href="C01_b_db_assembly_cfr_PAGES2k.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../README.html">
  
  
  
  
  
  
    <p class="title logo__title">Assimilating PAGES 2k records with LinkedEarth tools</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../README.html">
                    Assimilating PAGES 2k records with LinkedEarth tools
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Assembly</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="C01_a_db_assembly_Tardif2019_pickle.html">Database Assembly using the LMRv2.1 pickle file</a></li>
<li class="toctree-l1"><a class="reference internal" href="C01_b_db_assembly_cfr_PAGES2k.html">Database Assembly using cfr’s built in PAGES 2k database</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Assembling the proxy database from the LiPDVerse</a></li>
<li class="toctree-l1"><a class="reference internal" href="C01_d_db_assembly_LiPDGraph.html">Assembling the proxy database from the LiPDGraph</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Data Assimilation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../data_assimilation/C02_a_DA_with_class_based_seasonality.html">Run Data Assimilation (Class-Based Seasonality)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_assimilation/C02_b_DA_with_individual_seasonality.html">Run Data Assimilation (Individual Seasonality)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Validation and Comparison</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../validation/C03_a_validation.html">Validating a Reconstruction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../validation/C03_b_comparison.html">Proxy Database Forensics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../validation/C04_validating_PReSto2k.html">Validating PReSto2k</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/tanaya-g/pages2k_cfr_pb" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/tanaya-g/pages2k_cfr_pb/issues/new?title=Issue%20on%20page%20%2Fnotebooks/data_assembly/C01_c_db_assembly_LiPDverse.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/data_assembly/C01_c_db_assembly_LiPDverse.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Assembling the proxy database from the LiPDVerse</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">Authors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goal">Goal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-description">Data Description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-records-in-each-of-the-compilations">Exploring the records in each of the compilations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pages2k">PAGES2k</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iso2k">iso2k</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coralhydro2k">CoralHydro2k</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#database-assemble">DataBase: Assemble!</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#special-handling-the-palmyra-record">Special handling: The Palmyra record</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-duplication-sr-ca">Handling duplication: Sr/Ca</a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-correlation">Option 1: Correlation</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-dynamic-time-wrapping">Option 2: Dynamic Time Wrapping</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#option-3-principal-component-analysis">Option 3: Principal Component Analysis</a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-duplication-part-2-delta-18-mathrm-o">Handling duplication part 2: <span class="math notranslate nohighlight">\(\delta^{18}\mathrm{O}\)</span></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Option 1: Correlation</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-dtw">Option 2: DTW</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-cleaning-and-pre-processing">Data Cleaning and Pre-processing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-remove-records-shorter-than-150-years">Step 1: Remove records shorter than 150 years</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-screen-for-duplicates">Step 2: Screen for duplicates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-the-cfr-proxydatabase">Building the cfr.ProxyDataBase</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-ptype-and-seasonality-info">Adding ptype and seasonality info</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-debug-before-saving-proxydatabases">Quick debug before saving ProxyDatabases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-filter-by-dt-1">Option 1: Filter by dt &lt;= 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-interpolated-then-filtered-by-annual-subannual">Option 2: Interpolated then filtered by annual/subannual</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#proxy-database-comparisons">Proxy Database Comparisons</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-interpolated-vs-non-interpolated-presto2k-databases">Comparing Interpolated vs. Non-Interpolated PReSto2k databases</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-pages2k-with-presto2k">Comparing Original PAGES2k with PReSto2k</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-meta-vs-class-based-seasonality">Comparing Meta vs. Class Based Seasonality</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="assembling-the-proxy-database-from-the-lipdverse">
<h1>Assembling the proxy database from the LiPDVerse<a class="headerlink" href="#assembling-the-proxy-database-from-the-lipdverse" title="Link to this heading">#</a></h1>
<p>⚠️ <strong>Warning</strong></p>
<p>This notebook contains a cell that starts a widget to help with identifying duplicates in the database. We strongly advise that you do not run the widget yourself unless you intend to go through the cleaning process. A list of removed datasets (TSiDS) and the reason they were removed or kept is stored in csv files in this repository. The resulting cleaned database has also been saved in a pickle file.</p>
<div style="border-left: 6px solid #e74c3c; background-color: #f8d7da; padding: 10px; margin: 10px 0;">
  <strong>❗ DO NOT RUN ALL!!!!!!  </strong>
</div>
<section id="authors">
<h2>Authors<a class="headerlink" href="#authors" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://orcid.org/0000-0001-7501-8430">Deborah Khider</a>,
<a class="reference external" href="https://orcid.org/0000-0001-5920-4751">Julien Emile-Geay</a>, &amp; <a class="reference external" href="https://orcid.org/0009-0004-2440-3266">Tanaya Gondhalekar</a></p>
</section>
<section id="goal">
<h2>Goal<a class="headerlink" href="#goal" title="Link to this heading">#</a></h2>
<p>The goal of this notebook is to showcase data querying on the LiPDverser to create the proxy database</p>
</section>
<section id="data-description">
<h2>Data Description<a class="headerlink" href="#data-description" title="Link to this heading">#</a></h2>
<p>This notebook makes use of the <a class="reference external" href="https://lipdverse.org"><code class="docutils literal notranslate"><span class="pre">LiPDVerse</span></code> database</a>, which contains datasets from various working groups. For a list of these compilations, see <a class="reference external" href="https://lipdverse.org/project/">this page</a>.</p>
<p>In particular, we will be using <a class="reference external" href="https://lipdverse.org/project/pages2k/">PAGES2kTemperature</a>, <a class="reference external" href="https://lipdverse.org/project/iso2k/">iso-2k</a>, and <a class="reference external" href="https://lipdverse.org/project/coralhydro2k/">CoralHydro2k</a> compilations for this demonstration.</p>
<ul class="simple">
<li><p>PAGES2k: PAGES2k Consortium., Emile-Geay, J., McKay, N. et al. A global multiproxy database for temperature reconstructions of the Common Era. Sci Data 4, 170088 (2017). doi:10.1038/sdata.2017.88</p></li>
<li><p>iso2k: Konecky, B. L., McKay, N. P., Churakova (Sidorova), O. V., Comas-Bru, L., Dassié, E. P., DeLong, K. L., Falster, G. M., Fischer, M. J., Jones, M. D., Jonkers, L., Kaufman, D. S., Leduc, G., Managave, S. R., Martrat, B., Opel, T., Orsi, A. J., Partin, J. W., Sayani, H. R., Thomas, E. K., Thompson, D. M., Tyler, J. J., Abram, N. J., Atwood, A. R., Cartapanis, O., Conroy, J. L., Curran, M. A., Dee, S. G., Deininger, M., Divine, D. V., Kern, Z., Porter, T. J., Stevenson, S. L., von Gunten, L., and Iso2k Project Members: The Iso2k database: a global compilation of paleo-δ18O and δ2H records to aid understanding of Common Era climate, Earth Syst. Sci. Data, 12, 2261–2288, <a class="reference external" href="https://doi.org/10.5194/essd-12-2261-2020">https://doi.org/10.5194/essd-12-2261-2020</a>, 2020.</p></li>
<li><p>CoralHydro2k:  Walter, R. M., H. R. Sayani, T. Felis, K. M. Cobb, N. J. Abram, A. K. Arzey, A. R. Atwood, L. D.
Brenner, E. P. Dassi ́e, K. L. DeLong, B. Ellis, J. Emile-Geay, M. J. Fischer, N. F. Goodkin, J. A.
Hargreaves, K. H. Kilbourne, H. Krawczyk, N. P. McKay, A. L. Moore, S. A. Murty, M. R. Ong,
R. D. Ramos, E. V. Reed, D. Samanta, S. C. Sanchez, J. Zinke, and the PAGES CoralHydro2k Project Members (2023), The CoralHydro2k database: a global, actively curated compilation of coral δ18O and Sr / Ca proxy records of tropical ocean hydrology and temperature for the Common Era, Earth System Science Data, 15(5), 2081–2116, doi:10.5194/essd-15-2081-2023.</p></li>
</ul>
<p>Let’s start by downloading the datasets.</p>
<div style="border-left: 4px solid #d62728; background-color: #ffe6e6; padding: 0.75em 1em; border-radius: 6px; font-size: 0.95em;">
  <strong>⚠️ Warning:</strong> You only need to run the cell below once. It will download the data locally. The rest of the notebook assumes that the data is organized according to the output of the cell below.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># URL Links to download the data</span>

<span class="n">pages2k_url</span> <span class="o">=</span> <span class="s2">&quot;https://lipdverse.org/Pages2kTemperature/current_version/Pages2kTemperature2_2_0.zip&quot;</span>
<span class="n">iso2k_url</span> <span class="o">=</span> <span class="s2">&quot;https://lipdverse.org/iso2k/current_version/iso2k1_1_2.zip&quot;</span>
<span class="n">coral2k_url</span> <span class="o">=</span><span class="s2">&quot;https://lipdverse.org/CoralHydro2k/current_version/CoralHydro2k1_0_1.zip&quot;</span>

<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">pages2k_url</span><span class="p">,</span><span class="n">iso2k_url</span><span class="p">,</span><span class="n">coral2k_url</span><span class="p">]</span>
<span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Pages2k&#39;</span><span class="p">,</span> <span class="s1">&#39;iso2k&#39;</span><span class="p">,</span> <span class="s1">&#39;coral2k&#39;</span><span class="p">]</span>

<span class="c1"># import the necessary packages</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zipfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="c1">## PAGES2k</span>
<span class="c1"># Define folder path and URL</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">url</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">urls</span><span class="p">):</span>
    <span class="n">folder_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;./data/</span><span class="si">{</span><span class="n">folders</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">zip_path</span> <span class="o">=</span> <span class="n">folder_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">)</span>

    <span class="c1"># Step 1: Check if folder exists, create if not</span>
    <span class="n">folder_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Step 2: Check if folder is empty</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">folder_path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Folder is empty. Downloading data...&quot;</span><span class="p">)</span>

        <span class="c1"># Step 3: Download zip file</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded ZIP to </span><span class="si">{</span><span class="n">zip_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Step 4: Extract zip contents into folder</span>
        <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
            <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted contents to </span><span class="si">{</span><span class="n">folder_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Folder is empty. Downloading data...
Downloaded ZIP to data/Pages2k.zip
Extracted contents to data/Pages2k
Folder is empty. Downloading data...
Downloaded ZIP to data/iso2k.zip
Extracted contents to data/iso2k
Folder is empty. Downloading data...
Downloaded ZIP to data/coral2k.zip
Extracted contents to data/coral2k
</pre></div>
</div>
</div>
</div>
</section>
<section id="exploring-the-records-in-each-of-the-compilations">
<h2>Exploring the records in each of the compilations<a class="headerlink" href="#exploring-the-records-in-each-of-the-compilations" title="Link to this heading">#</a></h2>
<p>Let’s start with importing the needed packages:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># General data manipulation libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># To manipulate LiPD files</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pylipd.lipd</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiPD</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="c1"># Scientific toolboxes</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyleoclim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pyleo</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cfr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>

<span class="c1">#To be able to compare timeseries</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">zscore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dtaidistance</span><span class="w"> </span><span class="kn">import</span> <span class="n">dtw</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">pearsonr</span><span class="p">,</span> <span class="n">zscore</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>

<span class="c1">#For saving</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
</pre></div>
</div>
</div>
</div>
<section id="pages2k">
<h3>PAGES2k<a class="headerlink" href="#pages2k" title="Link to this heading">#</a></h3>
<p>Let’s start with the PAGES2k dataset. We can load the entire folder into a <a class="reference external" href="https://pylipd.readthedocs.io/en/latest/api.html#lipd-pylipd-lipd-lipd"><code class="docutils literal notranslate"><span class="pre">pylipd.LiPD</span></code> object</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D_pages2k</span> <span class="o">=</span> <span class="n">LiPD</span><span class="p">()</span>
<span class="n">D_pages2k</span><span class="o">.</span><span class="n">load_from_dir</span><span class="p">(</span><span class="s1">&#39;./data/Pages2k/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading 647 LiPD files
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 647/647 [00:11&lt;00:00, 54.47it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded..
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p>Let’s create a query to gather all the necessary information. Since <code class="docutils literal notranslate"><span class="pre">PyLiPD</span></code> is build upon the <a class="reference external" href="https://rdflib.readthedocs.io/en/stable/"><code class="docutils literal notranslate"><span class="pre">rdflib</span></code> library</a> and <code class="docutils literal notranslate"><span class="pre">LiPD</span></code> is defined as a child of the <code class="docutils literal notranslate"><span class="pre">Graph</span></code> class in <code class="docutils literal notranslate"><span class="pre">rdflib</span></code>, it is possible to directly query a LiPD object using a SPARQL query as in <a class="reference external" href="https://linked.earth/pylipdTutorials/notebooks/L2_a_custom_queries.html">this tutorial</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; PREFIX le: &lt;http://linked.earth/ontology#&gt;</span>
<span class="s2">PREFIX wgs84: &lt;http://www.w3.org/2003/01/geo/wgs84_pos#&gt;</span>
<span class="s2">PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span>

<span class="s2">SELECT ?dataSetName ?compilationName ?archiveType ?geo_meanLat ?geo_meanLon ?geo_meanElev </span>
<span class="s2">    ?paleoData_variableName ?paleoData_standardName ?paleoData_values ?paleoData_units </span>
<span class="s2">    ?paleoData_proxy ?paleoData_proxyGeneral ?paleoData_seasonality ?paleoData_interpName ?paleoData_interpRank </span>
<span class="s2">    ?TSID ?time_variableName ?time_standardName ?time_values</span>
<span class="s2">	?time_units where{</span>
<span class="s2">    </span>
<span class="s2">    ?ds a le:Dataset .</span>
<span class="s2">    ?ds le:hasName ?dataSetName .</span>

<span class="s2">    # Get the archive</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">            ?ds le:hasArchiveType ?archiveTypeObj .</span>
<span class="s2">            ?archiveTypeObj rdfs:label ?archiveType .</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">    # Geographical information    </span>
<span class="s2">    </span>
<span class="s2">    ?ds le:hasLocation ?loc .</span>
<span class="s2">        OPTIONAL{?loc wgs84:lat ?geo_meanLat .}</span>
<span class="s2">        OPTIONAL{?loc wgs84:long ?geo_meanLon .}      </span>
<span class="s2">        OPTIONAL{?loc wgs84:alt ?geo_meanElev .}</span>
<span class="s2">    </span>
<span class="s2">    # PaleoData</span>

<span class="s2">    ?ds le:hasPaleoData ?data .</span>
<span class="s2">    ?data le:hasMeasurementTable ?table .</span>
<span class="s2">    ?table le:hasVariable ?var .</span>

<span class="s2">    # Name</span>
<span class="s2">    ?var le:hasName ?paleoData_variableName .</span>
<span class="s2">    ?var le:hasStandardVariable ?variable_obj .</span>
<span class="s2">    ?variable_obj rdfs:label ?paleoData_standardName .</span>
<span class="s2">    </span>
<span class="s2">    #Values</span>
<span class="s2">    ?var le:hasValues ?paleoData_values .</span>

<span class="s2">    #Seasonality</span>
<span class="s2">    OPTIONAL{?var le:seasonality ?paleoData_seasonality} .</span>

<span class="s2">    #Units</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasUnits ?paleoData_unitsObj .</span>
<span class="s2">        ?paleoData_unitsObj rdfs:label ?paleoData_units .</span>
<span class="s2">    }</span>

<span class="s2">    #Proxy information</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasProxy ?paleoData_proxyObj .</span>
<span class="s2">        ?paleoData_proxyObj rdfs:label ?paleoData_proxy .</span>
<span class="s2">    }</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasProxyGeneral ?paleoData_proxyGeneralObj .</span>
<span class="s2">        ?paleoData_proxyGeneralObj rdfs:label ?paleoData_proxyGeneral .</span>
<span class="s2">    }</span>

<span class="s2">    # Compilation</span>
<span class="s2">    ?var le:partOfCompilation ?compilation . </span>
<span class="s2">    ?compilation le:hasName ?compilationName .</span>
<span class="s2">    FILTER (?compilationName = &quot;Pages2kTemperature&quot;).</span>
<span class="s2">    ?var le:useInGlobalTemperatureAnalysis True .</span>

<span class="s2">    # TSiD (should all have them)</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasVariableId ?TSID</span>
<span class="s2">    } .</span>

<span class="s2">    # Interpretation (might be an optional field)</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>

<span class="s2">        ?interp le:hasVariable ?interpvar .</span>
<span class="s2">        BIND(REPLACE(STR(?interpvar), &quot;http://linked.earth/ontology/interpretation#&quot;, &quot;&quot;) AS ?interpretedVariable_Fallback)</span>
<span class="s2">        OPTIONAL { ?interpvar rdfs:label ?interpretedVariable_Label } # Use a temporary variable for the label</span>
<span class="s2">        BIND(COALESCE(?interpretedVariable_Label, ?interpretedVariable_Fallback) AS ?paleoData_interpName) # COALESCE into the final variable</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>
<span class="s2">        ?interp le:hasRank ?paleoData_interpRank .}</span>
<span class="s2">    </span>
<span class="s2">    </span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>
<span class="s2">    </span>
<span class="s2">        ?interp le:hasSeasonality ?seasonalityURI .</span>
<span class="s2">        BIND(REPLACE(STR(?seasonalityURI), &quot;http://linked.earth/ontology/interpretation#&quot;, &quot;&quot;) AS ?seasonality_Fallback)</span>
<span class="s2">        OPTIONAL { ?seasonalityURI rdfs:label ?seasonalityLabel }</span>
<span class="s2">        BIND(COALESCE(?seasonalityLabel, ?seasonality_Fallback) AS ?paleoData_seasonality)</span>
<span class="s2">    }</span>

<span class="s2">    #Time information</span>
<span class="s2">    ?table le:hasVariable ?timevar .</span>
<span class="s2">    ?timevar le:hasName ?time_variableName .</span>
<span class="s2">    ?timevar le:hasStandardVariable ?timevar_obj .</span>
<span class="s2">    ?timevar_obj rdfs:label ?time_standardName .</span>
<span class="s2">    VALUES ?time_standardName {&quot;year&quot;} .</span>
<span class="s2">    ?timevar le:hasValues ?time_values .</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?timevar le:hasUnits ?time_unitsObj .</span>
<span class="s2">        ?time_unitsObj rdfs:label ?time_units .</span>
<span class="s2">    }  </span>
<span class="s2">}&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qres</span><span class="p">,</span> <span class="n">df_pages2k</span> <span class="o">=</span> <span class="n">D_pages2k</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="n">df_pages2k</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>paleoData_proxy</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Ant-WDC05A.Steig.2013</td>
      <td>Pages2kTemperature</td>
      <td>Glacier ice</td>
      <td>-79.46</td>
      <td>-112.09</td>
      <td>1806.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-33.32873325, -35.6732, -33.1574, -34.2854, -...</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>Annual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Ant_030</td>
      <td>year</td>
      <td>year</td>
      <td>[2005, 2004, 2003, 2002, 2001, 2000, 1999, 199...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NAm-MtLemon.Briffa.2002</td>
      <td>Pages2kTemperature</td>
      <td>Wood</td>
      <td>32.50</td>
      <td>-110.80</td>
      <td>2700.0</td>
      <td>MXD</td>
      <td>MXD</td>
      <td>[0.968, 0.962, 1.013, 0.95, 1.008, 0.952, 1.02...</td>
      <td>None</td>
      <td>maximum latewood density</td>
      <td>dendrophysical</td>
      <td>Summer</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>NAm_568</td>
      <td>year</td>
      <td>year</td>
      <td>[1568, 1569, 1570, 1571, 1572, 1573, 1574, 157...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Arc-Arjeplog.Bjorklund.2014</td>
      <td>Pages2kTemperature</td>
      <td>Wood</td>
      <td>66.30</td>
      <td>18.20</td>
      <td>800.0</td>
      <td>density</td>
      <td>density</td>
      <td>[-0.829089212152348, -0.733882889924006, -0.89...</td>
      <td>None</td>
      <td>maximum latewood density</td>
      <td>dendrophysical</td>
      <td>Jun-Aug</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Arc_060</td>
      <td>year</td>
      <td>year</td>
      <td>[1200, 1201, 1202, 1203, 1204, 1205, 1206, 120...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Asi-CHIN019.Li.2010</td>
      <td>Pages2kTemperature</td>
      <td>Wood</td>
      <td>29.15</td>
      <td>99.93</td>
      <td>2150.0</td>
      <td>ringWidth</td>
      <td>ringWidth</td>
      <td>[1.465, 1.327, 1.202, 0.757, 1.094, 1.006, 1.2...</td>
      <td>None</td>
      <td>ring width</td>
      <td>dendrophysical</td>
      <td>Annual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Asia_041</td>
      <td>year</td>
      <td>year</td>
      <td>[1509, 1510, 1511, 1512, 1513, 1514, 1515, 151...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>4</th>
      <td>NAm-Landslide.Luckman.2006</td>
      <td>Pages2kTemperature</td>
      <td>Wood</td>
      <td>60.20</td>
      <td>-138.50</td>
      <td>800.0</td>
      <td>ringWidth</td>
      <td>ringWidth</td>
      <td>[1.123, 0.841, 0.863, 1.209, 1.139, 1.056, 0.8...</td>
      <td>None</td>
      <td>ring width</td>
      <td>dendrophysical</td>
      <td>Summer</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>NAm_1876</td>
      <td>year</td>
      <td>year</td>
      <td>[913, 914, 915, 916, 917, 918, 919, 920, 921, ...</td>
      <td>yr AD</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s have a look at the resulting data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_pages2k</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 691 entries, 0 to 690
Data columns (total 20 columns):
 #   Column                  Non-Null Count  Dtype  
---  ------                  --------------  -----  
 0   dataSetName             691 non-null    object 
 1   compilationName         691 non-null    object 
 2   archiveType             691 non-null    object 
 3   geo_meanLat             691 non-null    float64
 4   geo_meanLon             691 non-null    float64
 5   geo_meanElev            684 non-null    float64
 6   paleoData_variableName  691 non-null    object 
 7   paleoData_standardName  691 non-null    object 
 8   paleoData_values        691 non-null    object 
 9   paleoData_units         283 non-null    object 
 10  paleoData_proxy         691 non-null    object 
 11  paleoData_proxyGeneral  500 non-null    object 
 12  paleoData_seasonality   691 non-null    object 
 13  paleoData_interpName    691 non-null    object 
 14  paleoData_interpRank    1 non-null      float64
 15  TSID                    691 non-null    object 
 16  time_variableName       691 non-null    object 
 17  time_standardName       691 non-null    object 
 18  time_values             691 non-null    object 
 19  time_units              691 non-null    object 
dtypes: float64(4), object(16)
memory usage: 108.1+ KB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_pages2k</span><span class="p">[</span><span class="s1">&#39;paleoData_interpName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;temperature&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<p>We have 691 timeseries that represent temperature, consistent with the information from the LiPDverse.</p>
</section>
<section id="iso2k">
<h3>iso2k<a class="headerlink" href="#iso2k" title="Link to this heading">#</a></h3>
<p>Let’s do something similar for the iso2k database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D_iso2k</span> <span class="o">=</span> <span class="n">LiPD</span><span class="p">()</span>
<span class="n">D_iso2k</span><span class="o">.</span><span class="n">load_from_dir</span><span class="p">(</span><span class="s1">&#39;./data/iso2k&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading 509 LiPD files
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 509/509 [00:14&lt;00:00, 34.94it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded..
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_iso</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; PREFIX le: &lt;http://linked.earth/ontology#&gt;</span>
<span class="s2">PREFIX wgs84: &lt;http://www.w3.org/2003/01/geo/wgs84_pos#&gt;</span>
<span class="s2">PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span>

<span class="s2">SELECT ?dataSetName ?compilationName ?archiveType ?geo_meanLat ?geo_meanLon ?geo_meanElev </span>
<span class="s2">    ?paleoData_variableName ?paleoData_standardName ?paleoData_values ?paleoData_units </span>
<span class="s2">    ?paleoData_proxy ?paleoData_proxyGeneral ?paleoData_seasonality ?paleoData_interpName ?paleoData_interpRank </span>
<span class="s2">    ?TSID ?time_variableName ?time_standardName ?time_values</span>
<span class="s2">	?time_units where{</span>
<span class="s2">    </span>
<span class="s2">    ?ds a le:Dataset .</span>
<span class="s2">    ?ds le:hasName ?dataSetName .</span>

<span class="s2">    # Get the archive</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">            ?ds le:hasArchiveType ?archiveTypeObj .</span>
<span class="s2">            ?archiveTypeObj rdfs:label ?archiveType .</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">    # Geographical information    </span>
<span class="s2">    </span>
<span class="s2">    ?ds le:hasLocation ?loc .</span>
<span class="s2">        OPTIONAL{?loc wgs84:lat ?geo_meanLat .}</span>
<span class="s2">        OPTIONAL{?loc wgs84:long ?geo_meanLon .}      </span>
<span class="s2">        OPTIONAL{?loc wgs84:alt ?geo_meanElev .}</span>
<span class="s2">    </span>
<span class="s2">    # PaleoData</span>

<span class="s2">    ?ds le:hasPaleoData ?data .</span>
<span class="s2">    ?data le:hasMeasurementTable ?table .</span>
<span class="s2">    ?table le:hasVariable ?var .</span>

<span class="s2">    # Name</span>
<span class="s2">    ?var le:hasName ?paleoData_variableName .</span>
<span class="s2">    ?var le:hasStandardVariable ?variable_obj .</span>
<span class="s2">    ?variable_obj rdfs:label ?paleoData_standardName .</span>
<span class="s2">    </span>
<span class="s2">    #Values</span>
<span class="s2">    ?var le:hasValues ?paleoData_values .</span>

<span class="s2">    #Seasonality</span>
<span class="s2">    OPTIONAL{?var le:seasonality ?paleoData_seasonality} .</span>

<span class="s2">    #Units</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasUnits ?paleoData_unitsObj .</span>
<span class="s2">        ?paleoData_unitsObj rdfs:label ?paleoData_units .</span>
<span class="s2">    }</span>

<span class="s2">    #Proxy information</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasProxy ?paleoData_proxyObj .</span>
<span class="s2">        ?paleoData_proxyObj rdfs:label ?paleoData_proxy .</span>
<span class="s2">    }</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasProxyGeneral ?paleoData_proxyGeneralObj .</span>
<span class="s2">        ?paleoData_proxyGeneralObj rdfs:label ?paleoData_proxyGeneral .</span>
<span class="s2">    }</span>

<span class="s2">    # Compilation</span>
<span class="s2">    ?var le:partOfCompilation ?compilation . </span>
<span class="s2">    ?compilation le:hasName ?compilationName .</span>
<span class="s2">    FILTER (?compilationName = &quot;iso2k&quot;).</span>
<span class="s2">    ?var le:useInGlobalTemperatureAnalysis True .</span>

<span class="s2">    # TSiD (should all have them)</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasVariableId ?TSID</span>
<span class="s2">    } .</span>

<span class="s2">    # Interpretation (might be an optional field)</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>

<span class="s2">        ?interp le:hasVariable ?interpvar .</span>
<span class="s2">        BIND(REPLACE(STR(?interpvar), &quot;http://linked.earth/ontology/interpretation#&quot;, &quot;&quot;) AS ?interpretedVariable_Fallback)</span>
<span class="s2">        OPTIONAL { ?interpvar rdfs:label ?interpretedVariable_Label } # Use a temporary variable for the label</span>
<span class="s2">        BIND(COALESCE(?interpretedVariable_Label, ?interpretedVariable_Fallback) AS ?paleoData_interpName) # COALESCE into the final variable</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>
<span class="s2">        ?interp le:hasRank ?paleoData_interpRank .}</span>
<span class="s2">    </span>
<span class="s2">    </span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>
<span class="s2">    </span>
<span class="s2">        ?interp le:hasSeasonality ?seasonalityURI .</span>
<span class="s2">        BIND(REPLACE(STR(?seasonalityURI), &quot;http://linked.earth/ontology/interpretation#&quot;, &quot;&quot;) AS ?seasonality_Fallback)</span>
<span class="s2">        OPTIONAL { ?seasonalityURI rdfs:label ?seasonalityLabel }</span>
<span class="s2">        BIND(COALESCE(?seasonalityLabel, ?seasonality_Fallback) AS ?paleoData_seasonality)</span>
<span class="s2">    }</span>

<span class="s2">    #Time information</span>
<span class="s2">    ?table le:hasVariable ?timevar .</span>
<span class="s2">    ?timevar le:hasName ?time_variableName .</span>
<span class="s2">    ?timevar le:hasStandardVariable ?timevar_obj .</span>
<span class="s2">    ?timevar_obj rdfs:label ?time_standardName .</span>
<span class="s2">    VALUES ?time_standardName {&quot;year&quot;} .</span>
<span class="s2">    ?timevar le:hasValues ?time_values .</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?timevar le:hasUnits ?time_unitsObj .</span>
<span class="s2">        ?time_unitsObj rdfs:label ?time_units .</span>
<span class="s2">    }  </span>
<span class="s2">}&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qres</span><span class="p">,</span> <span class="n">df_iso2k</span> <span class="o">=</span> <span class="n">D_iso2k</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_iso</span><span class="p">)</span>
<span class="n">df_iso2k</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>paleoData_proxy</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>LS16STCL</td>
      <td>iso2k</td>
      <td>Lake sediment</td>
      <td>50.830</td>
      <td>-116.39</td>
      <td>1126.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-7.81, -5.91, -9.03, -5.35, -5.61, -5.98, -5....</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>Winter</td>
      <td>effectivePrecipitation</td>
      <td>NaN</td>
      <td>LPD7dc5b9ba-dup-dup</td>
      <td>year</td>
      <td>year</td>
      <td>[2009.0, 2008.3, 2007.8, 2007.4, 2007.0, 2006....</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>1</th>
      <td>LS16STCL</td>
      <td>iso2k</td>
      <td>Lake sediment</td>
      <td>50.830</td>
      <td>-116.39</td>
      <td>1126.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-7.81, -5.91, -9.03, -5.35, -5.61, -5.98, -5....</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>None</td>
      <td>effectivePrecipitation</td>
      <td>3.0</td>
      <td>LPD7dc5b9ba-dup-dup</td>
      <td>year</td>
      <td>year</td>
      <td>[2009.0, 2008.3, 2007.8, 2007.4, 2007.0, 2006....</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CO00URMA</td>
      <td>iso2k</td>
      <td>Coral</td>
      <td>0.933</td>
      <td>173.00</td>
      <td>6.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.8011, -4.725, -4.6994, -4.86, -5.0886, -5....</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>1.0</td>
      <td>Ocean2kHR_177_iso2k</td>
      <td>year</td>
      <td>year</td>
      <td>[1994.5, 1994.33, 1994.17, 1994.0, 1993.83, 19...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>3</th>
      <td>CO00URMA</td>
      <td>iso2k</td>
      <td>Coral</td>
      <td>0.933</td>
      <td>173.00</td>
      <td>6.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.8011, -4.725, -4.6994, -4.86, -5.0886, -5....</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>1.0</td>
      <td>Ocean2kHR_177_iso2k</td>
      <td>year</td>
      <td>year</td>
      <td>[1994.5, 1994.33, 1994.17, 1994.0, 1993.83, 19...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>4</th>
      <td>CO00URMA</td>
      <td>iso2k</td>
      <td>Coral</td>
      <td>0.933</td>
      <td>173.00</td>
      <td>6.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.8011, -4.725, -4.6994, -4.86, -5.0886, -5....</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>1.0</td>
      <td>Ocean2kHR_177_iso2k</td>
      <td>year</td>
      <td>year</td>
      <td>[1994.5, 1994.33, 1994.17, 1994.0, 1993.83, 19...</td>
      <td>yr AD</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_iso2k</span><span class="p">[</span><span class="s1">&#39;paleoData_interpName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;effectivePrecipitation&#39;, &#39;temperature&#39;, &#39;seawaterIsotope&#39;,
       &#39;precipitationIsotope&#39;, &#39;hydrologicBalance&#39;, &#39;salinity&#39;],
      dtype=object)
</pre></div>
</div>
</div>
</div>
<p>Despite using the <code class="docutils literal notranslate"><span class="pre">useinGlobalTemperatureAnalysis</span></code> flag, there seems to be more than 1 interpretation for several of the variables. Let’s first filer for interpretation associated with temperature and remove duplicate entries based on TSiD:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_iso2k_filt</span> <span class="o">=</span> <span class="n">df_iso2k</span><span class="p">[</span><span class="n">df_iso2k</span><span class="p">[</span><span class="s1">&#39;paleoData_interpName&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;TSID&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
<span class="n">df_iso2k_filt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>paleoData_proxy</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>CO00URMA</td>
      <td>iso2k</td>
      <td>Coral</td>
      <td>0.9330</td>
      <td>173.0000</td>
      <td>6.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.8011, -4.725, -4.6994, -4.86, -5.0886, -5....</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>1.0</td>
      <td>Ocean2kHR_177_iso2k</td>
      <td>year</td>
      <td>year</td>
      <td>[1994.5, 1994.33, 1994.17, 1994.0, 1993.83, 19...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>11</th>
      <td>CO05KUBE</td>
      <td>iso2k</td>
      <td>Coral</td>
      <td>32.4670</td>
      <td>-64.7000</td>
      <td>-12.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.15, -3.66, -3.69, -4.07, -3.95, -4.12, -3....</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>1.0</td>
      <td>Ocean2kHR_105_iso2k</td>
      <td>year</td>
      <td>year</td>
      <td>[1983.21, 1983.13, 1983.04, 1982.96, 1982.88, ...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>13</th>
      <td>IC13THQU</td>
      <td>iso2k</td>
      <td>Glacier ice</td>
      <td>-13.9333</td>
      <td>-70.8333</td>
      <td>5670.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-18.5905, -16.3244, -16.2324, -17.0112, -18.6...</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>Winter</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>SAm_035_iso2k</td>
      <td>year</td>
      <td>year</td>
      <td>[2009, 2008, 2007, 2006, 2005, 2004, 2003, 200...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>15</th>
      <td>CO01TUNG</td>
      <td>iso2k</td>
      <td>Coral</td>
      <td>-5.2170</td>
      <td>145.8170</td>
      <td>-3.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.875, -4.981, -5.166, -5.06, -4.942, -4.919...</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Ocean2kHR_141_iso2k</td>
      <td>year</td>
      <td>year</td>
      <td>[1993.042, 1992.792, 1992.542, 1992.292, 1992....</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>19</th>
      <td>CO01TUNG</td>
      <td>iso2k</td>
      <td>Coral</td>
      <td>-5.2170</td>
      <td>145.8170</td>
      <td>-3.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.827, -4.786, -4.693, -4.852, -4.991, -4.90...</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>1.0</td>
      <td>Ocean2kHR_140_iso2k</td>
      <td>year</td>
      <td>year</td>
      <td>[1993.042, 1992.792, 1992.542, 1992.292, 1992....</td>
      <td>yr AD</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_iso2k_filt</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 49 entries, 2 to 155
Data columns (total 20 columns):
 #   Column                  Non-Null Count  Dtype  
---  ------                  --------------  -----  
 0   dataSetName             49 non-null     object 
 1   compilationName         49 non-null     object 
 2   archiveType             49 non-null     object 
 3   geo_meanLat             49 non-null     float64
 4   geo_meanLon             49 non-null     float64
 5   geo_meanElev            49 non-null     float64
 6   paleoData_variableName  49 non-null     object 
 7   paleoData_standardName  49 non-null     object 
 8   paleoData_values        49 non-null     object 
 9   paleoData_units         49 non-null     object 
 10  paleoData_proxy         49 non-null     object 
 11  paleoData_proxyGeneral  0 non-null      object 
 12  paleoData_seasonality   39 non-null     object 
 13  paleoData_interpName    49 non-null     object 
 14  paleoData_interpRank    24 non-null     float64
 15  TSID                    49 non-null     object 
 16  time_variableName       49 non-null     object 
 17  time_standardName       49 non-null     object 
 18  time_values             49 non-null     object 
 19  time_units              49 non-null     object 
dtypes: float64(4), object(16)
memory usage: 8.0+ KB
</pre></div>
</div>
</div>
</div>
<p>We have 49 entries left in the iso2k database.</p>
</section>
<section id="coralhydro2k">
<h3>CoralHydro2k<a class="headerlink" href="#coralhydro2k" title="Link to this heading">#</a></h3>
<p>Let’s repeat our filtering. The <code class="docutils literal notranslate"><span class="pre">CoralHydro2k</span></code> database does not have a property indicating whether to use in temperature analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D_coral2k</span> <span class="o">=</span> <span class="n">LiPD</span><span class="p">()</span>
<span class="n">D_coral2k</span><span class="o">.</span><span class="n">load_from_dir</span><span class="p">(</span><span class="s1">&#39;./data/coral2k&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading 179 LiPD files
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 179/179 [00:02&lt;00:00, 88.65it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded..
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_coral</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; PREFIX le: &lt;http://linked.earth/ontology#&gt;</span>
<span class="s2">PREFIX wgs84: &lt;http://www.w3.org/2003/01/geo/wgs84_pos#&gt;</span>
<span class="s2">PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span>

<span class="s2">SELECT ?dataSetName ?compilationName ?archiveType ?geo_meanLat ?geo_meanLon ?geo_meanElev </span>
<span class="s2">    ?paleoData_variableName ?paleoData_standardName ?paleoData_values ?paleoData_units </span>
<span class="s2">    ?paleoData_proxy ?paleoData_proxyGeneral ?paleoData_seasonality ?paleoData_interpName ?paleoData_interpRank </span>
<span class="s2">    ?TSID ?time_variableName ?time_standardName ?time_values</span>
<span class="s2">	?time_units where{</span>
<span class="s2">    </span>
<span class="s2">    ?ds a le:Dataset .</span>
<span class="s2">    ?ds le:hasName ?dataSetName .</span>

<span class="s2">    # Get the archive</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">            ?ds le:hasArchiveType ?archiveTypeObj .</span>
<span class="s2">            ?archiveTypeObj rdfs:label ?archiveType .</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">    # Geographical information    </span>
<span class="s2">    </span>
<span class="s2">    ?ds le:hasLocation ?loc .</span>
<span class="s2">        OPTIONAL{?loc wgs84:lat ?geo_meanLat .}</span>
<span class="s2">        OPTIONAL{?loc wgs84:long ?geo_meanLon .}      </span>
<span class="s2">        OPTIONAL{?loc wgs84:alt ?geo_meanElev .}</span>
<span class="s2">    </span>
<span class="s2">    # PaleoData</span>

<span class="s2">    ?ds le:hasPaleoData ?data .</span>
<span class="s2">    ?data le:hasMeasurementTable ?table .</span>
<span class="s2">    ?table le:hasVariable ?var .</span>

<span class="s2">    # Name</span>
<span class="s2">    ?var le:hasName ?paleoData_variableName .</span>
<span class="s2">    ?var le:hasStandardVariable ?variable_obj .</span>
<span class="s2">    ?variable_obj rdfs:label ?paleoData_standardName .</span>
<span class="s2">    </span>
<span class="s2">    #Values</span>
<span class="s2">    ?var le:hasValues ?paleoData_values .</span>

<span class="s2">    #Seasonality</span>
<span class="s2">    OPTIONAL{?var le:seasonality ?paleoData_seasonality} .</span>

<span class="s2">    #Units</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasUnits ?paleoData_unitsObj .</span>
<span class="s2">        ?paleoData_unitsObj rdfs:label ?paleoData_units .</span>
<span class="s2">    }</span>

<span class="s2">    #Proxy information</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasProxy ?paleoData_proxyObj .</span>
<span class="s2">        ?paleoData_proxyObj rdfs:label ?paleoData_proxy .</span>
<span class="s2">    }</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasProxyGeneral ?paleoData_proxyGeneralObj .</span>
<span class="s2">        ?paleoData_proxyGeneralObj rdfs:label ?paleoData_proxyGeneral .</span>
<span class="s2">    }</span>

<span class="s2">    # Compilation</span>
<span class="s2">    ?var le:partOfCompilation ?compilation . </span>
<span class="s2">    ?compilation le:hasName ?compilationName .</span>
<span class="s2">    FILTER (?compilationName = &quot;CoralHydro2k&quot;).</span>


<span class="s2">    # TSiD (should all have them)</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasVariableId ?TSID</span>
<span class="s2">    } .</span>

<span class="s2">    # Interpretation (might be an optional field)</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>

<span class="s2">        ?interp le:hasVariable ?interpvar .</span>
<span class="s2">        BIND(REPLACE(STR(?interpvar), &quot;http://linked.earth/ontology/interpretation#&quot;, &quot;&quot;) AS ?interpretedVariable_Fallback)</span>
<span class="s2">        OPTIONAL { ?interpvar rdfs:label ?interpretedVariable_Label } # Use a temporary variable for the label</span>
<span class="s2">        BIND(COALESCE(?interpretedVariable_Label, ?interpretedVariable_Fallback) AS ?paleoData_interpName) # COALESCE into the final variable</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>
<span class="s2">        ?interp le:hasRank ?paleoData_interpRank .}</span>
<span class="s2">    </span>
<span class="s2">    </span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>
<span class="s2">    </span>
<span class="s2">        ?interp le:hasSeasonality ?seasonalityURI .</span>
<span class="s2">        BIND(REPLACE(STR(?seasonalityURI), &quot;http://linked.earth/ontology/interpretation#&quot;, &quot;&quot;) AS ?seasonality_Fallback)</span>
<span class="s2">        OPTIONAL { ?seasonalityURI rdfs:label ?seasonalityLabel }</span>
<span class="s2">        BIND(COALESCE(?seasonalityLabel, ?seasonality_Fallback) AS ?paleoData_seasonality)</span>
<span class="s2">    }</span>

<span class="s2">    #Time information</span>
<span class="s2">    ?table le:hasVariable ?timevar .</span>
<span class="s2">    ?timevar le:hasName ?time_variableName .</span>
<span class="s2">    ?timevar le:hasStandardVariable ?timevar_obj .</span>
<span class="s2">    ?timevar_obj rdfs:label ?time_standardName .</span>
<span class="s2">    VALUES ?time_standardName {&quot;year&quot;} .</span>
<span class="s2">    ?timevar le:hasValues ?time_values .</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?timevar le:hasUnits ?time_unitsObj .</span>
<span class="s2">        ?time_unitsObj rdfs:label ?time_units .</span>
<span class="s2">    }  </span>
<span class="s2">}&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qres</span><span class="p">,</span> <span class="n">df_coral2k</span> <span class="o">=</span> <span class="n">D_coral2k</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_coral</span><span class="p">)</span>
<span class="n">df_coral2k</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>paleoData_proxy</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>KA17RYU01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>28.300</td>
      <td>130.000</td>
      <td>-3.5</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[8.802, 9.472, 8.825, 9.355, 8.952, 9.297, 8.8...</td>
      <td>mmol/mol</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>KA17RYU01_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1578.58, 1579.08, 1579.58, 1580.08, 1580.58, ...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>1</th>
      <td>CH18YOA02</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>16.448</td>
      <td>111.605</td>
      <td>NA</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[8.58, 8.683, 8.609, 8.37, 8.38, 8.417, 8.584,...</td>
      <td>mmol/mol</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>CH18YOA02_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1987.92, 1988.085, 1988.25, 1988.42, 1988.585...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>2</th>
      <td>FL17DTO02</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>24.699</td>
      <td>-82.799</td>
      <td>-3.0</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[9.159, 9.257, 9.245, 9.166, 9.045, 9.013, 8.9...</td>
      <td>mmol/mol</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>FL17DTO02_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1837.04, 1837.13, 1837.21, 1837.29, 1837.38, ...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BO14HTI01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>12.210</td>
      <td>109.310</td>
      <td>-3.6</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-5.4206, -5.3477, -5.1354, -5.7119, -5.9058, ...</td>
      <td>permil</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>BO14HTI01_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1977.37, 1977.45, 1977.54, 1977.62, 1977.7, 1...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>4</th>
      <td>BO14HTI01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>12.210</td>
      <td>109.310</td>
      <td>-3.6</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[9.2, 9.17, 9.11, 9.02, 8.95, 8.99, 9.06, 9.1,...</td>
      <td>mmol/mol</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>BO14HTI01_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1600.04, 1600.12, 1600.2, 1600.28, 1600.37, 1...</td>
      <td>yr AD</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Since there is no interpretation objects to go by, let’s have a look at the names of the variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_coral2k</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;SrCa&#39;, &#39;d18O&#39;, &#39;d18O_sw&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<p>Sr/Ca is usually interpreted as a temperature proxy. d18O contains information about both temperature and d18Osw. Let’s keep these two and drop any duplicates as identified by TSiDs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_coral2k_filt</span> <span class="o">=</span> <span class="n">df_coral2k</span><span class="p">[</span><span class="n">df_coral2k</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;SrCa&#39;</span><span class="p">,</span> <span class="s1">&#39;d18O&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;TSID&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
<span class="n">df_coral2k_filt</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>paleoData_proxy</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>KA17RYU01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>28.300</td>
      <td>130.000</td>
      <td>-3.5</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[8.802, 9.472, 8.825, 9.355, 8.952, 9.297, 8.8...</td>
      <td>mmol/mol</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>KA17RYU01_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1578.58, 1579.08, 1579.58, 1580.08, 1580.58, ...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>1</th>
      <td>CH18YOA02</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>16.448</td>
      <td>111.605</td>
      <td>NA</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[8.58, 8.683, 8.609, 8.37, 8.38, 8.417, 8.584,...</td>
      <td>mmol/mol</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>CH18YOA02_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1987.92, 1988.085, 1988.25, 1988.42, 1988.585...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>2</th>
      <td>FL17DTO02</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>24.699</td>
      <td>-82.799</td>
      <td>-3.0</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[9.159, 9.257, 9.245, 9.166, 9.045, 9.013, 8.9...</td>
      <td>mmol/mol</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>FL17DTO02_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1837.04, 1837.13, 1837.21, 1837.29, 1837.38, ...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BO14HTI01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>12.210</td>
      <td>109.310</td>
      <td>-3.6</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-5.4206, -5.3477, -5.1354, -5.7119, -5.9058, ...</td>
      <td>permil</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>BO14HTI01_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1977.37, 1977.45, 1977.54, 1977.62, 1977.7, 1...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>4</th>
      <td>BO14HTI01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>12.210</td>
      <td>109.310</td>
      <td>-3.6</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[9.2, 9.17, 9.11, 9.02, 8.95, 8.99, 9.06, 9.1,...</td>
      <td>mmol/mol</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>BO14HTI01_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1600.04, 1600.12, 1600.2, 1600.28, 1600.37, 1...</td>
      <td>yr AD</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_coral2k_filt</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 233 entries, 0 to 251
Data columns (total 20 columns):
 #   Column                  Non-Null Count  Dtype  
---  ------                  --------------  -----  
 0   dataSetName             233 non-null    object 
 1   compilationName         233 non-null    object 
 2   archiveType             233 non-null    object 
 3   geo_meanLat             233 non-null    float64
 4   geo_meanLon             233 non-null    float64
 5   geo_meanElev            232 non-null    object 
 6   paleoData_variableName  233 non-null    object 
 7   paleoData_standardName  233 non-null    object 
 8   paleoData_values        233 non-null    object 
 9   paleoData_units         233 non-null    object 
 10  paleoData_proxy         0 non-null      object 
 11  paleoData_proxyGeneral  0 non-null      object 
 12  paleoData_seasonality   0 non-null      object 
 13  paleoData_interpName    0 non-null      object 
 14  paleoData_interpRank    0 non-null      object 
 15  TSID                    233 non-null    object 
 16  time_variableName       233 non-null    object 
 17  time_standardName       233 non-null    object 
 18  time_values             233 non-null    object 
 19  time_units              233 non-null    object 
dtypes: float64(2), object(18)
memory usage: 38.2+ KB
</pre></div>
</div>
</div>
</div>
<p>This database adds 233 new records.</p>
</section>
<section id="database-assemble">
<h3>DataBase: Assemble!<a class="headerlink" href="#database-assemble" title="Link to this heading">#</a></h3>
<p>Let’s concatenate the three DataFrames into a clean database, dropping timeseries with the same TSiD as we go. Let’s also convert the values to <code class="docutils literal notranslate"><span class="pre">numpy.array</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_pages2k</span><span class="p">,</span> <span class="n">df_iso2k_filt</span><span class="p">,</span> <span class="n">df_coral2k_filt</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;TSID&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
<span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span> <span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">row</span><span class="p">)</span>
<span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span> <span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">row</span><span class="p">)</span>
<span class="n">df_raw</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 972 entries, 0 to 972
Data columns (total 20 columns):
 #   Column                  Non-Null Count  Dtype  
---  ------                  --------------  -----  
 0   dataSetName             972 non-null    object 
 1   compilationName         972 non-null    object 
 2   archiveType             972 non-null    object 
 3   geo_meanLat             972 non-null    float64
 4   geo_meanLon             972 non-null    float64
 5   geo_meanElev            964 non-null    object 
 6   paleoData_variableName  972 non-null    object 
 7   paleoData_standardName  972 non-null    object 
 8   paleoData_values        972 non-null    object 
 9   paleoData_units         564 non-null    object 
 10  paleoData_proxy         739 non-null    object 
 11  paleoData_proxyGeneral  500 non-null    object 
 12  paleoData_seasonality   729 non-null    object 
 13  paleoData_interpName    739 non-null    object 
 14  paleoData_interpRank    24 non-null     float64
 15  TSID                    972 non-null    object 
 16  time_variableName       972 non-null    object 
 17  time_standardName       972 non-null    object 
 18  time_values             972 non-null    object 
 19  time_units              972 non-null    object 
dtypes: float64(3), object(17)
memory usage: 159.5+ KB
</pre></div>
</div>
</div>
</div>
<p>We have 972 timeseries before any further pre-processing.</p>
<section id="special-handling-the-palmyra-record">
<h4>Special handling: The Palmyra record<a class="headerlink" href="#special-handling-the-palmyra-record" title="Link to this heading">#</a></h4>
<p>The Palmyra Coral record in these databases may not have been updated with the latest changes published by <a class="reference external" href="https://www.science.org/doi/10.1126/science.aax2000">Dee et al. (2020)</a>. Let’s open this record and extract the same information:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">palm</span> <span class="o">=</span> <span class="n">LiPD</span><span class="p">()</span>
<span class="n">palm</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;./data/Palmyra.Dee.2020.lpd&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading 1 LiPD files
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [00:00&lt;00:00,  9.18it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded..
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_palm</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">PREFIX le: &lt;http://linked.earth/ontology#&gt;</span>
<span class="s2">PREFIX wgs84: &lt;http://www.w3.org/2003/01/geo/wgs84_pos#&gt;</span>
<span class="s2">PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span>

<span class="s2">SELECT ?dataSetName ?compilationName ?archiveType ?geo_meanLat ?geo_meanLon ?geo_meanElev </span>
<span class="s2">    ?paleoData_variableName ?paleoData_standardName ?paleoData_values ?paleoData_units </span>
<span class="s2">    ?paleoData_proxy ?paleoData_proxyGeneral ?paleoData_seasonality ?paleoData_interpName ?paleoData_interpRank </span>
<span class="s2">    ?TSID ?time_variableName ?time_standardName ?time_values</span>
<span class="s2">	?time_units where{</span>
<span class="s2">    </span>
<span class="s2">    ?ds a le:Dataset .</span>
<span class="s2">    ?ds le:hasName ?dataSetName .</span>

<span class="s2">    # Get the archive</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">            ?ds le:hasArchiveType ?archiveTypeObj .</span>
<span class="s2">            ?archiveTypeObj rdfs:label ?archiveType .</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">    # Geographical information    </span>
<span class="s2">    </span>
<span class="s2">    ?ds le:hasLocation ?loc .</span>
<span class="s2">        OPTIONAL{?loc wgs84:lat ?geo_meanLat .}</span>
<span class="s2">        OPTIONAL{?loc wgs84:long ?geo_meanLon .}      </span>
<span class="s2">        OPTIONAL{?loc wgs84:alt ?geo_meanElev .}</span>
<span class="s2">    </span>
<span class="s2">    # PaleoData</span>

<span class="s2">    ?ds le:hasPaleoData ?data .</span>
<span class="s2">    ?data le:hasMeasurementTable ?table .</span>
<span class="s2">    ?table le:hasVariable ?var .</span>

<span class="s2">    # Name</span>
<span class="s2">    ?var le:hasName ?paleoData_variableName .</span>
<span class="s2">    ?var le:hasStandardVariable ?variable_obj .</span>
<span class="s2">    ?variable_obj rdfs:label ?paleoData_standardName .</span>
<span class="s2">    </span>
<span class="s2">    #Values</span>
<span class="s2">    ?var le:hasValues ?paleoData_values .</span>

<span class="s2">    #Units</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasUnits ?paleoData_unitsObj .</span>
<span class="s2">        ?paleoData_unitsObj rdfs:label ?paleoData_units .</span>
<span class="s2">    }</span>

<span class="s2">    #Proxy information</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasProxy ?paleoData_proxyObj .</span>
<span class="s2">        ?paleoData_proxyObj rdfs:label ?paleoData_proxy .</span>
<span class="s2">    }</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasProxyGeneral ?paleoData_proxyGeneralObj .</span>
<span class="s2">        ?paleoData_proxyGeneralObj rdfs:label ?paleoData_proxyGeneral .</span>
<span class="s2">    }</span>

<span class="s2">    # Compilation</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">    ?var le:partOfCompilation ?compilation . </span>
<span class="s2">    ?compilation le:hasName ?compilationName .}</span>


<span class="s2">    # TSiD (should all have them)</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasVariableId ?TSID</span>
<span class="s2">    } .</span>

<span class="s2">    # Interpretation (might be an optional field)</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>

<span class="s2">        ?interp le:hasVariable ?interpvar .</span>
<span class="s2">        BIND(REPLACE(STR(?interpvar), &quot;http://linked.earth/ontology/interpretation#&quot;, &quot;&quot;) AS ?interpretedVariable_Fallback)</span>
<span class="s2">        OPTIONAL { ?interpvar rdfs:label ?interpretedVariable_Label } # Use a temporary variable for the label</span>
<span class="s2">        BIND(COALESCE(?interpretedVariable_Label, ?interpretedVariable_Fallback) AS ?paleoData_interpName) # COALESCE into the final variable</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>
<span class="s2">        ?interp le:hasRank ?paleoData_interpRank .}</span>
<span class="s2">    </span>
<span class="s2">    </span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?var le:hasInterpretation ?interp .</span>
<span class="s2">    </span>
<span class="s2">        ?interp le:hasSeasonality ?seasonalityURI .</span>
<span class="s2">        BIND(REPLACE(STR(?seasonalityURI), &quot;http://linked.earth/ontology/interpretation#&quot;, &quot;&quot;) AS ?seasonality_Fallback)</span>
<span class="s2">        OPTIONAL { ?seasonalityURI rdfs:label ?seasonalityLabel }</span>
<span class="s2">        BIND(COALESCE(?seasonalityLabel, ?seasonality_Fallback) AS ?paleoData_seasonality)</span>
<span class="s2">    }</span>

<span class="s2">    #Time information</span>
<span class="s2">    ?table le:hasVariable ?timevar .</span>
<span class="s2">    ?timevar le:hasName ?time_variableName .</span>
<span class="s2">    ?timevar le:hasStandardVariable ?timevar_obj .</span>
<span class="s2">    ?timevar_obj rdfs:label ?time_standardName .</span>
<span class="s2">    VALUES ?time_standardName {&quot;year&quot;} .</span>
<span class="s2">    ?timevar le:hasValues ?time_values .</span>
<span class="s2">    OPTIONAL{</span>
<span class="s2">        ?timevar le:hasUnits ?time_unitsObj .</span>
<span class="s2">        ?time_unitsObj rdfs:label ?time_units .</span>
<span class="s2">    }  </span>
<span class="s2">}&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qres</span><span class="p">,</span> <span class="n">df_palm</span> <span class="o">=</span> <span class="n">palm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query_palm</span><span class="p">)</span>
<span class="n">df_palm</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>paleoData_proxy</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Palmyra.Dee.2020</td>
      <td>None</td>
      <td>Coral</td>
      <td>5.8664</td>
      <td>-162.12</td>
      <td>-9.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.749, -4.672, -4.724, -4.717, -4.8947, -4.8...</td>
      <td>permil</td>
      <td>d18O</td>
      <td>isotopic</td>
      <td>subannual</td>
      <td>seawaterIsotope</td>
      <td>1.0</td>
      <td>PCU-1cce3af5639a4ec</td>
      <td>year</td>
      <td>year</td>
      <td>[1146.375, 1146.4583, 1146.5417, 1146.625, 114...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Palmyra.Dee.2020</td>
      <td>None</td>
      <td>Coral</td>
      <td>5.8664</td>
      <td>-162.12</td>
      <td>-9.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.749, -4.672, -4.724, -4.717, -4.8947, -4.8...</td>
      <td>permil</td>
      <td>d18O</td>
      <td>isotopic</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>PCU-1cce3af5639a4ec</td>
      <td>year</td>
      <td>year</td>
      <td>[1146.375, 1146.4583, 1146.5417, 1146.625, 114...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Palmyra.Dee.2020</td>
      <td>None</td>
      <td>Coral</td>
      <td>5.8664</td>
      <td>-162.12</td>
      <td>-9.0</td>
      <td>year</td>
      <td>year</td>
      <td>[1146.375, 1146.4583, 1146.5417, 1146.625, 114...</td>
      <td>yr AD</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>PCU-45b2ff49e3944f1</td>
      <td>year</td>
      <td>year</td>
      <td>[1146.375, 1146.4583, 1146.5417, 1146.625, 114...</td>
      <td>yr AD</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s keep the variable associated with the temperature interpretation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_palm_filt</span> <span class="o">=</span> <span class="n">df_palm</span><span class="p">[</span><span class="n">df_palm</span><span class="p">[</span><span class="s1">&#39;paleoData_interpName&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span>
<span class="n">df_palm_filt</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>paleoData_proxy</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>Palmyra.Dee.2020</td>
      <td>None</td>
      <td>Coral</td>
      <td>5.8664</td>
      <td>-162.12</td>
      <td>-9.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.749, -4.672, -4.724, -4.717, -4.8947, -4.8...</td>
      <td>permil</td>
      <td>d18O</td>
      <td>isotopic</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>PCU-1cce3af5639a4ec</td>
      <td>year</td>
      <td>year</td>
      <td>[1146.375, 1146.4583, 1146.5417, 1146.625, 114...</td>
      <td>yr AD</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s make sure that all the values are converted from string:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span> <span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">row</span><span class="p">)</span>
<span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span> <span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="handling-duplication-sr-ca">
<h5>Handling duplication: Sr/Ca<a class="headerlink" href="#handling-duplication-sr-ca" title="Link to this heading">#</a></h5>
<p>Now, let’s find the entry(ies) within PAGES2k corresponding to the Palmyra record. To do so, let’s find all the records within 50km:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Earth&#39;s radius in kilometers</span>
<span class="n">R</span> <span class="o">=</span> <span class="mf">6371.0</span>

<span class="c1"># Threshold</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1">#Look for all records within threshold km</span>

<span class="c1"># Target location</span>
<span class="n">target_lat</span> <span class="o">=</span> <span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">target_lon</span> <span class="o">=</span> <span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Convert degrees to radians</span>
<span class="n">lat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">target_lat</span><span class="p">)</span>
<span class="n">lon1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">target_lon</span><span class="p">)</span>
<span class="n">lat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">])</span>
<span class="n">lon2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">])</span>

<span class="c1"># Haversine formula</span>
<span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span>
<span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
<span class="n">distance_km</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c</span>

<span class="c1"># Add distance column</span>
<span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_km</span>

<span class="c1"># Filter to only rows within 50 km</span>
<span class="n">df_distance</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_distance</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>...</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
      <th>distance_km</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Ocn-Palmyra.Nurhati.2011</td>
      <td>Pages2kTemperature</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>-10.0</td>
      <td>Sr/Ca</td>
      <td>Sr/Ca</td>
      <td>[8.96, 8.9, 8.91, 8.94, 8.92, 8.89, 8.87, 8.81...</td>
      <td>mmol/mol</td>
      <td>...</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Ocean2kHR_161</td>
      <td>year</td>
      <td>year</td>
      <td>[1998.29, 1998.21, 1998.13, 1998.04, 1997.96, ...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ocn-Palmyra.Cobb.2013</td>
      <td>Pages2kTemperature</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>-7.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.651, -4.631, -4.629, -4.562, -4.58, -4.442...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Ocean2kHR_139</td>
      <td>year</td>
      <td>year</td>
      <td>[928.125, 928.209, 928.292, 928.375, 928.459, ...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CO03COPM</td>
      <td>iso2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>-7.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-5.27, -5.42, -5.49, -5.5, -5.44, -5.48, -5.5...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Ocean2kHR_139_iso2k</td>
      <td>year</td>
      <td>year</td>
      <td>[1998.37, 1998.29, 1998.2, 1998.13, 1998.04, 1...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>3</th>
      <td>NU11PAL01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.867</td>
      <td>-162.133</td>
      <td>-9.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.79, -4.89, -4.81, -4.84, -4.85, -4.82, -4....</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NU11PAL01_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1886.13, 1886.21, 1886.29, 1886.38, 1886.46, ...</td>
      <td>yr AD</td>
      <td>1.439510</td>
    </tr>
    <tr>
      <th>4</th>
      <td>NU11PAL01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.867</td>
      <td>-162.133</td>
      <td>-9.0</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[9.01, 9.02, 8.98, 8.99, 9.0, 8.99, 9.0, 9.11,...</td>
      <td>mmol/mol</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NU11PAL01_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1886.13, 1886.21, 1886.29, 1886.38, 1886.46, ...</td>
      <td>yr AD</td>
      <td>1.439510</td>
    </tr>
    <tr>
      <th>5</th>
      <td>SA19PAL01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.878</td>
      <td>-162.142</td>
      <td>-10.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-5.21, -5.23, -5.17, -5.13, -5.11, -5.05, -5....</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>SA19PAL01_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1983.58, 1983.67, 1983.75, 1983.83, 1983.92, ...</td>
      <td>yr AD</td>
      <td>2.754166</td>
    </tr>
    <tr>
      <th>6</th>
      <td>SA19PAL01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.878</td>
      <td>-162.142</td>
      <td>-10.0</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[8.94, 9.08, 9.17, 9.16, 9.16, 9.17, 9.17, 9.1...</td>
      <td>mmol/mol</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>SA19PAL01_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1980.75, 1980.83, 1980.92, 1981.0, 1981.08, 1...</td>
      <td>yr AD</td>
      <td>2.754166</td>
    </tr>
    <tr>
      <th>7</th>
      <td>SA19PAL02</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.878</td>
      <td>-162.142</td>
      <td>-10.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-5.05, -5.1, -5.21, -5.14, -5.23, -5.32, -5.3...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>SA19PAL02_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1985.92, 1986.0, 1986.08, 1986.17, 1986.25, 1...</td>
      <td>yr AD</td>
      <td>2.754166</td>
    </tr>
    <tr>
      <th>8</th>
      <td>SA19PAL02</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.878</td>
      <td>-162.142</td>
      <td>-10.0</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[8.86, 8.82, 8.81, 8.85, 8.89, 8.87, 8.82, 8.8...</td>
      <td>mmol/mol</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>SA19PAL02_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1985.33, 1985.42, 1985.5, 1985.58, 1985.67, 1...</td>
      <td>yr AD</td>
      <td>2.754166</td>
    </tr>
    <tr>
      <th>9</th>
      <td>CO03PAL08</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>NA</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-5.14, -5.13, -5.13, -5.16, -5.28, -4.99, -4....</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>CO03PAL08_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1653.63, 1653.65, 1653.686083, 1653.722167, 1...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>10</th>
      <td>CO03PAL09</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>NA</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.98, -4.8, -4.68, -4.74, -4.7, -4.74, -4.84...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>CO03PAL09_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1664.96, 1665.0215, 1665.083, 1665.164, 1665....</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>11</th>
      <td>CO03PAL04</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>NA</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.86, -4.9, -5.0, -4.92, -4.91, -4.85, -4.74...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>CO03PAL04_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1398.68, 1398.747167, 1398.814333, 1398.8815,...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>12</th>
      <td>CO03PAL10</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>NA</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.865, -4.765, -4.805, -4.665, -4.595, -4.73...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>CO03PAL10_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1326.65, 1326.75825, 1326.8665, 1326.97475, 1...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>13</th>
      <td>CO03PAL05</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>NA</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.61, -4.64, -4.7, -4.77, -4.86, -4.85, -4.8...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>CO03PAL05_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1405.1569, 1405.280175, 1405.40345, 1405.5267...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>14</th>
      <td>CO03PAL07</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>NA</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.63, -4.55, -4.65, -4.59, -4.74, -4.79, -4....</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>CO03PAL07_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1635.02, 1635.083, 1635.146, 1635.209, 1635.2...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>15</th>
      <td>CO03PAL06</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>NA</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.64, -4.64, -4.62, -4.62, -4.68, -4.77, -4....</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>CO03PAL06_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1411.9262, 1412.0046, 1412.083, 1412.1775, 14...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>16</th>
      <td>CO03PAL02</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>NA</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.631, -4.724, -4.709, -4.707, -4.912, -4.83...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>CO03PAL02_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1149.08, 1149.2225, 1149.365, 1149.5075, 1149...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>17</th>
      <td>CO03PAL03</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>NA</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.79, -4.73, -4.66, -4.66, -4.78, -4.69, -4....</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>CO03PAL03_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1317.17, 1317.29, 1317.41, 1317.53, 1317.65, ...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>18</th>
      <td>CO03PAL01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>NA</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.68, -4.62, -4.65, -4.56, -4.58, -4.42, -4....</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>CO03PAL01_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[928.08, 928.175, 928.27, 928.365, 928.46, 928...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
  </tbody>
</table>
<p>19 rows × 21 columns</p>
</div></div></div>
</div>
<p>The first 18 rows seem to be corresponding to various coral heads within the Palmyra records. Let’s have a look at them. Let’s first have a look at Sr/Ca record:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_distance_SrCa</span> <span class="o">=</span> <span class="n">df_distance</span><span class="p">[</span><span class="n">df_distance</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;SrCa&#39;</span><span class="p">,</span> <span class="s1">&#39;Sr/Ca&#39;</span><span class="p">])]</span>
<span class="n">df_distance_SrCa</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>...</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
      <th>distance_km</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Ocn-Palmyra.Nurhati.2011</td>
      <td>Pages2kTemperature</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>-10.0</td>
      <td>Sr/Ca</td>
      <td>Sr/Ca</td>
      <td>[8.96, 8.9, 8.91, 8.94, 8.92, 8.89, 8.87, 8.81...</td>
      <td>mmol/mol</td>
      <td>...</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Ocean2kHR_161</td>
      <td>year</td>
      <td>year</td>
      <td>[1998.29, 1998.21, 1998.13, 1998.04, 1997.96, ...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>4</th>
      <td>NU11PAL01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.867</td>
      <td>-162.133</td>
      <td>-9.0</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[9.01, 9.02, 8.98, 8.99, 9.0, 8.99, 9.0, 9.11,...</td>
      <td>mmol/mol</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NU11PAL01_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1886.13, 1886.21, 1886.29, 1886.38, 1886.46, ...</td>
      <td>yr AD</td>
      <td>1.439510</td>
    </tr>
    <tr>
      <th>6</th>
      <td>SA19PAL01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.878</td>
      <td>-162.142</td>
      <td>-10.0</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[8.94, 9.08, 9.17, 9.16, 9.16, 9.17, 9.17, 9.1...</td>
      <td>mmol/mol</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>SA19PAL01_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1980.75, 1980.83, 1980.92, 1981.0, 1981.08, 1...</td>
      <td>yr AD</td>
      <td>2.754166</td>
    </tr>
    <tr>
      <th>8</th>
      <td>SA19PAL02</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.878</td>
      <td>-162.142</td>
      <td>-10.0</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[8.86, 8.82, 8.81, 8.85, 8.89, 8.87, 8.82, 8.8...</td>
      <td>mmol/mol</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>SA19PAL02_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1985.33, 1985.42, 1985.5, 1985.58, 1985.67, 1...</td>
      <td>yr AD</td>
      <td>2.754166</td>
    </tr>
  </tbody>
</table>
<p>4 rows × 21 columns</p>
</div></div></div>
</div>
<p>Let’s plot them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_distance_SrCa</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_proxy&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_proxy&#39;</span><span class="p">],</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">]</span>
    <span class="n">ts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyleo</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">],</span><span class="n">value</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span>
                            <span class="n">time_name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">],</span>
                            <span class="n">time_unit</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_units&#39;</span><span class="p">],</span> <span class="n">value_unit</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_units&#39;</span><span class="p">],</span>
                            <span class="n">lat</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">],</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">],</span> 
                            <span class="n">elevation</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanElev&#39;</span><span class="p">],</span> <span class="n">importedFrom</span><span class="o">=</span><span class="s1">&#39;lipdverse.org&#39;</span><span class="p">,</span>
                            <span class="n">archiveType</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">],</span>
                            <span class="n">observationType</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_proxy&#39;</span><span class="p">],</span>       
                            <span class="n">label</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">proxy</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span> 

<span class="n">mgs_srca</span> <span class="o">=</span> <span class="n">pyleo</span><span class="o">.</span><span class="n">MultipleGeoSeries</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span> 
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">mgs_srca</span><span class="o">.</span><span class="n">stackplot</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/c388ca6fc8d7e3de48d07e50ff1e017f7a7ef03b585e3137a3c695b217936e67.png" src="../../_images/c388ca6fc8d7e3de48d07e50ff1e017f7a7ef03b585e3137a3c695b217936e67.png" />
</div>
</div>
<p>The three records look very similar. The <code class="docutils literal notranslate"><span class="pre">Ocn-Palmyra.Nurhati.2011_Sr/Ca</span></code> and <code class="docutils literal notranslate"><span class="pre">NU11PAL01_SrCa</span></code> appear nearly identical. However, this may occur in other places in the database, so we want an algorithm to (1) find records that may be the same. We can follow a similar strategy as we have done here. a. Are they within 50km of each other and b. do they have the same or similar variable names, and (2) assess whether these records are, in fact, the same.</p>
<p>We can do this in several ways:</p>
<ul class="simple">
<li><p>Correlation: this may work well for true duplicates but may fail for composites</p></li>
<li><p>Dynamic Time Warping (DTW), which can be used to to assess shape similarity even when time points aren’t exactly aligned. DTW returns a distance metric: lower values mean more similar <a class="reference external" href="http://patterns.It">patterns.It</a> can be combined with a z-normalization to remove mean/variance effects.</p></li>
<li><p>Principal Component Analysis (PCA)/ On groups of nearby records, run PCA to detect if certain records contribute nearly identical structure to the same components. High loadings on the same component can suggest redundancy.</p></li>
</ul>
<p>Let’s have a look at these three options.</p>
<section id="option-1-correlation">
<h6>Option 1: Correlation<a class="headerlink" href="#option-1-correlation" title="Link to this heading">#</a></h6>
<p>Let’s use the <a class="reference external" href="https://pyleoclim-util.readthedocs.io/en/latest/core/api.html#pyleoclim.core.multipleseries.MultipleSeries.correlation">Pyleoclim <code class="docutils literal notranslate"><span class="pre">correlation</span></code> function</a>. The following code is inspired from <a class="reference external" href="https://linked.earth/PyleoTutorials/notebooks/L2_correlations.html">this tutorial</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mgs_srca</span><span class="o">.</span><span class="n">series_list</span><span class="p">)</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
<span class="n">corr_mat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1">#let&#39;s only work on half of the matrix to speeds things up</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># loop over records </span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">mgs_srca</span><span class="o">.</span><span class="n">series_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    
    <span class="n">mgsl</span> <span class="o">=</span> <span class="n">pyleo</span><span class="o">.</span><span class="n">MultipleGeoSeries</span><span class="p">(</span><span class="n">mgs_srca</span><span class="o">.</span><span class="n">series_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span> <span class="c1">#gather potential pairs</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">mgsl</span><span class="o">.</span><span class="n">correlation</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;built-in&#39;</span><span class="p">)</span> <span class="c1"># compute correlations</span>
    <span class="n">corr_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">r</span> <span class="c1"># save result in matrix</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 3 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 3/3 [00:00&lt;00:00, 193.66it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 2 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 2/2 [00:00&lt;00:00, 288.76it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 1 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [00:00&lt;00:00, 336.57it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mgs_srca</span><span class="o">.</span><span class="n">series_list</span><span class="p">:</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="n">core_matrix_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">core_matrix_df</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Correlation Heatmap&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/73989ced1bc723539b77f1632034d0c38580dc036bb6d4761675b7ddc86375f3.png" src="../../_images/73989ced1bc723539b77f1632034d0c38580dc036bb6d4761675b7ddc86375f3.png" />
</div>
</div>
<p>Unsurprisingly, <code class="docutils literal notranslate"><span class="pre">Ocn-Palmyra.Nurhati.2011_Sr/Ca</span></code> and <code class="docutils literal notranslate"><span class="pre">NU11PAL01_SrCa</span></code> have a correlation of 1 as they are essentially the same record. The other correlations are below 0.8, which makes it difficult to assess whether they are, in fact the same record. Let’s have a look at DTW as a potential discriminant.</p>
</section>
<section id="option-2-dynamic-time-wrapping">
<h6>Option 2: Dynamic Time Wrapping<a class="headerlink" href="#option-2-dynamic-time-wrapping" title="Link to this heading">#</a></h6>
<p>Dynamic Time Wrapping (DTW) is a distance metric designed to compare time series that may be misaligned in time or differ in length. Unlike traditional correlation-based methods, DTW allows for flexible, non-linear alignment of sequences by warping the time axis to minimize the total distance between corresponding points. In our context, DTW provides a more robust measure of similarity between records than correlation, especially when records are composites or partially overlapping. By restricting comparisons to shared time intervals and z-score normalizing the data to emphasize shape similarity, DTW helps identify potentially redundant or duplicated records while accounting for the complexities inherent in paleoenvironmental data.</p>
<p>The following cell does the following:</p>
<ul class="simple">
<li><p>Clip the timeseries for similar time range for comparison</p></li>
<li><p>Compute zscore</p></li>
<li><p>Compute the DTW distance</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Helper function: clip to overlapping time range and normalize ---</span>

<span class="k">def</span><span class="w"> </span><span class="nf">clip_to_overlap</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span> <span class="n">series1</span><span class="p">,</span> <span class="n">time2</span><span class="p">,</span> <span class="n">series2</span><span class="p">,</span> <span class="n">min_overlap</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">time1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">time1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">time2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">time1</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">time1</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="p">(</span><span class="n">time2</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">time2</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_overlap</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_overlap</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># Not enough overlapping points</span>
    
    <span class="k">return</span> <span class="n">zscore</span><span class="p">(</span><span class="n">series1</span><span class="p">[</span><span class="n">mask1</span><span class="p">]),</span> <span class="n">zscore</span><span class="p">(</span><span class="n">series2</span><span class="p">[</span><span class="n">mask2</span><span class="p">])</span>

<span class="c1"># --- Prepare the data ----</span>
<span class="n">records</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">mgs_srca</span><span class="o">.</span><span class="n">series_list</span><span class="p">:</span>
    <span class="n">records</span><span class="p">[</span><span class="n">series</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">value</span>
    <span class="n">times</span><span class="p">[</span><span class="n">series</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">time</span>


<span class="c1"># --- Main loop ---</span>
<span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">dtw_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">key_i</span><span class="p">,</span> <span class="n">key_j</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">clip_to_overlap</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">key_i</span><span class="p">],</span> <span class="n">records</span><span class="p">[</span><span class="n">key_i</span><span class="p">],</span>
                             <span class="n">times</span><span class="p">[</span><span class="n">key_j</span><span class="p">],</span> <span class="n">records</span><span class="p">[</span><span class="n">key_j</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">s1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">dtw</span><span class="o">.</span><span class="n">warping_path</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">dtw</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
        <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># Per-step normalization</span>

        <span class="n">dtw_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtw_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_dist</span>

<span class="c1"># Convert to DataFrame for visualization</span>
<span class="n">dtw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dtw_matrix</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize the results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">dtw_df</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dtw_df</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;DTW Distance Matrix (Clipped to Overlap)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f471fab3704dae64d775bd32ec3c269ae1ea433dbfd41ed2f79f8723d1030a92.png" src="../../_images/f471fab3704dae64d775bd32ec3c269ae1ea433dbfd41ed2f79f8723d1030a92.png" />
</div>
</div>
<p>The next problem lies in the interpretation of these results. The matrix holds pairwise DTW distances between time series. Each entry DTW[i, j] is a non-negative real number representing how similar two z-normalized time series are after optimal alignment.</p>
<ul class="simple">
<li><p>Lower values = more similar shape (after warping).</p></li>
<li><p>Higher values = less similar (more misaligned or different structure).</p></li>
</ul>
<p>Since we z-scored normalized the data and accounted for number of steps, the DTW distances can be interpreted as follows:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Normalized DTW</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>0.0 – 0.1</strong></p></td>
<td><p>Very similar shape — likely same core or duplicated segment</p></td>
</tr>
<tr class="row-odd"><td><p><strong>0.1 – 0.2</strong></p></td>
<td><p>High similarity — possibly same site, maybe overlapping or composited</p></td>
</tr>
<tr class="row-even"><td><p><strong>0.2 – 0.4</strong></p></td>
<td><p>Moderate similarity — same region, but different signal characteristics</p></td>
</tr>
<tr class="row-odd"><td><p><strong>&gt; 0.4</strong></p></td>
<td><p>Different shape — likely independent records</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="option-3-principal-component-analysis">
<h6>Option 3: Principal Component Analysis<a class="headerlink" href="#option-3-principal-component-analysis" title="Link to this heading">#</a></h6>
<p>Let’s leverage the <a class="reference external" href="https://pyleoclim-util.readthedocs.io/en/latest/core/api.html#pyleoclim.core.multiplegeoseries.MultipleGeoSeries.pca">PCA functionality in Pyleoclim</a>. A tutorial for this functionality is available <a class="reference external" href="https://linked.earth/PyleoTutorials/notebooks/L2_principal_component_analysis.html">here</a>.</p>
<p>The first step is to brings the records on a common time axis and standardize them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mgs_srca_sc</span> <span class="o">=</span> <span class="n">mgs_srca</span><span class="o">.</span><span class="n">common_time</span><span class="p">()</span><span class="o">.</span><span class="n">standardize</span><span class="p">()</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">mgs_srca_sc</span><span class="o">.</span><span class="n">stackplot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/37ac7c677e4abfef7af801b675839f1d8ba824d0b7f9c7eab8ab75c8ebe9ed5d.png" src="../../_images/37ac7c677e4abfef7af801b675839f1d8ba824d0b7f9c7eab8ab75c8ebe9ed5d.png" />
</div>
</div>
<p>Let’s run PCA:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pca</span> <span class="o">=</span> <span class="n">mgs_srca_sc</span><span class="o">.</span><span class="n">pca</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>And let’s have a look at the first mode:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">modeplot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/711e097baa3f42b9f139df455a9aed2b15dbd981b1371133f66518ed6f9c1568.png" src="../../_images/711e097baa3f42b9f139df455a9aed2b15dbd981b1371133f66518ed6f9c1568.png" />
</div>
</div>
<p>Not unsurprisingly, the first PC explains over 75% of the variance. Let’s have a look at the loads:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pca</span><span class="o">.</span><span class="n">eigvecs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([-0.54194915,  0.4525358 ,  0.03876175, -0.70710678])
</pre></div>
</div>
</div>
</div>
<p>The loads are not very similar, which is interesting considering that tow of these records are definitely the same. PCA may not work well to find duplicates.</p>
<p><strong>Based on this small proof of concept, correlation and DTW seems to be a reasonable approach to identify duplicates in the database.</strong></p>
</section>
</section>
<section id="handling-duplication-part-2-delta-18-mathrm-o">
<h5>Handling duplication part 2: <span class="math notranslate nohighlight">\(\delta^{18}\mathrm{O}\)</span><a class="headerlink" href="#handling-duplication-part-2-delta-18-mathrm-o" title="Link to this heading">#</a></h5>
<p>Let’s now have a look at the various <span class="math notranslate nohighlight">\(\delta^{18}\mathrm{O}\)</span> records.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_distance_d18O</span> <span class="o">=</span> <span class="n">df_distance</span><span class="p">[</span><span class="n">df_distance</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;d18O&#39;</span><span class="p">]</span>
<span class="n">df_distance_d18O</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>...</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
      <th>distance_km</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>Ocn-Palmyra.Cobb.2013</td>
      <td>Pages2kTemperature</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>-7.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.651, -4.631, -4.629, -4.562, -4.58, -4.442...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Ocean2kHR_139</td>
      <td>year</td>
      <td>year</td>
      <td>[928.125, 928.209, 928.292, 928.375, 928.459, ...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>2</th>
      <td>CO03COPM</td>
      <td>iso2k</td>
      <td>Coral</td>
      <td>5.870</td>
      <td>-162.130</td>
      <td>-7.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-5.27, -5.42, -5.49, -5.5, -5.44, -5.48, -5.5...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Ocean2kHR_139_iso2k</td>
      <td>year</td>
      <td>year</td>
      <td>[1998.37, 1998.29, 1998.2, 1998.13, 1998.04, 1...</td>
      <td>yr AD</td>
      <td>1.176328</td>
    </tr>
    <tr>
      <th>3</th>
      <td>NU11PAL01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.867</td>
      <td>-162.133</td>
      <td>-9.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.79, -4.89, -4.81, -4.84, -4.85, -4.82, -4....</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NU11PAL01_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1886.13, 1886.21, 1886.29, 1886.38, 1886.46, ...</td>
      <td>yr AD</td>
      <td>1.439510</td>
    </tr>
    <tr>
      <th>5</th>
      <td>SA19PAL01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.878</td>
      <td>-162.142</td>
      <td>-10.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-5.21, -5.23, -5.17, -5.13, -5.11, -5.05, -5....</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>SA19PAL01_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1983.58, 1983.67, 1983.75, 1983.83, 1983.92, ...</td>
      <td>yr AD</td>
      <td>2.754166</td>
    </tr>
    <tr>
      <th>7</th>
      <td>SA19PAL02</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>5.878</td>
      <td>-162.142</td>
      <td>-10.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-5.05, -5.1, -5.21, -5.14, -5.23, -5.32, -5.3...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>SA19PAL02_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1985.92, 1986.0, 1986.08, 1986.17, 1986.25, 1...</td>
      <td>yr AD</td>
      <td>2.754166</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ts_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_distance_d18O</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_proxy&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_proxy&#39;</span><span class="p">],</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">]</span>
    <span class="n">ts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyleo</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">],</span><span class="n">value</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span>
                            <span class="n">time_name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">],</span>
                            <span class="n">time_unit</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_units&#39;</span><span class="p">],</span> <span class="n">value_unit</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_units&#39;</span><span class="p">],</span>
                            <span class="n">lat</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">],</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">],</span> 
                            <span class="n">elevation</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanElev&#39;</span><span class="p">],</span> <span class="n">importedFrom</span><span class="o">=</span><span class="s1">&#39;lipdverse.org&#39;</span><span class="p">,</span>
                            <span class="n">archiveType</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">],</span>
                            <span class="n">observationType</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_proxy&#39;</span><span class="p">],</span>       
                            <span class="n">label</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">proxy</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span> 

<span class="c1"># Add the Dee et al. record</span>

<span class="n">ts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pyleo</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">time_name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span>
                    <span class="n">value_name</span><span class="o">=</span><span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">time_unit</span><span class="o">=</span><span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;time_units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                    <span class="n">value_unit</span><span class="o">=</span><span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;paleoData_units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">lon</span> <span class="o">=</span> <span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                    <span class="n">elevation</span> <span class="o">=</span> <span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;geo_meanElev&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">importedFrom</span><span class="o">=</span><span class="s1">&#39;lipdverse.org&#39;</span><span class="p">,</span>
                    <span class="n">archiveType</span> <span class="o">=</span> <span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">observationType</span><span class="o">=</span><span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;paleoData_proxy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>       
                    <span class="n">label</span><span class="o">=</span><span class="n">df_palm_filt</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">proxy</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>

<span class="n">mgs</span> <span class="o">=</span> <span class="n">pyleo</span><span class="o">.</span><span class="n">MultipleGeoSeries</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span> 
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">mgs</span><span class="o">.</span><span class="n">stackplot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/16375f3fba15f44bd05bfe76123a205caf286a6b513b1f3c13cb1956e2835588.png" src="../../_images/16375f3fba15f44bd05bfe76123a205caf286a6b513b1f3c13cb1956e2835588.png" />
</div>
</div>
<p>As we have seen with the Sr/Ca record, there seems to be duplications among the record. Although some look like changes in the age models. Let’s explore correlation and DTW to weed out the duplicates.</p>
<section id="id1">
<h6>Option 1: Correlation<a class="headerlink" href="#id1" title="Link to this heading">#</a></h6>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mgs</span><span class="o">.</span><span class="n">series_list</span><span class="p">)</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
<span class="n">corr_mat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1">#let&#39;s only work on half of the matrix to speeds things up</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># loop over records </span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">mgs</span><span class="o">.</span><span class="n">series_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    
    <span class="n">mgsl</span> <span class="o">=</span> <span class="n">pyleo</span><span class="o">.</span><span class="n">MultipleGeoSeries</span><span class="p">(</span><span class="n">mgs</span><span class="o">.</span><span class="n">series_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span> <span class="c1">#gather potential pairs</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">mgsl</span><span class="o">.</span><span class="n">correlation</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;built-in&#39;</span><span class="p">)</span> <span class="c1"># compute correlations</span>
    <span class="n">corr_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">r</span> <span class="c1"># save result in matrix</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 15 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 15/15 [00:00&lt;00:00, 543.36it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 14 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 14/14 [00:00&lt;00:00, 612.66it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 13 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 13/13 [00:00&lt;00:00, 2594.87it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 12 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 12/12 [00:00&lt;00:00, 3536.76it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 11 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 11/11 [00:00&lt;00:00, 3804.83it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 10 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10/10 [00:00&lt;00:00, 2108.33it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 9 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 9/9 [00:00&lt;00:00, 1791.42it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 8 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 8/8 [00:00&lt;00:00, 501.88it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 7 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 7/7 [00:00&lt;00:00, 980.70it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 6 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 6/6 [00:00&lt;00:00, 1411.43it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 5 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 5/5 [00:00&lt;00:00, 2103.25it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 4 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 4/4 [00:00&lt;00:00, 1598.13it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 3 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 3/3 [00:00&lt;00:00, 1029.53it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 2 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 2/2 [00:00&lt;00:00, 651.24it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Looping over 1 Series in collection
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 1/1 [00:00&lt;00:00, 21290.88it/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mgs</span><span class="o">.</span><span class="n">series_list</span><span class="p">:</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
<span class="n">core_matrix_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">core_matrix_df</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Correlation Heatmap&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0fa32dd6c5a34e6c184e341a3c06ea629aad4d30f0951839d5332d75da29a2db.png" src="../../_images/0fa32dd6c5a34e6c184e341a3c06ea629aad4d30f0951839d5332d75da29a2db.png" />
</div>
</div>
<p>Some of the correlations are high, suggesting that the small segments went into the composited records. Note that some of the correlations were not run since the segments were not overlapping and were, therefore, skipped.</p>
</section>
<section id="option-2-dtw">
<h6>Option 2: DTW<a class="headerlink" href="#option-2-dtw" title="Link to this heading">#</a></h6>
<p>Let’s look at the DTW method to identify duplicates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Prepare the data ----</span>
<span class="n">records</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">mgs</span><span class="o">.</span><span class="n">series_list</span><span class="p">:</span>
    <span class="n">records</span><span class="p">[</span><span class="n">series</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">value</span>
    <span class="n">times</span><span class="p">[</span><span class="n">series</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">time</span>


<span class="c1"># --- Main loop ---</span>
<span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">records</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="n">dtw_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">key_i</span><span class="p">,</span> <span class="n">key_j</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">clip_to_overlap</span><span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">key_i</span><span class="p">],</span> <span class="n">records</span><span class="p">[</span><span class="n">key_i</span><span class="p">],</span>
                             <span class="n">times</span><span class="p">[</span><span class="n">key_j</span><span class="p">],</span> <span class="n">records</span><span class="p">[</span><span class="n">key_j</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">s1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">dtw</span><span class="o">.</span><span class="n">warping_path</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">dtw</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
        <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># Per-step normalization</span>

        <span class="n">dtw_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtw_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm_dist</span>

<span class="c1"># Convert to DataFrame for visualization</span>
<span class="n">dtw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dtw_matrix</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">dtw_df</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dtw_df</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;DTW Distance Matrix (Clipped to Overlap)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4ed09d165fbe918929567d228e1d127605956f527dab87b451273c7511f65188.png" src="../../_images/4ed09d165fbe918929567d228e1d127605956f527dab87b451273c7511f65188.png" />
</div>
</div>
<p>The DTW method largely confirms what we have seen from the correlations in terms of duplicates. However, note that the DTW method indicates that the records from <code class="docutils literal notranslate"><span class="pre">OCN-Palmyra.Cobb.2013</span></code> and <code class="docutils literal notranslate"><span class="pre">CO03COPM</span></code> have a correlation of 0.79 but a DTW of 0. The DTW would essentially indicate that they are in fact the same records but the correlation is less than 0.8. This is due to the interpolation needed to calculate correlation over the 14th century, highlighting the need to run DTW for records with larger gaps. We will use the insights gained here to clean the database in the next section of this notebook. For now, let’s add the Dee et al. (2020) record to the database:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_raw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">df_palm_filt</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_raw</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>...</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
      <th>distance_km</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>968</th>
      <td>ZI08MAY01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>-12.6500</td>
      <td>45.10</td>
      <td>-2.0</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[8.947578, 8.797017, 8.784511, 8.751525, 8.778...</td>
      <td>mmol/mol</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>ZI08MAY01_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1881.6247, 1881.791367, 1881.958033, 1882.124...</td>
      <td>yr AD</td>
      <td>16936.585327</td>
    </tr>
    <tr>
      <th>969</th>
      <td>LI06FIJ01</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>-16.8200</td>
      <td>179.23</td>
      <td>-10.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.6922, -4.6266, -4.6018, -4.5486, -4.6102, ...</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>LI06FIJ01_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1617.5, 1618.5, 1619.5, 1620.5, 1621.5, 1622....</td>
      <td>yr AD</td>
      <td>3250.716202</td>
    </tr>
    <tr>
      <th>970</th>
      <td>SM06LKF02</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>24.5600</td>
      <td>-81.41</td>
      <td>-4.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-3.85, -3.98, -4.21, -4.06, -3.97, -4.04, -3....</td>
      <td>permil</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>SM06LKF02_d18O</td>
      <td>year</td>
      <td>year</td>
      <td>[1960.97, 1961.03, 1961.09, 1961.15, 1961.21, ...</td>
      <td>yr AD</td>
      <td>8799.120973</td>
    </tr>
    <tr>
      <th>971</th>
      <td>SM06LKF02</td>
      <td>CoralHydro2k</td>
      <td>Coral</td>
      <td>24.5600</td>
      <td>-81.41</td>
      <td>-4.0</td>
      <td>SrCa</td>
      <td>Sr/Ca</td>
      <td>[9.225, nan, 9.195, 9.221, 9.198, 9.281, 9.319...</td>
      <td>mmol/mol</td>
      <td>...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>SM06LKF02_SrCa</td>
      <td>year</td>
      <td>year</td>
      <td>[1960.97, 1961.03, 1961.09, 1961.15, 1961.21, ...</td>
      <td>yr AD</td>
      <td>8799.120973</td>
    </tr>
    <tr>
      <th>972</th>
      <td>Palmyra.Dee.2020</td>
      <td>None</td>
      <td>Coral</td>
      <td>5.8664</td>
      <td>-162.12</td>
      <td>-9.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-4.749, -4.672, -4.724, -4.717, -4.8947, -4.8...</td>
      <td>permil</td>
      <td>...</td>
      <td>isotopic</td>
      <td>subannual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>PCU-1cce3af5639a4ec</td>
      <td>year</td>
      <td>year</td>
      <td>[1146.375, 1146.4583, 1146.5417, 1146.625, 114...</td>
      <td>yr AD</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 21 columns</p>
</div></div></div>
</div>
<p>Let’s drop the added columns that we put in for distance:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_raw</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>
</section>
<section id="data-cleaning-and-pre-processing">
<h2>Data Cleaning and Pre-processing<a class="headerlink" href="#data-cleaning-and-pre-processing" title="Link to this heading">#</a></h2>
<p>This section deals with cleaning and pre-processing for use with the <a class="reference external" href="https://fzhu2e.github.io/cfr/"><code class="docutils literal notranslate"><span class="pre">cfr</span></code> codebase</a>. We will do so in three steps:</p>
<ul class="simple">
<li><p>Step 1: Remove records that are less than 150 years. For reconstruction purposes, we need series that go back at least to 1850; many in this database do not, so we remove them to avoid disappointments later on.</p></li>
<li><p>Step 2: Remove duplicates. We will use an algorithm based on the data exploratory analysis we did for the specific case of the Palmyra record and generalize it.</p></li>
<li><p>Step 3: Filtering for records with annual to subannual resolution.</p></li>
</ul>
<section id="step-1-remove-records-shorter-than-150-years">
<h3>Step 1: Remove records shorter than 150 years<a class="headerlink" href="#step-1-remove-records-shorter-than-150-years" title="Link to this heading">#</a></h3>
<p>For reconstruction purposes, we need series that go back at least to 1850; many in this database do not, so we remove them to avoid disappointments later on. Let’s first look at the start date of these records.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;min_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">))</span>
<span class="n">filtered_df</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="n">df_raw</span><span class="p">[</span><span class="s1">&#39;min_time&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1850</span><span class="p">]</span>
<span class="n">filtered_df</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;min_time&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">filtered_df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(744, 20)
</pre></div>
</div>
</div>
</div>
<p>That leaves us with 744 timeseries.</p>
</section>
<section id="step-2-screen-for-duplicates">
<h3>Step 2: Screen for duplicates<a class="headerlink" href="#step-2-screen-for-duplicates" title="Link to this heading">#</a></h3>
<p>Based on the preliminary work we have done with the Palmyra records, we will used the following algorithm to identify duplicates:</p>
<ol class="arabic">
<li><p>Look for records within 10km of each other</p></li>
<li><p>Look at whether the variable name is the same</p></li>
<li><p>Calculate correlations among the records</p></li>
<li><p>Calculate the DTW distance among the records.</p></li>
<li><p>For correlations &gt;0.8 OR DTW distance &lt; 0.03, use the following:</p>
<p>a. Use the latest publication date (based on dataset name)</p>
<p>b. Use the longest record if the publication date is the same</p>
</li>
</ol>
<p>Let’s have a look at the variable names present in the database to see if there are synonyms we have to deal with. Let’s make sure that we use a criteria that doesn’t have any missing values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filtered_df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 744 entries, 0 to 972
Data columns (total 20 columns):
 #   Column                  Non-Null Count  Dtype  
---  ------                  --------------  -----  
 0   dataSetName             744 non-null    object 
 1   compilationName         743 non-null    object 
 2   archiveType             744 non-null    object 
 3   geo_meanLat             744 non-null    float64
 4   geo_meanLon             744 non-null    float64
 5   geo_meanElev            737 non-null    object 
 6   paleoData_variableName  744 non-null    object 
 7   paleoData_standardName  744 non-null    object 
 8   paleoData_values        744 non-null    object 
 9   paleoData_units         336 non-null    object 
 10  paleoData_proxy         665 non-null    object 
 11  paleoData_proxyGeneral  501 non-null    object 
 12  paleoData_seasonality   659 non-null    object 
 13  paleoData_interpName    665 non-null    object 
 14  paleoData_interpRank    12 non-null     float64
 15  TSID                    744 non-null    object 
 16  time_variableName       744 non-null    object 
 17  time_standardName       744 non-null    object 
 18  time_values             744 non-null    object 
 19  time_units              744 non-null    object 
dtypes: float64(3), object(17)
memory usage: 122.1+ KB
</pre></div>
</div>
</div>
</div>
<p>From this, it seems that <code class="docutils literal notranslate"><span class="pre">paleoData_standardName</span></code> could work for our purposes since there are no missing values in this field and most of the names should have been standardized:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filtered_df</span><span class="p">[</span><span class="s1">&#39;paleoData_standardName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;d18O&#39;, &#39;MXD&#39;, &#39;density&#39;, &#39;ringWidth&#39;, &#39;temperature&#39;,
       &#39;reflectance&#39;, &#39;Sr/Ca&#39;, &#39;iceMelt&#39;, &#39;d2H&#39;, &#39;thickness&#39;,
       &#39;RABD660670&#39;, &#39;calcificationRate&#39;, &#39;varveThickness&#39;, &#39;MAR&#39;],
      dtype=object)
</pre></div>
</div>
</div>
</div>
<p>The names are unique. Let’s proceed with the main loop. But first, let’s define some constants and parameters for the algorithm described above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Define some parameters ---</span>
<span class="n">threshold</span>  <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Distance in km</span>
<span class="n">corr_threshold</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="c1"># Corr threshold over which two records are considered the same. </span>
<span class="n">dtw_threshold</span> <span class="o">=</span> <span class="mf">0.03</span> <span class="c1"># DTW threshold under which two records are considered the same. </span>
</pre></div>
</div>
</div>
</div>
<p>Let’s also consider writing some functions to calculate the various criteria described above:</p>
<ol class="arabic simple">
<li><p>Distance on aa sphere using the Haversine distance</p></li>
<li><p>Correlation among multiple timeseries using Pyleoclim</p></li>
<li><p>DTW amon multiple timeseries</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Haversine distance function in km ---</span>
<span class="k">def</span><span class="w"> </span><span class="nf">haversine</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span><span class="p">,</span> <span class="n">lats2</span><span class="p">,</span> <span class="n">lons2</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mi">6371</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the haversine distance between a target location and a vector of locations. </span>

<span class="sd">    Args:</span>
<span class="sd">        lat1 (float): The target latitude</span>
<span class="sd">        lon1 (float): the target longitude</span>
<span class="sd">        lats2 (np.array or df.Series): The latitude of the locations to check against</span>
<span class="sd">        lons2 (np.array or df.Series): The longitude of the locations to check against</span>
<span class="sd">        R (int, optional): The radius of the planet in km. Defaults to 6371 for Earth.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.array: The distance between the target location and the vector of locations in km.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert degrees to radians</span>
    <span class="n">lat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span>
    <span class="n">lon1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon1</span><span class="p">)</span>
    <span class="n">lats2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lats2</span><span class="p">)</span>
    <span class="n">lons2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lons2</span><span class="p">)</span>

    <span class="c1"># Haversine formula</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">lats2</span> <span class="o">-</span> <span class="n">lat1</span>
    <span class="n">dlon</span> <span class="o">=</span> <span class="n">lons2</span> <span class="o">-</span> <span class="n">lon1</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lats2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">R</span><span class="o">*</span><span class="n">c</span>


<span class="c1"># ----- Correlation function ------</span>

<span class="k">def</span><span class="w"> </span><span class="nf">correlation</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate correlation among multiple timeseries</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: pd.DataFrame</span>
<span class="sd">        A pandas DataFrame containing the necessary information to create Pyleoclim.GeoSeries() objects</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A DataFrame containing pairwise correlations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ds_name1</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of dataset names used as correlation basis</span>
    <span class="n">ds_name2</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of dataset names used as the series to correlate against</span>
    <span class="c1"># Same for tsids since they are unique and we can find them again easily in the database</span>
    <span class="n">tsid1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tsid2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># list to keep the correlations</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create a MultipleGeoSeries object</span>

    <span class="n">ts_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="n">pyleo</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">],</span><span class="n">value</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span>
                            <span class="n">time_name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span><span class="n">value_name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_standardName&#39;</span><span class="p">],</span>
                            <span class="n">time_unit</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_units&#39;</span><span class="p">],</span> <span class="n">value_unit</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_units&#39;</span><span class="p">],</span>
                            <span class="n">lat</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">],</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">],</span> 
                            <span class="n">elevation</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanElev&#39;</span><span class="p">],</span> <span class="n">archiveType</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">],</span>    
                            <span class="n">label</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;+&#39;</span><span class="o">+</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">ts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">ts1</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1">#grab the first timeseries</span>
        <span class="n">ts2</span> <span class="o">=</span> <span class="n">ts_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="c1"># append the names and tsids</span>
        <span class="n">ds_name1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">tsid1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts1</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                
        <span class="n">ds_name2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts2</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">tsid2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts2</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># calculate the correlation</span>
        <span class="n">corr_res</span> <span class="o">=</span> <span class="n">ts1</span><span class="o">.</span><span class="n">correlation</span><span class="p">(</span><span class="n">ts2</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;built-in&#39;</span><span class="p">)</span>

        <span class="c1"># Store the information</span>
        <span class="n">corr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corr_res</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
    
    <span class="c1"># Step 3: Summarize results</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;dataSetName1&#39;</span><span class="p">:</span> <span class="n">ds_name1</span><span class="p">,</span>
                         <span class="s1">&#39;dataSetName2&#39;</span><span class="p">:</span> <span class="n">ds_name2</span><span class="p">,</span>
                         <span class="s1">&#39;TSID1&#39;</span><span class="p">:</span> <span class="n">tsid1</span><span class="p">,</span>
                         <span class="s1">&#39;TSID2&#39;</span><span class="p">:</span> <span class="n">tsid2</span><span class="p">,</span>
                        <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="n">corr</span><span class="p">})</span> 


<span class="c1"># ------ DTW function</span>


<span class="k">def</span><span class="w"> </span><span class="nf">dtw_pair</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the DTW betwen the records in the dataframe</span>

<span class="sd">    Args:</span>
<span class="sd">        data (pd.DataFrame): A pandas DataFrame containing the necessary information to create Pyleoclim.GeoSeries() objects</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: A DataFrame containing pairwise DTW</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">### Helper function</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">clip_to_overlap</span><span class="p">(</span><span class="n">time1</span><span class="p">,</span> <span class="n">series1</span><span class="p">,</span> <span class="n">time2</span><span class="p">,</span> <span class="n">series2</span><span class="p">,</span> <span class="n">min_overlap</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to clip the series to common overlap. Note we do  not need to interpolate for DTW, just make sure that the time is overlapping</span>

<span class="sd">        Args:</span>
<span class="sd">            time1 (np.array): Time vector for Series 1</span>
<span class="sd">            series1 (np.array): Value vector for Series 1</span>
<span class="sd">            time2 (np.array): Time vector for Series 2</span>
<span class="sd">            series2 (np.array): Value vector for Series 2</span>
<span class="sd">            min_overlap (int, optional): Minimum number of pointe to even attempt the computation. Defaults to 5.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.array, np.array: The zscore of the values for the time of overlap.  </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure things are sorted and have no NaNs</span>
        <span class="n">valid1</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">time1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">series1</span><span class="p">))</span>
        <span class="n">time1</span> <span class="o">=</span> <span class="n">time1</span><span class="p">[</span><span class="n">valid1</span><span class="p">]</span>
        <span class="n">series1</span> <span class="o">=</span> <span class="n">series1</span><span class="p">[</span><span class="n">valid1</span><span class="p">]</span>

        <span class="n">valid2</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">time2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">series2</span><span class="p">))</span>
        <span class="n">time2</span> <span class="o">=</span> <span class="n">time2</span><span class="p">[</span><span class="n">valid2</span><span class="p">]</span>
        <span class="n">series2</span> <span class="o">=</span> <span class="n">series2</span><span class="p">[</span><span class="n">valid2</span><span class="p">]</span>

        <span class="c1"># Return early if either series is now empty</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">time2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


        <span class="n">sort_idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">time1</span><span class="p">)</span>
        <span class="n">time1_sorted</span> <span class="o">=</span> <span class="n">time1</span><span class="p">[</span><span class="n">sort_idx1</span><span class="p">]</span>
        <span class="n">series1_sorted</span> <span class="o">=</span> <span class="n">series1</span><span class="p">[</span><span class="n">sort_idx1</span><span class="p">]</span>

        <span class="n">sort_idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">time2</span><span class="p">)</span>
        <span class="n">time2_sorted</span> <span class="o">=</span> <span class="n">time2</span><span class="p">[</span><span class="n">sort_idx2</span><span class="p">]</span>
        <span class="n">series2_sorted</span> <span class="o">=</span> <span class="n">series2</span><span class="p">[</span><span class="n">sort_idx2</span><span class="p">]</span>

        <span class="c1"># Determine overlapping interval</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">time1_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time2_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">time1_sorted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">time2_sorted</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Apply mask</span>
        <span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">time1_sorted</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">time1_sorted</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="p">(</span><span class="n">time2_sorted</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">time2_sorted</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_overlap</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_overlap</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span> <span class="c1"># Not enough overlapping points</span>

        <span class="n">clipped1</span> <span class="o">=</span> <span class="n">series1_sorted</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
        <span class="n">clipped2</span> <span class="o">=</span> <span class="n">series2_sorted</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>

        <span class="c1"># Avoid division by zero if std = 0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">clipped1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">clipped2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">zscore</span><span class="p">(</span><span class="n">clipped1</span><span class="p">),</span> <span class="n">zscore</span><span class="p">(</span><span class="n">clipped2</span><span class="p">)</span>
   
    <span class="c1">### Main function </span>

    <span class="n">ds_name1</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of dataset names used as correlation basis</span>
    <span class="n">ds_name2</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># list of dataset names used as the series to correlate against</span>
    <span class="c1"># Same for tsids since they are unique and we can find them again easily in the database</span>
    <span class="n">tsid1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tsid2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># list to keep the DTW</span>
    <span class="n">dtw_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">row1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span> <span class="c1">#grab the first record</span>
        <span class="n">row2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="c1">#grab the second record</span>

        <span class="n">ds_name1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row1</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">])</span>
        <span class="n">ds_name2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row2</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">])</span>
        <span class="n">tsid1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row1</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">])</span>
        <span class="n">tsid2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row2</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">])</span>

        <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">clip_to_overlap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row1</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row1</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">]),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row2</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row2</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">]))</span>
        

        <span class="k">if</span> <span class="n">s1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">dtw</span><span class="o">.</span><span class="n">warping_path</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dtw</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
            <span class="n">dtw_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>  <span class="c1"># Per-step normalization</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtw_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="n">df</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;dataSetName1&#39;</span><span class="p">:</span> <span class="n">ds_name1</span><span class="p">,</span>
                       <span class="s1">&#39;dataSetName2&#39;</span><span class="p">:</span> <span class="n">ds_name2</span><span class="p">,</span>
                       <span class="s1">&#39;TSID1&#39;</span><span class="p">:</span> <span class="n">tsid1</span><span class="p">,</span>
                       <span class="s1">&#39;TSID2&#39;</span><span class="p">:</span> <span class="n">tsid2</span><span class="p">,</span>
                       <span class="s1">&#39;dtw&#39;</span><span class="p">:</span> <span class="n">dtw_list</span><span class="p">})</span>
        
    <span class="k">return</span> <span class="n">df</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Containers for the list of DataFrames with spurious correlations</span>
<span class="n">tsids</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#to keep track of the tsids that have already been checked against the distance criteria</span>

<span class="c1">#make a copy of the dataframe as we need to modify it for this loop</span>
<span class="n">df_copy</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_copy</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

    <span class="c1"># Check that we haven&#39;t already looked at the record in the context of another distance search</span>

    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">tsids</span><span class="p">:</span>
        <span class="k">continue</span> <span class="c1">#go to the next row</span>

    <span class="c1"># ---- Criteria 1: Distance -----</span>
    <span class="c1"># Target location</span>
    <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">]</span>
    <span class="n">distance_km</span> <span class="o">=</span> <span class="n">haversine</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span><span class="n">lon1</span><span class="p">,</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">],</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">])</span>

    <span class="c1"># Add distance column</span>
    <span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance_km</span>

    <span class="c1"># Filter to only rows within a threshold</span>
    <span class="n">df_distance</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;distance_km&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Store the TSIDs so we don&#39;t run this multiple times</span>
    <span class="n">tsids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">df_distance</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>

    <span class="c1"># If there is only one entry (the original one, go to the next row)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_distance</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="c1"># ---- Criteria 2: Variable Name ------</span>

    <span class="n">var_unique</span> <span class="o">=</span> <span class="n">df_distance</span><span class="p">[</span><span class="s1">&#39;paleoData_standardName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_unique</span><span class="p">:</span>
        <span class="n">df_var_filt</span> <span class="o">=</span> <span class="n">df_distance</span><span class="p">[</span><span class="n">df_distance</span><span class="p">[</span><span class="s1">&#39;paleoData_standardName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_var_filt</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>

    <span class="c1"># ----- Criteria 3: Correlation -------</span>
            <span class="n">corr_df</span> <span class="o">=</span> <span class="n">correlation</span><span class="p">(</span><span class="n">df_var_filt</span><span class="p">)</span>
    
    <span class="c1"># ------ Criteria 4: DTW --------</span>
            <span class="n">dtw_df</span> <span class="o">=</span> <span class="n">dtw_pair</span><span class="p">(</span><span class="n">df_var_filt</span><span class="p">)</span>
        
            <span class="c1">#put the results together</span>
            <span class="n">common_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dataSetName1&#39;</span><span class="p">,</span> <span class="s1">&#39;dataSetName1&#39;</span><span class="p">,</span> <span class="s1">&#39;TSID1&#39;</span><span class="p">,</span><span class="s1">&#39;TSID2&#39;</span><span class="p">]</span>

            <span class="n">df_combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">corr_df</span><span class="p">,</span> <span class="n">dtw_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">common_cols</span><span class="p">)</span>
            <span class="n">df_res</span> <span class="o">=</span> <span class="n">df_combined</span><span class="p">[(</span><span class="n">df_combined</span><span class="p">[</span><span class="s1">&#39;correlation&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">corr_threshold</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df_combined</span><span class="p">[</span><span class="s1">&#39;dtw&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dtw_threshold</span><span class="p">)]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">df_res</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_res</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see how many similar records we have:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>89
</pre></div>
</div>
</div>
</div>
<p>Let’s have a look at each records with duplicated and create a log (human in the loop) of why records were removed from the database.</p>
<p>⚠️ <strong>Warning</strong></p>
<p>The following cell produces a widget that allows you to go through each of the similar records and to keep/remove records. If you do so, you will change the nature of the database.</p>
<div style="border-left: 6px solid #e74c3c; background-color: #f8d7da; padding: 10px; margin: 10px 0;">
  <strong>❗ DO NOT RUN THIS CELL UNLESS YOU WANT TO CLEAN THE DATABASE YOURSELF. NOT RECOMMENDED!!!!!! Skip to the last section to load the cleaned database directly. 
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">clear_output</span><span class="p">,</span> <span class="n">Markdown</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">widgets</span>

<span class="c1"># Storage</span>
<span class="n">flagged_records</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">group_notes</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">df_copy</span> <span class="o">=</span> <span class="n">filtered_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">index_tracker</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_iteration</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Final screen</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Review complete!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flagged_records</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🚩 Flagged TSIDs:&quot;</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">flagged_records</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🚩 No TSIDs were flagged.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group_notes</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;Note&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">group_notes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📝 Notes from each group:&quot;</span><span class="p">)</span>
            <span class="n">markdown_notes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;### Iteration </span><span class="si">{</span><span class="n">note</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;```</span><span class="se">\n</span><span class="si">{</span><span class="n">note</span><span class="p">[</span><span class="s1">&#39;Note&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">```&quot;</span>
                    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">group_notes</span> <span class="k">if</span> <span class="n">note</span><span class="p">[</span><span class="s1">&#39;Note&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">markdown_notes</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📝 No group notes were entered.&quot;</span><span class="p">)</span>

        <span class="c1"># Final Done button</span>
        <span class="n">done_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Done&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">on_done_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🎉 Done! You may now export your results.&quot;</span><span class="p">)</span>

        <span class="n">done_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">on_done_clicked</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">done_button</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Begin reviewing group i</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Reviewing DataFrame </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

    <span class="n">valid_ids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;TSID1&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TSID2&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">df_lookup</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">valid_ids</span><span class="p">)]</span>
    <span class="n">display</span><span class="p">(</span><span class="n">df_lookup</span><span class="p">)</span>

    <span class="c1"># Plot time series</span>
    <span class="n">ts_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_lookup</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">pyleo</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span>
            <span class="n">time</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">],</span>
            <span class="n">value</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">],</span>
            <span class="n">time_name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span>
            <span class="n">value_name</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_standardName&#39;</span><span class="p">],</span>
            <span class="n">time_unit</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_units&#39;</span><span class="p">],</span>
            <span class="n">value_unit</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_units&#39;</span><span class="p">],</span>
            <span class="n">lat</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">],</span>
            <span class="n">lon</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">],</span>
            <span class="n">elevation</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanElev&#39;</span><span class="p">],</span>
            <span class="n">archiveType</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">],</span>
            <span class="n">label</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">],</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">ts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ts_list</span><span class="p">:</span>
        <span class="n">mgs</span> <span class="o">=</span> <span class="n">pyleo</span><span class="o">.</span><span class="n">MultipleGeoSeries</span><span class="p">(</span><span class="n">ts_list</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">mgs</span><span class="o">.</span><span class="n">stackplot</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No valid time series to plot.&quot;</span><span class="p">)</span>

    <span class="c1"># Create widgets for TSIDs</span>
    <span class="n">tsid_widgets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tsid</span> <span class="ow">in</span> <span class="n">valid_ids</span><span class="p">:</span>
        <span class="n">toggle</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">RadioButtons</span><span class="p">(</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Keep&#39;</span><span class="p">,</span> <span class="s1">&#39;Remove&#39;</span><span class="p">],</span>
            <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Keep&#39;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tsid</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;40%&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">tsid_widgets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tsid</span><span class="p">,</span> <span class="n">toggle</span><span class="p">))</span>

    <span class="n">toggle_box</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">VBox</span><span class="p">([</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">tsid_widgets</span><span class="p">])</span>

    <span class="c1"># Shared note box (pre-filled)</span>
    <span class="n">note_template</span> <span class="o">=</span> <span class="s2">&quot;Records from different samples. Not true duplicates.&quot;</span>
    <span class="n">note_box</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Textarea</span><span class="p">(</span>
        <span class="n">value</span><span class="o">=</span><span class="n">note_template</span><span class="p">,</span>
        <span class="n">layout</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s1">&#39;60px&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Buttons</span>
    <span class="n">next_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Next&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s1">&#39;success&#39;</span><span class="p">)</span>
    <span class="n">back_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Back&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">)</span>
    <span class="n">quit_button</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Quit&quot;</span><span class="p">,</span> <span class="n">button_style</span><span class="o">=</span><span class="s1">&#39;danger&#39;</span><span class="p">)</span>
    <span class="n">button_box</span> <span class="o">=</span> <span class="n">widgets</span><span class="o">.</span><span class="n">HBox</span><span class="p">([</span><span class="n">next_button</span><span class="p">,</span> <span class="n">back_button</span><span class="p">,</span> <span class="n">quit_button</span><span class="p">])</span>

    <span class="c1"># --- Button callbacks ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_next_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="n">note</span> <span class="o">=</span> <span class="n">note_box</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Remove prior flags and note for this group</span>
        <span class="n">group_notes</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">group_notes</span> <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">flagged_records</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">flagged_records</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_ids</span><span class="p">]</span>

        <span class="c1"># Save new notes and flags</span>
        <span class="n">group_notes</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;Group&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;Note&#39;</span><span class="p">:</span> <span class="n">note</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">tsid</span><span class="p">,</span> <span class="n">toggle</span> <span class="ow">in</span> <span class="n">tsid_widgets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">toggle</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;Remove&#39;</span><span class="p">:</span>
                <span class="n">flagged_records</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;TSID&#39;</span><span class="p">:</span> <span class="n">tsid</span><span class="p">,</span> <span class="s1">&#39;Note&#39;</span><span class="p">:</span> <span class="n">note</span><span class="p">})</span>

        <span class="n">index_tracker</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">run_iteration</span><span class="p">(</span><span class="n">index_tracker</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_back_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index_tracker</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">index_tracker</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">run_iteration</span><span class="p">(</span><span class="n">index_tracker</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You&#39;re already at the first group.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_quit_clicked</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Quit early.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flagged_records</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🚩 Flagged TSIDs:&quot;</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">flagged_records</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">group_notes</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;Note&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">group_notes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📝 Notes from each group:&quot;</span><span class="p">)</span>
            <span class="n">markdown_notes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;### Iteration </span><span class="si">{</span><span class="n">note</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;```</span><span class="se">\n</span><span class="si">{</span><span class="n">note</span><span class="p">[</span><span class="s1">&#39;Note&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">```&quot;</span>
                    <span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">group_notes</span> <span class="k">if</span> <span class="n">note</span><span class="p">[</span><span class="s1">&#39;Note&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">markdown_notes</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📝 No group notes were entered.&quot;</span><span class="p">)</span>

    <span class="c1"># Hook up buttons</span>
    <span class="n">next_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">on_next_clicked</span><span class="p">)</span>
    <span class="n">back_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">on_back_clicked</span><span class="p">)</span>
    <span class="n">quit_button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">on_quit_clicked</span><span class="p">)</span>

    <span class="c1"># Display UI</span>
    <span class="n">display</span><span class="p">(</span><span class="n">button_box</span><span class="p">,</span> <span class="n">toggle_box</span><span class="p">,</span> <span class="n">note_box</span><span class="p">)</span>

<span class="c1"># Start the interactive loop</span>
<span class="n">run_iteration</span><span class="p">(</span><span class="n">index_tracker</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>TSID</th>
      <th>Note</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Ocean2kHR_142_iso2k</td>
      <td>Ocean2kHR_142_iso2k is a duplicate of Ocean2kH...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Ocean2kHR_156_iso2k</td>
      <td>Ocean2kHR_142_iso2k is a duplicate of Ocean2kH...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Ocean2kHR_157_iso2k</td>
      <td>Ocean2kHR_142_iso2k is a duplicate of Ocean2kH...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>LI00RAR01_d18O</td>
      <td>Same records. Keeping 147.</td>
    </tr>
    <tr>
      <th>4</th>
      <td>LI00RAR01_SrCa</td>
      <td>Same record. Keeping 149</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Ocean2kHR_006_iso2k</td>
      <td>Same records, keeping Ocean2kHR_006 from PAGES2k</td>
    </tr>
    <tr>
      <th>6</th>
      <td>CH03LOM01_d18O</td>
      <td>Same records, keeping Ocean2kHR_006 from PAGES2k</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Ocean2kHR_019_iso2k</td>
      <td>Same record. Keeping Ocean2kHR_019</td>
    </tr>
    <tr>
      <th>8</th>
      <td>FE18RUS01_d18O</td>
      <td>Same record. Keeping Ocean2kHR_019</td>
    </tr>
    <tr>
      <th>9</th>
      <td>CA07FLI01_SrCa</td>
      <td>Records from different samples. Not true dupli...</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Ocean2kHR_193_iso2k</td>
      <td>Same record. Keeping Ocean2kHR_193</td>
    </tr>
    <tr>
      <th>11</th>
      <td>CA07FLI01_d18O</td>
      <td>Same record. Keeping Ocean2kHR_193</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Ocean2kHR_026_iso2k</td>
      <td>Two records but duplicates. Keeping Ocean2kHR_...</td>
    </tr>
    <tr>
      <th>13</th>
      <td>KU99HOU01_d18O</td>
      <td>Two records but duplicates. Keeping Ocean2kHR_...</td>
    </tr>
    <tr>
      <th>14</th>
      <td>ZI14HOU01_d18O</td>
      <td>Two records but duplicates. Keeping Ocean2kHR_...</td>
    </tr>
    <tr>
      <th>15</th>
      <td>ZI14HOU01_SrCa</td>
      <td>Two records. Keeping Ocean2kHR 027 and 025</td>
    </tr>
    <tr>
      <th>16</th>
      <td>Ocean2kHR_133_iso2k</td>
      <td>Same record across all compilations. Keeping O...</td>
    </tr>
    <tr>
      <th>17</th>
      <td>QU96ESV01_d18O</td>
      <td>Same record across all compilations. Keeping O...</td>
    </tr>
    <tr>
      <th>18</th>
      <td>Ocean2kHR_183_iso2k</td>
      <td>Same record across all three compilations. Kee...</td>
    </tr>
    <tr>
      <th>19</th>
      <td>OS14UCP01_d18O</td>
      <td>Same record across all three compilations. Kee...</td>
    </tr>
    <tr>
      <th>20</th>
      <td>Ocean2kHR_166_iso2k</td>
      <td>Same record across all three compilations. Kee...</td>
    </tr>
    <tr>
      <th>21</th>
      <td>AS05GUA01_d18O</td>
      <td>Same record across all three compilations. Kee...</td>
    </tr>
    <tr>
      <th>22</th>
      <td>KI08PAR01_d18O</td>
      <td>Same record from two different compilations. K...</td>
    </tr>
    <tr>
      <th>23</th>
      <td>Ocean2kHR_173_iso2k</td>
      <td>Same record from three different compilations....</td>
    </tr>
    <tr>
      <th>24</th>
      <td>DU94URV01_d18O</td>
      <td>Same record from three different compilations....</td>
    </tr>
    <tr>
      <th>25</th>
      <td>Ocean2kHR_001_iso2k</td>
      <td>Same record from three different compilations....</td>
    </tr>
    <tr>
      <th>26</th>
      <td>CO00MAL01_d18O</td>
      <td>Same record from three different compilations....</td>
    </tr>
    <tr>
      <th>27</th>
      <td>DR99ABR01_d18O</td>
      <td>Same record from two different compilations. K...</td>
    </tr>
    <tr>
      <th>28</th>
      <td>Ocean2kHR_094_iso2k</td>
      <td>Same record from two different compilations. K...</td>
    </tr>
    <tr>
      <th>29</th>
      <td>Ocean2kHR_007_iso2k</td>
      <td>Same record from three compilations (note that...</td>
    </tr>
    <tr>
      <th>30</th>
      <td>DA06MAF02_d18O</td>
      <td>Same record from three compilations (note that...</td>
    </tr>
    <tr>
      <th>31</th>
      <td>Ocean2kHR_177_iso2k</td>
      <td>Same record from three different compilations....</td>
    </tr>
    <tr>
      <th>32</th>
      <td>UR00MAI01_d18O</td>
      <td>Same record from three different compilations....</td>
    </tr>
    <tr>
      <th>33</th>
      <td>SAm_035_iso2k</td>
      <td>Same record from two different compilations. K...</td>
    </tr>
    <tr>
      <th>34</th>
      <td>Ocean2kHR_139</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>35</th>
      <td>Ocean2kHR_139_iso2k</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>36</th>
      <td>CO03PAL08_d18O</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>37</th>
      <td>CO03PAL09_d18O</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>38</th>
      <td>CO03PAL04_d18O</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>39</th>
      <td>CO03PAL10_d18O</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>40</th>
      <td>CO03PAL05_d18O</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>41</th>
      <td>CO03PAL07_d18O</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>42</th>
      <td>CO03PAL06_d18O</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>43</th>
      <td>CO03PAL02_d18O</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>44</th>
      <td>CO03PAL03_d18O</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>45</th>
      <td>CO03PAL01_d18O</td>
      <td>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec...</td>
    </tr>
    <tr>
      <th>46</th>
      <td>Ocean2kHR_020_iso2k</td>
      <td>Same record from different compilations. Keepi...</td>
    </tr>
    <tr>
      <th>47</th>
      <td>ZI04IFR01_d18O</td>
      <td>Same record from different compilations. Keepi...</td>
    </tr>
    <tr>
      <th>48</th>
      <td>DE12ANC01_SrCa</td>
      <td>Same record from two different compilations. K...</td>
    </tr>
    <tr>
      <th>49</th>
      <td>WE09ARR01_d18O</td>
      <td>Same record from two different compilations. K...</td>
    </tr>
    <tr>
      <th>50</th>
      <td>WE09ARR01_SrCa</td>
      <td>Same record from two different compilations. K...</td>
    </tr>
    <tr>
      <th>51</th>
      <td>Ocean2kHR_013_iso2k</td>
      <td>Same record from two different compilations. K...</td>
    </tr>
    <tr>
      <th>52</th>
      <td>Ocean2kHR_126_iso2k</td>
      <td>Same record from different compilations. Keepi...</td>
    </tr>
    <tr>
      <th>53</th>
      <td>Ocean2kHR_105_iso2k</td>
      <td>Same reocords. Keeping Ocean2kHR 102 and 105 a...</td>
    </tr>
    <tr>
      <th>54</th>
      <td>Ocean2kHR_102_iso2k</td>
      <td>Same reocords. Keeping Ocean2kHR 102 and 105 a...</td>
    </tr>
    <tr>
      <th>55</th>
      <td>Ocean2kHR_154_iso2k</td>
      <td>Same record from different compilation. Keepin...</td>
    </tr>
    <tr>
      <th>56</th>
      <td>GO12SBV01_d18O</td>
      <td>Same record from different compilation. Keepin...</td>
    </tr>
    <tr>
      <th>57</th>
      <td>WU13TON01_SrCa</td>
      <td>Same record from different compilations. Keepi...</td>
    </tr>
    <tr>
      <th>58</th>
      <td>Ocean2kHR_138_iso2k</td>
      <td>Same record from different compilations. Keepi...</td>
    </tr>
    <tr>
      <th>59</th>
      <td>LI94SEC01_d18O</td>
      <td>Same record from different compilations. Keepi...</td>
    </tr>
  </tbody>
</table>
</div></div><h3 class="rubric" id="iteration-1">Iteration 1</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-2">Iteration 2</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-3">Iteration 3</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-4">Iteration 4</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-5">Iteration 5</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-6">Iteration 6</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-7">Iteration 7</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-8">Iteration 8</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-9">Iteration 9</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Ocean2kHR_142_iso2k</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">duplicate</span> <span class="n">of</span> <span class="n">Ocean2kHR_142</span> <span class="n">deom</span> <span class="n">most</span> <span class="n">likely</span> <span class="n">PAGES2k</span><span class="o">.</span> <span class="n">Removing</span> <span class="n">iso2k</span> <span class="n">record</span><span class="o">.</span> <span class="n">Same</span> <span class="k">with</span> <span class="mi">156</span> <span class="ow">and</span> <span class="mi">157</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-10">Iteration 10</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">From</span> <span class="n">publications</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">GraphDB</span><span class="o">.</span> <span class="n">Different</span> <span class="n">records</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-11">Iteration 11</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">records</span><span class="o">.</span> <span class="n">Keeping</span> <span class="mf">147.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-12">Iteration 12</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span><span class="o">.</span> <span class="n">Keeping</span> <span class="mi">149</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-13">Iteration 13</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">records</span><span class="p">,</span> <span class="n">keeping</span> <span class="n">Ocean2kHR_006</span> <span class="kn">from</span><span class="w"> </span><span class="nn">PAGES2k</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-14">Iteration 14</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_019</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-15">Iteration 15</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-16">Iteration 16</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-17">Iteration 17</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_193</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-18">Iteration 18</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Two</span> <span class="n">records</span> <span class="n">but</span> <span class="n">duplicates</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_023</span> <span class="ow">and</span> <span class="mf">026.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-19">Iteration 19</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Two</span> <span class="n">records</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR</span> <span class="mi">027</span> <span class="ow">and</span> <span class="mi">025</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-20">Iteration 20</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="n">across</span> <span class="nb">all</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_133</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-21">Iteration 21</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-22">Iteration 22</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="n">across</span> <span class="nb">all</span> <span class="n">three</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_183</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-23">Iteration 23</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="n">across</span> <span class="nb">all</span> <span class="n">three</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR166</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-24">Iteration 24</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-25">Iteration 25</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-26">Iteration 26</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-27">Iteration 27</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-28">Iteration 28</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-29">Iteration 29</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-30">Iteration 30</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">two</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_099</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-31">Iteration 31</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">two</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2HR_100</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-32">Iteration 32</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-33">Iteration 33</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-34">Iteration 34</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">three</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_173</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-35">Iteration 35</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-36">Iteration 36</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">three</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_001</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-37">Iteration 37</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-38">Iteration 38</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-39">Iteration 39</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-40">Iteration 40</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">two</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_167</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-41">Iteration 41</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">two</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_094</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-42">Iteration 42</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">three</span> <span class="n">compilations</span> <span class="p">(</span><span class="n">note</span> <span class="n">that</span> <span class="n">it</span><span class="s1">&#39;s most likely from two different coral head which CoralHydro2k archived in different dataset). Keeping Ocean2kHR_007</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-43">Iteration 43</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-44">Iteration 44</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-45">Iteration 45</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-46">Iteration 46</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-47">Iteration 47</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">three</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_177</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-48">Iteration 48</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-49">Iteration 49</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">two</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">SAm_035</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-50">Iteration 50</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-51">Iteration 51</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-52">Iteration 52</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-53">Iteration 53</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Palmyra record!!!! Keeping PCU-1cce3af5639a4ec from Dee et al. (2020)
</pre></div>
</div>
<h3 class="rubric" id="iteration-54">Iteration 54</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-55">Iteration 55</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-56">Iteration 56</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-57">Iteration 57</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-58">Iteration 58</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-59">Iteration 59</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-60">Iteration 60</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-61">Iteration 61</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-62">Iteration 62</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_020</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-63">Iteration 63</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-64">Iteration 64</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-65">Iteration 65</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-66">Iteration 66</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">two</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_134</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-67">Iteration 67</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-68">Iteration 68</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-69">Iteration 69</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-70">Iteration 70</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-71">Iteration 71</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">two</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_190</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-72">Iteration 72</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">two</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_191</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-73">Iteration 73</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-74">Iteration 74</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-75">Iteration 75</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">two</span> <span class="n">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_013</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-76">Iteration 76</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-77">Iteration 77</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-78">Iteration 78</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-79">Iteration 79</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-80">Iteration 80</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_126</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-81">Iteration 81</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">reocords</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR</span> <span class="mi">102</span> <span class="ow">and</span> <span class="mi">105</span> <span class="k">as</span> <span class="n">well</span> <span class="k">as</span> <span class="n">DR00NBB01</span><span class="p">,</span> <span class="n">which</span> <span class="n">seems</span> <span class="n">to</span> <span class="n">be</span> <span class="n">unique</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-82">Iteration 82</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-83">Iteration 83</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">compilation</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_154</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-84">Iteration 84</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_159</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-85">Iteration 85</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-86">Iteration 86</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Same</span> <span class="n">record</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">compilations</span><span class="o">.</span> <span class="n">Keeping</span> <span class="n">Ocean2kHR_138</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-87">Iteration 87</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-88">Iteration 88</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<h3 class="rubric" id="iteration-89">Iteration 89</h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Records</span> <span class="kn">from</span><span class="w"> </span><span class="nn">different</span> <span class="n">samples</span><span class="o">.</span> <span class="n">Not</span> <span class="n">true</span> <span class="n">duplicates</span><span class="o">.</span>
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "d856077452a84e17a49217278c346670", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save flagged TSIDs and notes</span>
<span class="n">df_flags</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">flagged_records</span><span class="p">)</span>
<span class="n">df_flags</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;./data/flagged_tsids_with_notes.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">df_notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">group_notes</span><span class="p">)</span>
<span class="n">df_notes</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;./data/group_notes.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Cleaned dataset</span>
<span class="n">df_cleaned</span> <span class="o">=</span> <span class="n">df_copy</span><span class="p">[</span><span class="o">~</span><span class="n">df_copy</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">df_flags</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">])]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save the file</span>

<span class="n">df_cleaned</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s2">&quot;./data/cleaned_timeseries.pkl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="building-the-cfr-proxydatabase">
<h2>Building the cfr.ProxyDataBase<a class="headerlink" href="#building-the-cfr-proxydatabase" title="Link to this heading">#</a></h2>
<p>Reopen the file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_cleaned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s2">&quot;./data/cleaned_timeseries.pkl&quot;</span><span class="p">)</span>
<span class="n">df_cleaned</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dataSetName</th>
      <th>compilationName</th>
      <th>archiveType</th>
      <th>geo_meanLat</th>
      <th>geo_meanLon</th>
      <th>geo_meanElev</th>
      <th>paleoData_variableName</th>
      <th>paleoData_standardName</th>
      <th>paleoData_values</th>
      <th>paleoData_units</th>
      <th>paleoData_proxy</th>
      <th>paleoData_proxyGeneral</th>
      <th>paleoData_seasonality</th>
      <th>paleoData_interpName</th>
      <th>paleoData_interpRank</th>
      <th>TSID</th>
      <th>time_variableName</th>
      <th>time_standardName</th>
      <th>time_values</th>
      <th>time_units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Ant-WDC05A.Steig.2013</td>
      <td>Pages2kTemperature</td>
      <td>Glacier ice</td>
      <td>-79.46</td>
      <td>-112.09</td>
      <td>1806.0</td>
      <td>d18O</td>
      <td>d18O</td>
      <td>[-33.32873325, -35.6732, -33.1574, -34.2854, -...</td>
      <td>permil</td>
      <td>d18O</td>
      <td>None</td>
      <td>Annual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Ant_030</td>
      <td>year</td>
      <td>year</td>
      <td>[2005, 2004, 2003, 2002, 2001, 2000, 1999, 199...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>1</th>
      <td>NAm-MtLemon.Briffa.2002</td>
      <td>Pages2kTemperature</td>
      <td>Wood</td>
      <td>32.50</td>
      <td>-110.80</td>
      <td>2700.0</td>
      <td>MXD</td>
      <td>MXD</td>
      <td>[0.968, 0.962, 1.013, 0.95, 1.008, 0.952, 1.02...</td>
      <td>None</td>
      <td>maximum latewood density</td>
      <td>dendrophysical</td>
      <td>Summer</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>NAm_568</td>
      <td>year</td>
      <td>year</td>
      <td>[1568, 1569, 1570, 1571, 1572, 1573, 1574, 157...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Arc-Arjeplog.Bjorklund.2014</td>
      <td>Pages2kTemperature</td>
      <td>Wood</td>
      <td>66.30</td>
      <td>18.20</td>
      <td>800.0</td>
      <td>density</td>
      <td>density</td>
      <td>[-0.829089212152348, -0.733882889924006, -0.89...</td>
      <td>None</td>
      <td>maximum latewood density</td>
      <td>dendrophysical</td>
      <td>Jun-Aug</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Arc_060</td>
      <td>year</td>
      <td>year</td>
      <td>[1200, 1201, 1202, 1203, 1204, 1205, 1206, 120...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Asi-CHIN019.Li.2010</td>
      <td>Pages2kTemperature</td>
      <td>Wood</td>
      <td>29.15</td>
      <td>99.93</td>
      <td>2150.0</td>
      <td>ringWidth</td>
      <td>ringWidth</td>
      <td>[1.465, 1.327, 1.202, 0.757, 1.094, 1.006, 1.2...</td>
      <td>None</td>
      <td>ring width</td>
      <td>dendrophysical</td>
      <td>Annual</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>Asia_041</td>
      <td>year</td>
      <td>year</td>
      <td>[1509, 1510, 1511, 1512, 1513, 1514, 1515, 151...</td>
      <td>yr AD</td>
    </tr>
    <tr>
      <th>4</th>
      <td>NAm-Landslide.Luckman.2006</td>
      <td>Pages2kTemperature</td>
      <td>Wood</td>
      <td>60.20</td>
      <td>-138.50</td>
      <td>800.0</td>
      <td>ringWidth</td>
      <td>ringWidth</td>
      <td>[1.123, 0.841, 0.863, 1.209, 1.139, 1.056, 0.8...</td>
      <td>None</td>
      <td>ring width</td>
      <td>dendrophysical</td>
      <td>Summer</td>
      <td>temperature</td>
      <td>NaN</td>
      <td>NAm_1876</td>
      <td>year</td>
      <td>year</td>
      <td>[913, 914, 915, 916, 917, 918, 919, 920, 921, ...</td>
      <td>yr AD</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="adding-ptype-and-seasonality-info">
<h3>Adding ptype and seasonality info<a class="headerlink" href="#adding-ptype-and-seasonality-info" title="Link to this heading">#</a></h3>
<p>LiPD files contain seasonality (in months or phrases) and the necessary information to create a <em>cfr</em> ‘ptype’. The  ‘ptype’ is simply the proxy archive and variable name, for example d18O of coral would be <code class="docutils literal notranslate"><span class="pre">coral.d18O</span></code>.  The seasonality on the other hand, requires some conversion between month to the numerical list format that <em>cfr</em> accepts. For example, for a growing season of June, July, August, the <em>cfr</em> seasonality will be <code class="docutils literal notranslate"><span class="pre">[6,7,8]</span></code>. In the following two functions <code class="docutils literal notranslate"><span class="pre">convert_seasonality</span></code> and <code class="docutils literal notranslate"><span class="pre">create_ptype</span></code>, we can get the original dataFrame columns into the format we need for assimilation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">convert_seasonality</span><span class="p">(</span><span class="n">seasonality_str</span><span class="p">,</span> <span class="n">latitude</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert LiPD seasonality strings to CFR month lists</span>
<span class="sd">    CFR expects lists like [6,7,8] for JJA, [12,1,2] for DJF, etc.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        seasonality_str: String representation of seasonality from LiPD</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        list: List of month integers, or list(range(1,13)) for annual/None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Default to annual for None/NaN</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">seasonality_str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">seasonality_str</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">seasonality_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
        
    <span class="n">seasonality_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">seasonality_str</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># Hemisphere-aware mapping for Summer/Winter and Growing season</span>
    <span class="k">if</span> <span class="n">seasonality_str</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Summer&#39;</span><span class="p">,</span> <span class="s1">&#39;Winter&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">latitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">latitude</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># NH</span>
            <span class="k">if</span> <span class="n">seasonality_str</span> <span class="o">==</span> <span class="s1">&#39;Summer&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>  <span class="c1"># JJA</span>
            <span class="k">elif</span> <span class="n">seasonality_str</span> <span class="o">==</span> <span class="s1">&#39;Winter&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># DJF</span>
        <span class="k">elif</span> <span class="n">latitude</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># SH</span>
            <span class="k">if</span> <span class="n">seasonality_str</span> <span class="o">==</span> <span class="s1">&#39;Summer&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># DJF in NH = Summer in SH</span>
            <span class="k">elif</span> <span class="n">seasonality_str</span> <span class="o">==</span> <span class="s1">&#39;Winter&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>   <span class="c1"># JJA in NH = Winter in SH</span>
            
    <span class="k">if</span> <span class="n">seasonality_str</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Growing Season&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">latitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">latitude</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># NH</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>  <span class="c1"># Apr-Sept</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># SH</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># Oct-Mar   </span>
    
    <span class="c1"># Exact mapping for your specific seasonality patterns</span>
    <span class="n">seasonality_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Annual&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)),</span>
        <span class="s1">&#39;Jun-Aug&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
        <span class="s1">&#39;Nov-Feb&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="s1">&#39;May-Apr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>  <span class="c1"># May to next April</span>
        <span class="s1">&#39;Jun-Jul&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
        <span class="s1">&#39;Mar-May&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
        <span class="s1">&#39;subannual&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)),</span>  <span class="c1"># Default to annual??</span>
        <span class="s1">&#39;Sep-Apr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
        <span class="s1">&#39;Jul&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">],</span>
        <span class="s1">&#39;Dec-Feb&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="s1">&#39;Apr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span>
        <span class="s1">&#39;Jul-Jun&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>  <span class="c1"># Jul to next June</span>
        <span class="s1">&#39;Sep-Nov&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
        <span class="s1">&#39;Nov-Oct&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>  <span class="c1"># Nov to next Oct</span>
        <span class="s1">&#39;Apr-Jul&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
        <span class="s1">&#39;Jul-Sep&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
        <span class="s1">&#39;Oct-Apr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
        <span class="s1">&#39;Nov-Apr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
        <span class="s1">&#39;Apr-Sep&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
        <span class="s1">&#39;Dec-Mar&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
        <span class="s1">&#39;Aug-Jul&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>  <span class="c1"># Aug to next July</span>
        <span class="s1">&#39;Jun-Sep&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
        <span class="s1">&#39;Sep-Aug&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>  <span class="c1"># Sep to next Aug</span>
        <span class="s1">&#39;Mar-Aug&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
        <span class="s1">&#39;Jun&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">6</span><span class="p">],</span>
        <span class="s1">&#39;May-Sep&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
        <span class="s1">&#39;Feb-Aug&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
        <span class="s1">&#39;Jul-Dec&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span>
        <span class="s1">&#39;Mar-Oct&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
        <span class="s1">&#39;May-Jul&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
        <span class="s1">&#39;Jan-Mar&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
        <span class="s1">&#39;Apr-Jun&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
    <span class="p">}</span>
    
    <span class="c1"># Direct lookup</span>
    <span class="k">if</span> <span class="n">seasonality_str</span> <span class="ow">in</span> <span class="n">seasonality_map</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">seasonality_map</span><span class="p">[</span><span class="n">seasonality_str</span><span class="p">]</span>
    
    <span class="c1"># If no pattern matches, default to annual</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not parse seasonality &#39;</span><span class="si">{</span><span class="n">seasonality_str</span><span class="si">}</span><span class="s2">&#39;, defaulting to annual&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_ptype</span><span class="p">(</span><span class="n">archive_type</span><span class="p">,</span> <span class="n">proxy_standard_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine CFR proxy type from LiPD archive and proxy information</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        archive_type: LiPD archiveType</span>
<span class="sd">        proxy_standard_name: LiPD paleoData_standardName</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        str: CFR-compatible proxy type string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">archive_type</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">archive_type</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">proxy_standard_name</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">proxy_standard_name</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;unknown&#39;</span>
    
    <span class="k">if</span> <span class="s1">&#39;wood&#39;</span> <span class="ow">in</span> <span class="n">archive</span> <span class="ow">or</span> <span class="s1">&#39;tree&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;ring width&#39;</span> <span class="ow">in</span> <span class="n">proxy</span> <span class="ow">or</span> <span class="s1">&#39;trw&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;tree.TRW&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;density&#39;</span> <span class="ow">in</span> <span class="n">proxy</span> <span class="ow">or</span> <span class="s1">&#39;mxd&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;tree.MXD&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;tree.TRW&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;coral&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;d18o&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;coral.d18O&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;sr/ca&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;coral.SrCa&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;calcification&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;coral.calc&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;coral.d18O&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;ice&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;dD&#39;</span> <span class="ow">in</span> <span class="n">proxy</span> <span class="ow">or</span> <span class="s1">&#39;d2H&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;ice.dD&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;melt&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;ice.melt&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;ice.d18O&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;lake&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;varve thickness&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;lake.varve_thickness&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;varve&#39;</span> <span class="ow">in</span> <span class="n">proxy</span> <span class="ow">and</span> <span class="s1">&#39;thickness&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;lake.varve_property&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;chironomid&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;lake.chironomid&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;midge&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;lake.midge&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;reflectance&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;lake.reflectance&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;bsi&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;lake.BSi&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;accumulation&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;lake.accumulation&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;lake.other&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;marine&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;alkenone&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;marine.alkenone&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;mg/ca&#39;</span> <span class="ow">in</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;marine.MgCa&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;marine.other&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;documents&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;documents&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;borehole&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;borehole&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;speleothem&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;speleothem.d18O&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;sclerosponge&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;sclerosponge.d18O&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;bivalve&#39;</span> <span class="ow">in</span> <span class="n">archive</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;bivalve.d18O&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;hybrid&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Paleodata can sometimes be published in descending time order rather than ascending. This creates a problem for us since the <code class="docutils literal notranslate"><span class="pre">cfr.ProxyRecord.dt</span></code> or the median time difference between data points will register the dt &lt; 0  when the time values are in descending order. To prevent this issue before creating any proxy databases, we will use <code class="docutils literal notranslate"><span class="pre">flip_df</span></code> to reverse the time values that are incorrect to keep it consistent.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">flip_df</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fix reverse time series in DataFrame </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">df_fixed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">fixed_count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_fixed</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">time_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">])</span>
        <span class="n">paleo_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Check if time is descending (reverse)</span>
            <span class="k">if</span> <span class="n">time_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">time_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># Flip both arrays</span>
                <span class="n">df_fixed</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;time_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_values</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">df_fixed</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;paleoData_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">paleo_values</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">fixed_count</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fixed </span><span class="si">{</span><span class="n">fixed_count</span><span class="si">}</span><span class="s2"> reverse time series in DataFrame&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_fixed</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># apply the seasonality into new column </span>

<span class="n">df_cleaned</span><span class="p">[</span><span class="s1">&#39;cfr_seasonality&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cleaned</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">convert_seasonality</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_seasonality&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">]),</span>
                                                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># apply ptype conversion into new column</span>

<span class="n">df_cleaned</span><span class="p">[</span><span class="s1">&#39;cfr_ptype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cleaned</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">create_ptype</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;archiveType&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_standardName&#39;</span><span class="p">]),</span> 
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create new dataframe with correctly reversed time/data values</span>

<span class="n">df_cleaned_flip</span> <span class="o">=</span> <span class="n">flip_df</span><span class="p">(</span><span class="n">df_cleaned</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fixed 173 reverse time series in DataFrame
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cfr.ProxyDatabase</span></code> object takes in very specific parameters such as latitude, longitude, elevation, ptype, seasonality, and of course the time and data value. All of this is provided in the dataFrame, so <code class="docutils literal notranslate"><span class="pre">create_pdb</span></code> will seamlessly convert our necessary df columns into a cfr.Proxydatabase with all necessary data to be able to work in a data assimilation workflow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_pdb</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create CFR ProxyDatabase from DataFrame that already has cfr_seasonality and cfr_ptype columns</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame with cfr_seasonality and cfr_ptype columns</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        cfr.ProxyDatabase: Ready-to-use CFR ProxyDatabase with seasonality</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating CFR ProxyDatabase from enhanced DataFrame...&quot;</span><span class="p">)</span>
    
    <span class="n">records_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">skipped_records</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Processing </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get the complete time and value arrays directly</span>
            <span class="n">time_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">])</span>
            <span class="n">paleo_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">])</span>
            
            <span class="c1"># Basic validation to make sure lengths match</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paleo_values</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">skipped_records</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            
            <span class="c1"># Remove any NaN values</span>
            <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">time_values</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">paleo_values</span><span class="p">))</span>
            <span class="n">time_values</span> <span class="o">=</span> <span class="n">time_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            <span class="n">paleo_values</span> <span class="o">=</span> <span class="n">paleo_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">skipped_records</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            
            <span class="c1"># Basic info (LiPD&#39;s tsid = cfr&#39;s pid)</span>
            <span class="n">dataset_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;dataSetName&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Dataset_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">tsid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;TS_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span>
            
            <span class="c1"># Location</span>
            <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLat&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="n">lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanLon&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="mf">0.0</span>
            
            <span class="c1"># Handle elevation</span>
            <span class="n">elev</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanElev&#39;</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">elev_val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;geo_meanElev&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">elev_val</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;na&#39;</span><span class="p">,</span> <span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
                        <span class="n">elev</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">elev_val</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">elev</span> <span class="o">=</span> <span class="mf">0.0</span>
            
            <span class="c1"># Use the pre-computed CFR columns</span>
            <span class="n">seasonality</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cfr_seasonality&#39;</span><span class="p">]</span>
            <span class="n">ptype</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cfr_ptype&#39;</span><span class="p">]</span>
            
            <span class="c1"># Optional metadata</span>
            <span class="n">value_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_variableName&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">value_unit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_units&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;paleoData_units&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="kc">None</span>
            
            <span class="c1"># Create ProxyRecord directly</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ProxyRecord</span><span class="p">(</span>
                <span class="n">pid</span><span class="o">=</span><span class="n">tsid</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">time_values</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">paleo_values</span><span class="p">,</span>
                <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
                <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span>
                <span class="n">elev</span><span class="o">=</span><span class="n">elev</span><span class="p">,</span>
                <span class="n">ptype</span><span class="o">=</span><span class="n">ptype</span><span class="p">,</span>
                <span class="n">seasonality</span><span class="o">=</span><span class="n">seasonality</span><span class="p">,</span>
                <span class="n">value_name</span><span class="o">=</span><span class="n">value_name</span><span class="p">,</span>
                <span class="n">value_unit</span><span class="o">=</span><span class="n">value_unit</span>
            <span class="p">)</span>
            
            <span class="n">records_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Error processing record </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">skipped_records</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
    
    <span class="c1"># Create empty ProxyDatabase</span>
    <span class="n">proxy_db</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ProxyDatabase</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records_list</span><span class="p">:</span>
        <span class="n">proxy_db</span> <span class="o">+=</span> <span class="n">record</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created CFR ProxyDatabase with </span><span class="si">{</span><span class="n">proxy_db</span><span class="o">.</span><span class="n">nrec</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">skipped_records</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Skipped </span><span class="si">{</span><span class="n">skipped_records</span><span class="si">}</span><span class="s2"> records due to data issues&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">proxy_db</span>
</pre></div>
</div>
</div>
</div>
<p>Once our functions are created to go from a dataFrame into a ProxyDatabase, we will branch off into two options for the data assimilation step.</p>
<ul class="simple">
<li><p><strong>Option 1</strong>: Filter without interpolation</p>
<ul>
<li><p>Create cfr.ProxyDatabase -&gt; filter by dt &lt;= 1 (annual + subannual only) -&gt; save as ‘pdb_w_seasonality_annual.pkl’</p></li>
</ul>
</li>
<li><p><strong>Option 2</strong>: Filter with interpolation</p>
<ul>
<li><p>For records with dt &lt;= 5, interpolate to annual then refilter.</p></li>
<li><p>Create cfr.ProxyDatabase -&gt; pyleo.interp -&gt; filter by dt &lt;=1 -&gt; save as ‘pdb_wseasonality_interp.pkl’</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="quick-debug-before-saving-proxydatabases">
<h2>Quick debug before saving ProxyDatabases<a class="headerlink" href="#quick-debug-before-saving-proxydatabases" title="Link to this heading">#</a></h2>
<p>The main thing we want to make sure here is that seasonality is preserved when we convert from a pandas Dataframe to cfr.ProxyDatabase and then to a pickle file. Here we run a quick check just to make sure the important information is saved for all the records.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &gt;&gt; Converting to CFR ProxyDatabase...&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">unfiltered_pdb</span> <span class="o">=</span> <span class="n">create_pdb</span><span class="p">(</span><span class="n">df_cleaned_flip</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SUCCESS: ProxyDatabase created with </span><span class="si">{</span><span class="n">unfiltered_pdb</span><span class="o">.</span><span class="n">nrec</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Proxy types:&quot;</span><span class="p">,</span> <span class="n">unfiltered_pdb</span><span class="o">.</span><span class="n">type_dict</span><span class="p">)</span>
    
    <span class="c1"># Verify seasonality is preserved</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Seasonality verification:&quot;</span><span class="p">)</span>
    <span class="n">seasonality_preserved</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">unfiltered_pdb</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seasonality_preserved</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Records with seasonality: </span><span class="si">{</span><span class="n">seasonality_preserved</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">unfiltered_pdb</span><span class="o">.</span><span class="n">nrec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Show a sample record</span>
    <span class="n">sample_pid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unfiltered_pdb</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sample_record</span> <span class="o">=</span> <span class="n">unfiltered_pdb</span><span class="o">.</span><span class="n">records</span><span class="p">[</span><span class="n">sample_pid</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample CFR ProxyRecord:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  PID: </span><span class="si">{</span><span class="n">sample_record</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Type: </span><span class="si">{</span><span class="n">sample_record</span><span class="o">.</span><span class="n">ptype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Seasonality: </span><span class="si">{</span><span class="n">sample_record</span><span class="o">.</span><span class="n">seasonality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Time points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_record</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Location: (</span><span class="si">{</span><span class="n">sample_record</span><span class="o">.</span><span class="n">lat</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">sample_record</span><span class="o">.</span><span class="n">lon</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR creating CFR ProxyDatabase: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==================================================
 &gt;&gt; Converting to CFR ProxyDatabase...
Creating CFR ProxyDatabase from enhanced DataFrame...
  Processing 0/684...
  Processing 100/684...
  Processing 200/684...
  Processing 300/684...
  Processing 400/684...
  Processing 500/684...
  Processing 600/684...
Created CFR ProxyDatabase with 684 records
SUCCESS: ProxyDatabase created with 684 records
Proxy types: {&#39;ice.d18O&#39;: 47, &#39;tree.MXD&#39;: 59, &#39;tree.TRW&#39;: 355, &#39;lake.other&#39;: 42, &#39;marine.other&#39;: 57, &#39;documents&#39;: 15, &#39;lake.reflectance&#39;: 1, &#39;coral.SrCa&#39;: 33, &#39;coral.d18O&#39;: 58, &#39;ice.melt&#39;: 2, &#39;borehole&#39;: 3, &#39;speleothem.d18O&#39;: 4, &#39;coral.calc&#39;: 2, &#39;sclerosponge.d18O&#39;: 5, &#39;hybrid&#39;: 1}

Seasonality verification:
Records with seasonality: 684/684

Sample CFR ProxyRecord:
  PID: Ant_030
  Type: ice.d18O
  Seasonality: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
  Time points: 1220
  Location: (-79.46, 247.91)
</pre></div>
</div>
</div>
</div>
<section id="option-1-filter-by-dt-1">
<h3>Option 1: Filter by dt &lt;= 1<a class="headerlink" href="#option-1-filter-by-dt-1" title="Link to this heading">#</a></h3>
<p>This option is more direct, as we will use <em>cfr</em>’s capabilities alone to restrict the Proxy Database to only annual and subannual records. Then we will save it as a pickle file as to preserve the seasonality and also as a netCDF (for future purposes).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Option 1 with filtering by resolution (annual and subannual only)</span>

<span class="n">filtered_pdb_1</span> <span class="o">=</span> <span class="n">unfiltered_pdb</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_pdb_1</span><span class="o">.</span><span class="n">records</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>559
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save as NetCDF (without seasonality preserved)</span>

<span class="n">filtered_pdb_1</span><span class="o">.</span><span class="n">to_nc</span><span class="p">(</span><span class="s1">&#39;./prev_data/pdb_w_seasonality_annual.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Warning: this is an experimental feature.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Warning: this is an experimental feature.</span>

</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 559/559 [00:20&lt;00:00, 27.57it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Data before 1 CE is dropped for records: [&#39;Arc_032&#39;, &#39;SAm_025&#39;, &#39;Arc_025&#39;, &#39;Arc_002&#39;, &#39;Aus_041&#39;, &#39;Arc_031&#39;, &#39;Eur_017&#39;, &#39;Arc_021&#39;, &#39;NAm_880&#39;, &#39;Ant_031dD&#39;, &#39;Ant_031&#39;, &#39;NAm_664&#39;, &#39;Ant_022&#39;, &#39;Arc_020&#39;, &#39;Eur_014&#39;, &#39;Arc_004&#39;].</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">ProxyDatabase saved to: ./prev_data/pdb_w_seasonality_annual.nc</span>

</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pickle_path</span> <span class="o">=</span> <span class="s1">&#39;./prev_data/pdb_w_seasonality_annual.pkl&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">filtered_pdb_1</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use pickle to save proxyDatabase</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving with seasonality preservation using pickle...&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Saved to pickle: </span><span class="si">{</span><span class="n">pickle_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Test loading from pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">test_db_pickle</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Loaded from pickle: </span><span class="si">{</span><span class="n">test_db_pickle</span><span class="o">.</span><span class="n">nrec</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>

<span class="c1"># Verify seasonality is preserved in pickle</span>
<span class="n">seasonality_pickle</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">test_db_pickle</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
    <span class="k">elif</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Annual [1-12]&quot;</span>
    <span class="k">elif</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="o">==</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Summer [6, 7, 8]&quot;</span>
    <span class="k">elif</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="o">==</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Winter [12, 1, 2]&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">seasonality</span><span class="p">)</span>
    
    <span class="n">seasonality_pickle</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">seasonality_pickle</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Seasonality distribution in pickle-loaded database:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">season</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seasonality_pickle</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Show examples</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Example records from pickle with their seasonality:&quot;</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">test_db_pickle</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">ptype</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">seasonality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># Verify counts</span>
<span class="n">pickle_custom_seasonality</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">test_db_pickle</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> 
                               <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">seasonality</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">seasonality</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)))</span>
<span class="n">pickle_none_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">test_db_pickle</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">seasonality</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Debugging checks</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pickle verification:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Records with custom seasonality: </span><span class="si">{</span><span class="n">pickle_custom_seasonality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Records with None seasonality: </span><span class="si">{</span><span class="n">pickle_none_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Records with annual seasonality: </span><span class="si">{</span><span class="n">test_db_pickle</span><span class="o">.</span><span class="n">nrec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pickle_custom_seasonality</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pickle_none_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">pickle_custom_seasonality</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SUCCESS: Seasonality preserved in pickle format!&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️  Still having issues with seasonality preservation&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File: </span><span class="si">{</span><span class="n">pickle_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving with seasonality preservation using pickle...
✓ Saved to pickle: ./prev_data/pdb_w_seasonality_annual.pkl
✓ Loaded from pickle: 559 records

Seasonality distribution in pickle-loaded database:
  Summer [6, 7, 8]: 307
  Annual [1-12]: 213
  [6, 7]: 6
  [5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4]: 4
  [9, 10, 11, 12, 1, 2, 3, 4]: 4
  Winter [12, 1, 2]: 4
  [7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6]: 2
  [7, 8, 9]: 2
  [6]: 2
  [7]: 2

Example records from pickle with their seasonality:
  NAm_568: tree.MXD -&gt; [6, 7, 8]
  Arc_060: tree.MXD -&gt; [6, 7, 8]
  NAm_1876: tree.TRW -&gt; [6, 7, 8]
  NAm_1108: tree.TRW -&gt; [6, 7, 8]
  NAm_1120: tree.MXD -&gt; [6, 7, 8]
  Asia_102: tree.TRW -&gt; [6, 7, 8]
  SAm_025: lake.other -&gt; [11, 12, 1, 2]
  NAm_1396: tree.TRW -&gt; [6, 7, 8]
  NAm_220: tree.TRW -&gt; [6, 7, 8]
  SAm_020: tree.TRW -&gt; [5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4]

Pickle verification:
  Records with custom seasonality: 346
  Records with None seasonality: 0
  Records with annual seasonality: 213

✅ SUCCESS: Seasonality preserved in pickle format!
   Use pickle format for now until CFR NetCDF seasonality support is fixed.

============================================================
File: ./prev_data/pdb_w_seasonality_annual.pkl
</pre></div>
</div>
</div>
</div>
</section>
<section id="option-2-interpolated-then-filtered-by-annual-subannual">
<h3>Option 2: Interpolated then filtered by annual/subannual<a class="headerlink" href="#option-2-interpolated-then-filtered-by-annual-subannual" title="Link to this heading">#</a></h3>
<p>This step is more involved than the last. Firstly we will take all records within a median of 5 year resolution. Then we will use Pyleoclim’s <code class="docutils literal notranslate"><span class="pre">pyleo.interp</span></code> to interpolate those resolutions to make them annual.  Then in order to preserve their original time and data values, we will duplicate only the rows (matching ‘TSID’) of those records with dt&lt;5 such that we have one that is annual and one that is the original. Once that is done, we can re implement the annual/subannual filter. For each interpolated record, the code will output the new number of data points to confirm that it does what is required.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">to_interp</span> <span class="o">=</span> <span class="n">unfiltered_pdb</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">5.1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We take record of the TSIDs of the records that are being interpolated so we can duplicate and preserve their information later in an unaltered format.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a list to store new interpolated rows</span>
<span class="n">new_rows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">failed_reasons</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="n">to_interp</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">pobj</span> <span class="ow">in</span> <span class="n">df_cleaned_flip</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
        <span class="c1"># Find the matching row</span>
        <span class="n">row_idx</span> <span class="o">=</span> <span class="n">df_cleaned_flip</span><span class="p">[</span><span class="n">df_cleaned_flip</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pobj</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">original_row</span> <span class="o">=</span> <span class="n">df_cleaned_flip</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Get the data</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">original_row</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">original_row</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">])</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Trying </span><span class="si">{</span><span class="n">pobj</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Original data: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> points, range </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Clean data (remove NaNs)</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">x_clean</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">y_clean</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  After cleaning: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_clean</span><span class="p">)</span><span class="si">}</span><span class="s2"> points&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_clean</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">failed_reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pobj</span><span class="si">}</span><span class="s2">: Not enough points (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_clean</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
            
        <span class="c1"># Check if data is sorted</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x_clean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># Sort the data</span>
            <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">x_clean</span><span class="p">)</span>
            <span class="n">x_clean</span> <span class="o">=</span> <span class="n">x_clean</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
            <span class="n">y_clean</span> <span class="o">=</span> <span class="n">y_clean</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Data was unsorted, now sorted&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Calculate step manually to avoid pyleoclim&#39;s step calculation</span>
            <span class="n">time_diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x_clean</span><span class="p">)</span>
            <span class="n">median_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">time_diffs</span><span class="p">)</span>
            <span class="n">target_step</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Annual</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Current median step: </span><span class="si">{</span><span class="n">median_step</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, target: </span><span class="si">{</span><span class="n">target_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Use explicit start/stop/step</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">x_clean</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">stop_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x_clean</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> 
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Interpolation range: </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">stop_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">stop_time</span> <span class="o">&lt;=</span> <span class="n">start_time</span><span class="p">:</span>
                <span class="n">failed_reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pobj</span><span class="si">}</span><span class="s2">: Invalid time range&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="c1"># Try pyleoclim with explicit parameters</span>
            <span class="n">x_interp</span><span class="p">,</span> <span class="n">y_interp</span> <span class="o">=</span> <span class="n">pyleo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">tsutils</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                <span class="n">x_clean</span><span class="p">,</span> <span class="n">y_clean</span><span class="p">,</span>
                <span class="n">interp_type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                <span class="n">start</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
                <span class="n">stop</span><span class="o">=</span><span class="n">stop_time</span><span class="p">,</span>
                <span class="n">step</span><span class="o">=</span><span class="n">target_step</span><span class="p">,</span>
                <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span>
            <span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  SUCCESS: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_interp</span><span class="p">)</span><span class="si">}</span><span class="s2"> interpolated points&quot;</span><span class="p">)</span>
            
            <span class="c1"># Create duplicate with interpolated data</span>
            <span class="n">interp_row</span> <span class="o">=</span> <span class="n">original_row</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">interp_row</span><span class="p">[</span><span class="s1">&#39;time_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_interp</span>
            <span class="n">interp_row</span><span class="p">[</span><span class="s1">&#39;paleoData_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_interp</span>
            <span class="n">interp_row</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">original_row</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_interp&#39;</span>
            
            <span class="n">new_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp_row</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">failed_reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pobj</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  FAILED: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== RESULTS ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully interpolated: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_rows</span><span class="p">)</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">failed_reasons</span><span class="p">)</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">failed_reasons</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># Show first 5 failures</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trying O2kLR_045:
  Original data: 516 points, range 1.5 to 2001.0
  After cleaning: 516 points
  Current median step: 4.000, target: 1.0
  Interpolation range: 2.0 to 2001.0
  SUCCESS: 2000 interpolated points

Trying Ocean2kHR_194:
  Original data: 57 points, range 1708.0 to 1988.0
  After cleaning: 57 points
  Current median step: 5.000, target: 1.0
  Interpolation range: 1708.0 to 1988.0
  SUCCESS: 281 interpolated points

Trying Ocean2kHR_193:
  Original data: 57 points, range 1708.0 to 1988.0
  After cleaning: 57 points
  Current median step: 5.000, target: 1.0
  Interpolation range: 1708.0 to 1988.0
  SUCCESS: 281 interpolated points

Trying Eur_001:
  Original data: 717 points, range -90.0 to 1935.0
  After cleaning: 717 points
  Data was unsorted, now sorted
  Current median step: 2.500, target: 1.0
  Interpolation range: -90.0 to 1935.0
  SUCCESS: 2026 interpolated points

Trying Ant_009:
  Original data: 231 points, range 423.8 to 1467.2
  After cleaning: 231 points
  Current median step: 4.440, target: 1.0
  Interpolation range: 424.0 to 1467.0
  SUCCESS: 1044 interpolated points

Trying NAm_3870:
  Original data: 2678 points, range -6015.0 to 1716.0
  After cleaning: 2678 points
  Data was unsorted, now sorted
  Current median step: 2.000, target: 1.0
  Interpolation range: -6015.0 to 1716.0
  SUCCESS: 7732 interpolated points

Trying LPD335d863f:
  Original data: 404 points, range 1140.4 to 2001.3
  After cleaning: 404 points
  Current median step: 1.871, target: 1.0
  Interpolation range: 1141.0 to 2001.0
  SUCCESS: 861 interpolated points

Trying O2kLR_150:
  Original data: 82 points, range 1568.0 to 1983.0
  After cleaning: 82 points
  Current median step: 5.000, target: 1.0
  Interpolation range: 1568.0 to 1983.0
  SUCCESS: 416 interpolated points

Trying Ocean2kHR_125:
  Original data: 25 points, range 1833.0 to 1904.0
  After cleaning: 25 points
  Current median step: 3.000, target: 1.0
  Interpolation range: 1833.0 to 1904.0
  SUCCESS: 72 interpolated points

Trying LPDb7ba9166:
  Original data: 165 points, range 74.0 to 2001.0
  After cleaning: 165 points
  Data was unsorted, now sorted
  Current median step: 3.000, target: 1.0
  Interpolation range: 74.0 to 2001.0
  SUCCESS: 1928 interpolated points

Trying Arc_056:
  Original data: 397 points, range 3.0 to 1983.0
  After cleaning: 397 points
  Current median step: 5.000, target: 1.0
  Interpolation range: 3.0 to 1983.0
  SUCCESS: 1981 interpolated points

Trying Ocean2kHR_129:
  Original data: 134 points, range 1384.0 to 1992.0
  After cleaning: 113 points
  Current median step: 5.000, target: 1.0
  Interpolation range: 1384.0 to 1992.0
  SUCCESS: 609 interpolated points

Trying Ocean2kHR_128:
  Original data: 133 points, range 1389.0 to 1992.0
  After cleaning: 118 points
  Current median step: 5.000, target: 1.0
  Interpolation range: 1389.0 to 1992.0
  SUCCESS: 604 interpolated points

Trying Eur_008:
  Original data: 875 points, range -1949.0 to 2000.0
  After cleaning: 875 points
  Data was unsorted, now sorted
  Current median step: 3.000, target: 1.0
  Interpolation range: -1949.0 to 2000.0
  SUCCESS: 3950 interpolated points

Trying NAm_3867:
  Original data: 197 points, range 1120.0 to 1900.0
  After cleaning: 197 points
  Current median step: 4.000, target: 1.0
  Interpolation range: 1120.0 to 1900.0
  SUCCESS: 781 interpolated points

Trying NAm_3868:
  Original data: 197 points, range 1120.0 to 1900.0
  After cleaning: 197 points
  Current median step: 4.000, target: 1.0
  Interpolation range: 1120.0 to 1900.0
  SUCCESS: 781 interpolated points

Trying Ocean2kHR_126:
  Original data: 187 points, range 1344.0 to 1991.0
  After cleaning: 175 points
  Current median step: 3.000, target: 1.0
  Interpolation range: 1344.0 to 1991.0
  SUCCESS: 648 interpolated points

Trying Ocean2kHR_127:
  Original data: 184 points, range 1356.0 to 1991.0
  After cleaning: 170 points
  Current median step: 3.000, target: 1.0
  Interpolation range: 1356.0 to 1991.0
  SUCCESS: 636 interpolated points

Trying Arc_043:
  Original data: 395 points, range 1.0 to 1971.0
  After cleaning: 395 points
  Current median step: 5.000, target: 1.0
  Interpolation range: 1.0 to 1971.0
  SUCCESS: 1971 interpolated points

Trying LPDe51d17e8:
  Original data: 566 points, range 1221.0 to 1990.0
  After cleaning: 566 points
  Current median step: 1.480, target: 1.0
  Interpolation range: 1222.0 to 1990.0
  SUCCESS: 769 interpolated points

Trying Ant_035:
  Original data: 1160 points, range -993.4 to 1937.1
  After cleaning: 1055 points
  Current median step: 2.500, target: 1.0
  Interpolation range: -993.0 to 1937.0
  SUCCESS: 2931 interpolated points

Trying Ocean2kHR_125_iso2k:
  Original data: 25 points, range 1833.0 to 1904.0
  After cleaning: 25 points
  Current median step: 3.000, target: 1.0
  Interpolation range: 1833.0 to 1904.0
  SUCCESS: 72 interpolated points

Trying Ocean2kHR_128_iso2k:
  Original data: 133 points, range 1389.0 to 1992.0
  After cleaning: 118 points
  Current median step: 5.000, target: 1.0
  Interpolation range: 1389.0 to 1992.0
  SUCCESS: 604 interpolated points

Trying DR00NBB01_d18O:
  Original data: 25 points, range 1833.0 to 1904.0
  After cleaning: 25 points
  Current median step: 3.000, target: 1.0
  Interpolation range: 1833.0 to 1904.0
  SUCCESS: 72 interpolated points

Trying RO19PAR01_SrCa:
  Original data: 97 points, range 1445.5 to 1669.5
  After cleaning: 97 points
  Current median step: 1.500, target: 1.0
  Interpolation range: 1446.0 to 1669.0
  SUCCESS: 224 interpolated points

Trying HE02GBR01_d18O:
  Original data: 84 points, range 1568.0 to 1983.0
  After cleaning: 82 points
  Current median step: 5.000, target: 1.0
  Interpolation range: 1568.0 to 1983.0
  SUCCESS: 416 interpolated points

Trying HE02GBR01_SrCa:
  Original data: 84 points, range 1568.0 to 1983.0
  After cleaning: 82 points
  Current median step: 5.000, target: 1.0
  Interpolation range: 1568.0 to 1983.0
  SUCCESS: 416 interpolated points

=== RESULTS ===
Successfully interpolated: 27 records
Failed: 0 records
</pre></div>
</div>
</div>
</div>
<p>We then combine the dataframe to include both the interpolated records as well as the originals. The total number should be original total + interpolated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_rows_dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">row</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">new_rows</span><span class="p">]</span>
<span class="n">df_with_interp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_cleaned_flip</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_rows_dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Corrected dataframe shape: </span><span class="si">{</span><span class="n">df_with_interp</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Original records: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_cleaned_flip</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Interpolated records: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_rows</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_with_interp</span><span class="p">)</span><span class="si">}</span><span class="s2"> (should be </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_cleaned_flip</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">new_rows</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Verify we have the right number of interpolated records</span>
<span class="n">interp_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df_with_interp</span><span class="p">[</span><span class="s1">&#39;TSID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;_interp&#39;</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Interpolated records in dataframe: </span><span class="si">{</span><span class="n">interp_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Corrected dataframe shape: (711, 22)
  Original records: 684
  Interpolated records: 27
  Total: 711 (should be 711)
  Interpolated records in dataframe: 27
</pre></div>
</div>
</div>
</div>
<p>Now we run the same process as we did in <strong>Option 1</strong> to convert our new combined dataFrame into a proxyDatabase. We will once again save this resulting proxyDataBase as a pickle and a netCDF.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Converting to CFR ProxyDatabase...&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">interp_pdb</span> <span class="o">=</span> <span class="n">create_pdb</span><span class="p">(</span><span class="n">df_with_interp</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SUCCESS: ProxyDatabase created with </span><span class="si">{</span><span class="n">interp_pdb</span><span class="o">.</span><span class="n">nrec</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Proxy types:&quot;</span><span class="p">,</span> <span class="n">interp_pdb</span><span class="o">.</span><span class="n">type_dict</span><span class="p">)</span>
    
    <span class="c1"># Verify seasonality is preserved</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Seasonality verification:&quot;</span><span class="p">)</span>
    <span class="n">seasonality_preserved</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">interp_pdb</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seasonality_preserved</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Records with seasonality: </span><span class="si">{</span><span class="n">seasonality_preserved</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">interp_pdb</span><span class="o">.</span><span class="n">nrec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Show a sample record</span>
    <span class="n">sample_pid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">interp_pdb</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sample_record</span> <span class="o">=</span> <span class="n">interp_pdb</span><span class="o">.</span><span class="n">records</span><span class="p">[</span><span class="n">sample_pid</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sample CFR ProxyRecord:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  PID: </span><span class="si">{</span><span class="n">sample_record</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Type: </span><span class="si">{</span><span class="n">sample_record</span><span class="o">.</span><span class="n">ptype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Seasonality: </span><span class="si">{</span><span class="n">sample_record</span><span class="o">.</span><span class="n">seasonality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Time points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_record</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Location: (</span><span class="si">{</span><span class="n">sample_record</span><span class="o">.</span><span class="n">lat</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">sample_record</span><span class="o">.</span><span class="n">lon</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR creating CFR ProxyDatabase: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==================================================
Converting to CFR ProxyDatabase...
Creating CFR ProxyDatabase from enhanced DataFrame...
  Processing 0/711...
  Processing 100/711...
  Processing 200/711...
  Processing 300/711...
  Processing 400/711...
  Processing 500/711...
  Processing 600/711...
  Processing 700/711...
Created CFR ProxyDatabase with 711 records
SUCCESS: ProxyDatabase created with 711 records
Proxy types: {&#39;ice.d18O&#39;: 51, &#39;tree.MXD&#39;: 59, &#39;tree.TRW&#39;: 355, &#39;lake.other&#39;: 45, &#39;marine.other&#39;: 60, &#39;documents&#39;: 15, &#39;lake.reflectance&#39;: 1, &#39;coral.SrCa&#39;: 36, &#39;coral.d18O&#39;: 64, &#39;ice.melt&#39;: 2, &#39;borehole&#39;: 3, &#39;speleothem.d18O&#39;: 7, &#39;coral.calc&#39;: 2, &#39;sclerosponge.d18O&#39;: 10, &#39;hybrid&#39;: 1}

Seasonality verification:
Records with seasonality: 711/711

Sample CFR ProxyRecord:
  PID: Ant_030
  Type: ice.d18O
  Seasonality: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
  Time points: 1220
  Location: (-79.46, 247.91)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filtered_pdb_2</span> <span class="o">=</span> <span class="n">interp_pdb</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_pdb_2</span><span class="o">.</span><span class="n">records</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>586
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filtered_pdb_2</span><span class="o">.</span><span class="n">to_nc</span><span class="p">(</span><span class="s1">&#39;./prev_data/pdb_w_seasonality_annual_interp.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Warning: this is an experimental feature.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Warning: this is an experimental feature.</span>

</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 586/586 [00:21&lt;00:00, 26.66it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Data before 1 CE is dropped for records: [&#39;Arc_032&#39;, &#39;SAm_025&#39;, &#39;Arc_025&#39;, &#39;Arc_002&#39;, &#39;Aus_041&#39;, &#39;Arc_031&#39;, &#39;Eur_017&#39;, &#39;Arc_021&#39;, &#39;NAm_880&#39;, &#39;Ant_031dD&#39;, &#39;Ant_031&#39;, &#39;NAm_664&#39;, &#39;Ant_022&#39;, &#39;Arc_020&#39;, &#39;Eur_014&#39;, &#39;Arc_004&#39;, &#39;Eur_001_interp&#39;, &#39;NAm_3870_interp&#39;, &#39;Eur_008_interp&#39;, &#39;Ant_035_interp&#39;].</span>
<span class=" -Color -Color-Bold -Color-Bold-Green">ProxyDatabase saved to: ./prev_data/pdb_w_seasonality_annual_interp.nc</span>

</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pickle_path</span> <span class="o">=</span> <span class="s1">&#39;./prev_data/pdb_w_seasonality_annual_interp.pkl&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">filtered_pdb_2</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving with seasonality preservation using pickle...&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Saved to pickle: </span><span class="si">{</span><span class="n">pickle_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Test loading from pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">test_db_pickle</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Loaded from pickle: </span><span class="si">{</span><span class="n">test_db_pickle</span><span class="o">.</span><span class="n">nrec</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>

<span class="c1"># Verify seasonality is preserved in pickle</span>
<span class="n">seasonality_pickle</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">test_db_pickle</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
    <span class="k">elif</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Annual [1-12]&quot;</span>
    <span class="k">elif</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="o">==</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Summer [6, 7, 8]&quot;</span>
    <span class="k">elif</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="o">==</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Winter [12, 1, 2]&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">seasonality</span><span class="p">)</span>
    
    <span class="n">seasonality_pickle</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">seasonality_pickle</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Seasonality distribution in pickle-loaded database:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">season</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seasonality_pickle</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Show examples</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Example records from pickle with their seasonality:&quot;</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">test_db_pickle</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">seasonality</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">ptype</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">record</span><span class="o">.</span><span class="n">seasonality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># Verify counts</span>
<span class="n">pickle_custom_seasonality</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">test_db_pickle</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> 
                               <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">seasonality</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">seasonality</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">)))</span>
<span class="n">pickle_none_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">test_db_pickle</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">seasonality</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Debugging checks</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Pickle verification:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Records with custom seasonality: </span><span class="si">{</span><span class="n">pickle_custom_seasonality</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Records with None seasonality: </span><span class="si">{</span><span class="n">pickle_none_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Records with annual seasonality: </span><span class="si">{</span><span class="n">test_db_pickle</span><span class="o">.</span><span class="n">nrec</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pickle_custom_seasonality</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pickle_none_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">pickle_custom_seasonality</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">✅ SUCCESS: Seasonality preserved in pickle format!&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Use pickle format for now until CFR NetCDF seasonality support is fixed.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️  Still having issues with seasonality preservation&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File: </span><span class="si">{</span><span class="n">pickle_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving with seasonality preservation using pickle...
✓ Saved to pickle: ./prev_data/pdb_w_seasonality_annual_interp.pkl
✓ Loaded from pickle: 586 records

Seasonality distribution in pickle-loaded database:
  Summer [6, 7, 8]: 309
  Annual [1-12]: 226
  [6, 7]: 6
  Winter [12, 1, 2]: 6
  [8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7]: 5
  [5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4]: 4
  [9, 10, 11, 12, 1, 2, 3, 4]: 4
  [7, 8, 9]: 3
  [3, 4, 5]: 2
  [7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6]: 2

Example records from pickle with their seasonality:
  NAm_568: tree.MXD -&gt; [6, 7, 8]
  Arc_060: tree.MXD -&gt; [6, 7, 8]
  NAm_1876: tree.TRW -&gt; [6, 7, 8]
  NAm_1108: tree.TRW -&gt; [6, 7, 8]
  NAm_1120: tree.MXD -&gt; [6, 7, 8]
  Asia_102: tree.TRW -&gt; [6, 7, 8]
  SAm_025: lake.other -&gt; [11, 12, 1, 2]
  NAm_1396: tree.TRW -&gt; [6, 7, 8]
  NAm_220: tree.TRW -&gt; [6, 7, 8]
  SAm_020: tree.TRW -&gt; [5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4]

Pickle verification:
  Records with custom seasonality: 360
  Records with None seasonality: 0
  Records with annual seasonality: 226

✅ SUCCESS: Seasonality preserved in pickle format!
   Use pickle format for now until CFR NetCDF seasonality support is fixed.

============================================================
File: ./prev_data/pdb_w_seasonality_annual_interp.pkl
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="proxy-database-comparisons">
<h2>Proxy Database Comparisons<a class="headerlink" href="#proxy-database-comparisons" title="Link to this heading">#</a></h2>
<p>We want to see what the difference is in the proxy databases for those that were included before interpolation vs. after. If the reconstructions are drastically different, it is important to note what those differences can be attributed to.</p>
<p>A similar comparison is done in <em>Proxy Database Forensics</em>, with other proxy databases used in this exercise, namely the records used LMRv2.1 and the LMRv2.1 reproduction.</p>
<section id="comparing-interpolated-vs-non-interpolated-presto2k-databases">
<h3>Comparing Interpolated vs. Non-Interpolated PReSto2k databases<a class="headerlink" href="#comparing-interpolated-vs-non-interpolated-presto2k-databases" title="Link to this heading">#</a></h3>
<p>This comparison is straightforward. Since The only difference here should be the 27 records that got added in during the interpolation step, we can easily use <code class="docutils literal notranslate"><span class="pre">cfr</span></code>’s diff operator to directly subtract one from the other to identify the additional records. By doing this, if one reconstruction is significantly better or worse, we can more easily pinpoint which records are the cause.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading from pickle...&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./prev_data/pdb_w_seasonality_annual.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">no_interp</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">no_interp</span><span class="o">.</span><span class="n">nrec</span><span class="si">}</span><span class="s2"> records from pickle&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading from pickle...&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;./prev_data/pdb_w_seasonality_annual_interp.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">with_interp</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="n">with_interp</span><span class="o">.</span><span class="n">nrec</span><span class="si">}</span><span class="s2"> records from pickle&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading from pickle...
Loaded 559 records from pickle
Loading from pickle...
Loaded 586 records from pickle
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">no_interp_pdb</span> <span class="o">=</span> <span class="n">no_interp</span>
<span class="n">with_interp_pdb</span> <span class="o">=</span> <span class="n">with_interp</span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">with_interp_pdb</span><span class="o">-</span><span class="n">no_interp_pdb</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Interpolated Records&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;Figure size 1000x1000 with 1 Axes&gt;,
 {&#39;map&#39;: &lt;GeoAxes: title={&#39;center&#39;: &#39;Interpolated Records&#39;}&gt;})
</pre></div>
</div>
<img alt="../../_images/7e9e7510aa615050ec5887274d141eb2f2ba52f4587816ec1e15fe4f7cd065ea.png" src="../../_images/7e9e7510aa615050ec5887274d141eb2f2ba52f4587816ec1e15fe4f7cd065ea.png" />
</div>
</div>
</section>
<section id="comparing-original-pages2k-with-presto2k">
<h3>Comparing Original PAGES2k with PReSto2k<a class="headerlink" href="#comparing-original-pages2k-with-presto2k" title="Link to this heading">#</a></h3>
<p>This second comparison proves to be much more difficult. Here we compare the ProxyDatabase used in our reproduction of LMRv2.1.
Because the PID naming convention between PAGES2k in <em>cfr</em> and those pulled from the LiPDGraph are slightly different, despite possibly containing a majority of the same actual records, we have to create additional filters to catch all the similarities and differences. To bypass this without overcomplicating the names, we will use the following function <code class="docutils literal notranslate"><span class="pre">match_pid_name</span></code> to check each record between two proxy databases and make sure their lat, lon, and values match without regarding the PID.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load original used in LMRv2.1 reproduction</span>

<span class="n">pdb_og</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ProxyDatabase</span><span class="p">()</span><span class="o">.</span><span class="n">load_nc</span><span class="p">(</span><span class="s1">&#39;./prev_data/pdb/filtered_ptype_res_cfr_pages2kv2.nc&#39;</span><span class="p">)</span>
<span class="n">pdb_og</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We want the preferred pid map to be the pdb1 in the function, so when we use <code class="docutils literal notranslate"><span class="pre">rename_pids</span></code>, the <code class="docutils literal notranslate"><span class="pre">no_interp_pdb</span></code> names will change to the ones in <code class="docutils literal notranslate"><span class="pre">pdb_og</span></code>, which match the orignal naming convention used by <em>cfr</em>.</p>
<p><code class="docutils literal notranslate"><span class="pre">rename_pids</span></code> matches proxy records between two proxy databases using a multi-pass strategy that becomes progressively more flexible. It starts with manual overrides for known pairs, then tries exact location + proxy type + value matches, followed by value-only matches, location-only matches with value prioritization, and finally pure value-based matches with stricter overlap requirements. The goal is to identify corresponding records across databases that may have different naming conventions but represent the same paleoclimate data, through as many steps as can filter out incorrect matches or duplicate matches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_pid_num</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the trailing numeric portion of a proxy record ID.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pid : str or int</span>
<span class="sd">        Proxy record identifier (e.g., &quot;Ocn_112&quot;). Can be any object</span>
<span class="sd">        convertible to string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int or None</span>
<span class="sd">        The integer found at the end of the string if present,</span>
<span class="sd">        otherwise None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)$&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">values_match</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">min_overlap_fraction</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">min_correlation</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test whether two proxy value series represent the same underlying record</span>
<span class="sd">    based on overlapping time coverage and statistical similarity.</span>

<span class="sd">    The function compares two time/value series over their common overlap</span>
<span class="sd">    period. It checks (1) that enough of each record overlaps, and (2) that</span>
<span class="sd">    the values are sufficiently correlated or numerically close.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    v1, v2 : array_like</span>
<span class="sd">        Value arrays for the two records.</span>
<span class="sd">    t1, t2 : array_like</span>
<span class="sd">        Time arrays corresponding to ``v1`` and ``v2``.</span>
<span class="sd">    min_overlap_fraction : float, optional</span>
<span class="sd">        Minimum fraction of overlap (by number of points) required between</span>
<span class="sd">        the two series. Default is 0.7.</span>
<span class="sd">    min_correlation : float, optional</span>
<span class="sd">        Minimum Pearson correlation coefficient required when comparing</span>
<span class="sd">        overlapping segments. Default is 0.8.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if the two series are judged to match, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
        
    <span class="c1"># Find overlap</span>
    <span class="n">common_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">common_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&gt;=</span> <span class="n">common_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&lt;=</span> <span class="n">common_end</span><span class="p">)</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&gt;=</span> <span class="n">common_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t2</span> <span class="o">&lt;=</span> <span class="n">common_end</span><span class="p">)</span>
    
    <span class="n">v1_overlap</span> <span class="o">=</span> <span class="n">v1</span><span class="p">[</span><span class="n">mask1</span><span class="p">]</span>
    <span class="n">v2_overlap</span> <span class="o">=</span> <span class="n">v2</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
    
    <span class="c1"># More lenient overlap check</span>
    <span class="n">overlap_frac</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v1_overlap</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">v2_overlap</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">v2</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">overlap_frac</span> <span class="o">&gt;=</span> <span class="n">min_overlap_fraction</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1_overlap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1_overlap</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">v2_overlap</span><span class="p">):</span>
            <span class="c1"># Same length - use both correlation and closeness</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1_overlap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Need at least 2 points for correlation</span>
                <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">v1_overlap</span><span class="p">,</span> <span class="n">v2_overlap</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">close</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v1_overlap</span><span class="p">,</span> <span class="n">v2_overlap</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">corr</span> <span class="o">&gt;=</span> <span class="n">min_correlation</span><span class="p">)</span> <span class="ow">or</span> <span class="n">close</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v1_overlap</span><span class="p">,</span> <span class="n">v2_overlap</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Different lengths - just check if they&#39;re close after interpolation to shorter length</span>
            <span class="n">min_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v1_overlap</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">v2_overlap</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">min_len</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="c1"># Simple downsampling to same length</span>
                <span class="n">v1_sampled</span> <span class="o">=</span> <span class="n">v1_overlap</span><span class="p">[::</span><span class="nb">len</span><span class="p">(</span><span class="n">v1_overlap</span><span class="p">)</span><span class="o">//</span><span class="n">min_len</span><span class="p">][:</span><span class="n">min_len</span><span class="p">]</span>
                <span class="n">v2_sampled</span> <span class="o">=</span> <span class="n">v2_overlap</span><span class="p">[::</span><span class="nb">len</span><span class="p">(</span><span class="n">v2_overlap</span><span class="p">)</span><span class="o">//</span><span class="n">min_len</span><span class="p">][:</span><span class="n">min_len</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1_sampled</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">v2_sampled</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v1_sampled</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">v1_sampled</span><span class="p">,</span> <span class="n">v2_sampled</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">return</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">corr</span> <span class="o">&gt;=</span> <span class="n">min_correlation</span>
    
    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">match_proxy_records</span><span class="p">(</span><span class="n">pdb1</span><span class="p">,</span> <span class="n">pdb2</span><span class="p">,</span> <span class="n">tol_deg</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Match proxy records between two databases using a multi-pass strategy.</span>

<span class="sd">    Matching proceeds in several stages:</span>
<span class="sd">      1. Apply manual overrides for known ID pairs.</span>
<span class="sd">      2. Location + proxy type + value similarity, with PID numeric tiebreak.</span>
<span class="sd">      3. Value-only matches (when no location match exists).</span>
<span class="sd">      4. Location-only matches, prioritizing value similarity.</span>
<span class="sd">      5. Pure value-based matches with stricter overlap requirements.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pdb1 : ProxyDatabase</span>
<span class="sd">        First proxy database object. Must have a ``records`` dict mapping</span>
<span class="sd">        record IDs to objects with attributes ``lat``, ``lon``, ``ptype``,</span>
<span class="sd">        ``time``, and ``value``.</span>
<span class="sd">    pdb2 : ProxyDatabase</span>
<span class="sd">        Second proxy database object, same requirements as ``pdb1``.</span>
<span class="sd">    tol_deg : float, optional</span>
<span class="sd">        Tolerance in degrees for considering two locations to be the same.</span>
<span class="sd">        Default is 0.03 (~3 km).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matches : dict</span>
<span class="sd">        Mapping from record IDs in ``pdb1`` to their matched record IDs in ``pdb2``.</span>
<span class="sd">    conflicts : dict</span>
<span class="sd">        Dictionary of unresolved or conflicting matches. Keys are ``pdb2`` IDs,</span>
<span class="sd">        values are lists of candidate ``pdb1`` IDs.</span>
<span class="sd">    missing : list</span>
<span class="sd">        List of record IDs in ``pdb1`` that could not be matched.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matches</span><span class="p">,</span> <span class="n">conflicts</span><span class="p">,</span> <span class="n">missing</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">[]</span>
    <span class="n">used_right</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Manual overrides first</span>
    <span class="n">manual_matches</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Ocn_112&#39;</span><span class="p">:</span> <span class="s1">&#39;Ocean2kHR_100&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Ocn_095&#39;</span><span class="p">:</span> <span class="s1">&#39;Ocean2kHR_156&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;Ant_019&#39;</span><span class="p">:</span> <span class="s1">&#39;Ant_033&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Ocn_091&#39;</span><span class="p">:</span> <span class="s1">&#39;Ocean2kHR_157&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Ocn_093&#39;</span><span class="p">:</span> <span class="s1">&#39;Ocean2kHR_158&#39;</span>
    <span class="p">}</span>
    
    <span class="k">for</span> <span class="n">pages_pid</span><span class="p">,</span> <span class="n">presto_pid</span> <span class="ow">in</span> <span class="n">manual_matches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">pages_pid</span> <span class="ow">in</span> <span class="n">pdb1</span><span class="o">.</span><span class="n">records</span> <span class="ow">and</span> <span class="n">presto_pid</span> <span class="ow">in</span> <span class="n">pdb2</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
            <span class="n">matches</span><span class="p">[</span><span class="n">pages_pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">presto_pid</span>
            <span class="n">used_right</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">presto_pid</span><span class="p">)</span>

    <span class="c1"># Pass 1: location + ptype + values + PID tiebreaker</span>
    <span class="k">for</span> <span class="n">pid1</span><span class="p">,</span> <span class="n">r1</span> <span class="ow">in</span> <span class="n">pdb1</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">pid1</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="n">cands</span> <span class="o">=</span> <span class="p">[</span><span class="n">pid2</span> <span class="k">for</span> <span class="n">pid2</span><span class="p">,</span> <span class="n">r2</span> <span class="ow">in</span> <span class="n">pdb2</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">r1</span><span class="o">.</span><span class="n">ptype</span> <span class="ow">and</span>
                     <span class="nb">abs</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">lat</span> <span class="o">-</span> <span class="n">r2</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol_deg</span> <span class="ow">and</span>
                     <span class="nb">abs</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">lon</span> <span class="o">-</span> <span class="n">r2</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol_deg</span> <span class="ow">and</span>
                     <span class="n">pid2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_right</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">matches</span><span class="p">[</span><span class="n">pid1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">used_right</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cands</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cands</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Try values, then PID tiebreaker</span>
            <span class="n">value_cands</span> <span class="o">=</span> <span class="p">[</span><span class="n">pid2</span> <span class="k">for</span> <span class="n">pid2</span> <span class="ow">in</span> <span class="n">cands</span> 
                          <span class="k">if</span> <span class="n">values_match</span><span class="p">(</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pdb2</span><span class="o">.</span><span class="n">records</span><span class="p">[</span><span class="n">pid2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pdb2</span><span class="o">.</span><span class="n">records</span><span class="p">[</span><span class="n">pid2</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">))]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_cands</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">matches</span><span class="p">[</span><span class="n">pid1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_cands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">used_right</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value_cands</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_cands</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># PID tiebreaker</span>
                <span class="n">n1</span> <span class="o">=</span> <span class="n">_pid_num</span><span class="p">(</span><span class="n">pid1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n1</span><span class="p">:</span>
                    <span class="n">pid_match</span> <span class="o">=</span> <span class="p">[</span><span class="n">pid2</span> <span class="k">for</span> <span class="n">pid2</span> <span class="ow">in</span> <span class="n">value_cands</span> <span class="k">if</span> <span class="n">_pid_num</span><span class="p">(</span><span class="n">pid2</span><span class="p">)</span> <span class="o">==</span> <span class="n">n1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pid_match</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">matches</span><span class="p">[</span><span class="n">pid1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">used_right</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pid_match</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Pass 2: values-only</span>
    <span class="k">for</span> <span class="n">pid1</span><span class="p">,</span> <span class="n">r1</span> <span class="ow">in</span> <span class="n">pdb1</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">pid1</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="n">value_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">pid2</span> <span class="k">for</span> <span class="n">pid2</span><span class="p">,</span> <span class="n">r2</span> <span class="ow">in</span> <span class="n">pdb2</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">pid2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_right</span> <span class="ow">and</span>
                            <span class="n">values_match</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">time</span><span class="p">)))]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">matches</span><span class="p">[</span><span class="n">pid1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">used_right</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Mark remaining as missing</span>
    <span class="k">for</span> <span class="n">pid1</span> <span class="ow">in</span> <span class="n">pdb1</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pid1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid1</span><span class="p">)</span>

    <span class="c1"># Pass 3: Location-only with value priority</span>
    <span class="k">for</span> <span class="n">pid1</span><span class="p">,</span> <span class="n">r1</span> <span class="ow">in</span> <span class="n">pdb1</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">pid1</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="c1"># Find all records at same location regardless of ptype</span>
        <span class="n">location_matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pid2</span><span class="p">,</span> <span class="n">r2</span> <span class="ow">in</span> <span class="n">pdb2</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pid2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_right</span> <span class="ow">and</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">lat</span> <span class="o">-</span> <span class="n">r2</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol_deg</span> <span class="ow">and</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">lon</span> <span class="o">-</span> <span class="n">r2</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol_deg</span><span class="p">):</span>
                <span class="n">location_matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pid2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">matches</span><span class="p">[</span><span class="n">pid1</span><span class="p">]</span> <span class="o">=</span> <span class="n">location_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">used_right</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">location_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Prioritize value matching</span>
            <span class="n">value_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">pid2</span> <span class="k">for</span> <span class="n">pid2</span> <span class="ow">in</span> <span class="n">location_matches</span>
                            <span class="k">if</span> <span class="n">values_match</span><span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pdb2</span><span class="o">.</span><span class="n">records</span><span class="p">[</span><span class="n">pid2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pdb2</span><span class="o">.</span><span class="n">records</span><span class="p">[</span><span class="n">pid2</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">))]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">matches</span><span class="p">[</span><span class="n">pid1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">used_right</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># No value matches - leave unmatched rather than guess</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Multiple value matches - only use PID as very last resort</span>
                <span class="n">n1</span> <span class="o">=</span> <span class="n">_pid_num</span><span class="p">(</span><span class="n">pid1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n1</span><span class="p">:</span>
                    <span class="n">pid_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">pid2</span> <span class="k">for</span> <span class="n">pid2</span> <span class="ow">in</span> <span class="n">value_matches</span> <span class="k">if</span> <span class="n">_pid_num</span><span class="p">(</span><span class="n">pid2</span><span class="p">)</span> <span class="o">==</span> <span class="n">n1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pid_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">matches</span><span class="p">[</span><span class="n">pid1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">used_right</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pid_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># If still multiple candidates, leave unmatched rather than guess</span>
                
    <span class="c1"># Pass 4: Pure value matching with substantial overlap</span>
    <span class="k">for</span> <span class="n">pid1</span><span class="p">,</span> <span class="n">r1</span> <span class="ow">in</span> <span class="n">pdb1</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">pid1</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="c1"># Check all remaining records for value similarity</span>
        <span class="k">for</span> <span class="n">pid2</span><span class="p">,</span> <span class="n">r2</span> <span class="ow">in</span> <span class="n">pdb2</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pid2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_right</span> <span class="ow">and</span>
                <span class="n">values_match</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">time</span><span class="p">),</span>
                    <span class="n">min_overlap_fraction</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)):</span>  <span class="c1"># Slightly more lenient</span>
                
                <span class="n">matches</span><span class="p">[</span><span class="n">pid1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid2</span>
                <span class="n">used_right</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pid2</span><span class="p">)</span>
                <span class="k">break</span>  <span class="c1"># Take first substantial match found</span>

    <span class="c1"># Update missing list</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">pid</span> <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pdb1</span><span class="o">.</span><span class="n">records</span> <span class="k">if</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>


    <span class="k">return</span> <span class="n">matches</span><span class="p">,</span> <span class="n">conflicts</span><span class="p">,</span> <span class="n">missing</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">rename_pids</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rename record identifiers (PIDs) in a ProxyDatabase.</span>

<span class="sd">    This function replaces PIDs in a ProxyDatabase according to a mapping of</span>
<span class="sd">    `{new_pid: old_pid}`. Each record with an `old_pid` key is reassigned to</span>
<span class="sd">    `new_pid`. If `new_pid` already exists in the database, that rename is skipped</span>
<span class="sd">    to avoid collisions. Records not listed in the mapping remain unchanged.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pdb : cfr.ProxyDatabase</span>
<span class="sd">        The ProxyDatabase whose records should be renamed.</span>
<span class="sd">    matches : dict</span>
<span class="sd">        Dictionary mapping `{new_pid: old_pid}`. Keys are the preferred PIDs to</span>
<span class="sd">        assign, values are the current PIDs in `pdb`.</span>
<span class="sd">    in_place : bool, optional</span>
<span class="sd">        If True, rename records directly in `pdb`. If False (default), return a</span>
<span class="sd">        modified copy and leave the original unchanged.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cfr.ProxyDatabase</span>
<span class="sd">        A ProxyDatabase with updated PIDs following the mapping. If `in_place`</span>
<span class="sd">        is False, this is a new object; otherwise the input object is modified</span>
<span class="sd">        and returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">pdb</span> <span class="k">if</span> <span class="n">in_place</span> <span class="k">else</span> <span class="n">pdb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">records</span>
    <span class="k">for</span> <span class="n">new_pid</span><span class="p">,</span> <span class="n">old_pid</span> <span class="ow">in</span> <span class="n">matches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">old_pid</span> <span class="ow">in</span> <span class="n">recs</span> <span class="ow">and</span> <span class="n">new_pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">:</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">old_pid</span><span class="p">)</span>
            <span class="c1"># update the record&#39;s internal pid if it has one</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="s2">&quot;pid&quot;</span><span class="p">):</span>
                <span class="n">rec</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">new_pid</span>
            <span class="n">recs</span><span class="p">[</span><span class="n">new_pid</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span>
    <span class="k">return</span> <span class="n">db</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now test the  matching</span>
<span class="n">matches</span><span class="p">,</span> <span class="n">conflicts</span><span class="p">,</span> <span class="n">missing</span> <span class="o">=</span> <span class="n">match_proxy_records</span><span class="p">(</span><span class="n">pdb_og</span><span class="p">,</span> <span class="n">no_interp_pdb</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== MATCHING RESULTS ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matches found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conflicts: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">conflicts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing from PReSto2k: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== MATCHING RESULTS ===
Matches found: 505
Conflicts: 0
Missing from PReSto2k: 53
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-run the renaming with all matches</span>
<span class="n">no_interp_fully_renamed</span> <span class="o">=</span> <span class="n">rename_pids</span><span class="p">(</span><span class="n">no_interp_pdb</span><span class="p">,</span> <span class="n">matches</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have renamed the matching pids, we can use the Proxy Database subtraction that is built into <em>cfr</em>. This will give us two maps of which records are missing from both the PReSto2k database and the original PAGES2k database used to reproduce LMRv2.1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the map of records not in PAGES2k </span>

<span class="n">diff</span> <span class="o">=</span> <span class="n">no_interp_fully_renamed</span> <span class="o">-</span> <span class="n">pdb_og</span>

<span class="n">diff</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;In PReSto2k not PAGES2k&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_167 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_024 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_086 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_076 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_099 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_158 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_035 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_177 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_171 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_069 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_170 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_088 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_116 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_130 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_131 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_147 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_174 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_160 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_172 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_066 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_166 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_140 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_141 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_179 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_007 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_028 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_005 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_168 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_142 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_143 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_129 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_120 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_121 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_127 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_008 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_128 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_173 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_118 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_139 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_061 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_062 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_079 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_131 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_107 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_157 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_146 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_181 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_182 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_162 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_163 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_161 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_125 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_090 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_119 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_097 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_159 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_024 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_169 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_071 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_072 failed.</span>

</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;Figure size 1000x1000 with 1 Axes&gt;,
 {&#39;map&#39;: &lt;GeoAxes: title={&#39;center&#39;: &#39;In PReSto2k not PAGES2k&#39;}&gt;})
</pre></div>
</div>
<img alt="../../_images/5d48b3fbaba45a6d586e849e2e86857903ac5ac30caa834cbc0c24323c0f0682.png" src="../../_images/5d48b3fbaba45a6d586e849e2e86857903ac5ac30caa834cbc0c24323c0f0682.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the map of records not in PReSto2k</span>

<span class="n">diff_other</span> <span class="o">=</span> <span class="n">pdb_og</span> <span class="o">-</span> <span class="n">no_interp_fully_renamed</span>

<span class="n">diff_other</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;In PAGES2k not PReSto2k&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting SAm_020 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting LPDb9285123 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_026 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting SAm_0243 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_022 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_037 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3100 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting SAm_032 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_002 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_031 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_017 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_016 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_058 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_031dD failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_031 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_018 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting O2kLR_183 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_050 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asia_235 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_014 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_023 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Africa_001 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocean2kHR_011_iso2k failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting KA17RYU01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting FL17DTO02_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting BO14HTI01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting SA16CLA01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN03_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN02_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN06_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN07_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting ZI16ROD01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN05_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting HE13MIS01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting HE13MIS01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN04_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting RA20TAI01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting RA20TAI01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting TA18TAS01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting LI04FIJ01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting LI04FIJ01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting WU13TON01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting CH97BVB01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting HE18COC01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting HE18COC01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting MU18NPI01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting MU18NPI01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting ZI15IMP02_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting KI14PAR01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting KI14PAR01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting ZI15IMP01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting GO08BER01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting GO08BER01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting KI08PAR01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN09_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN08_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting XI17HAI01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting XI17HAI01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting DE14DTO01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting DE14DTO02_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting LI06FIJ01_d18O failed.</span>

</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;Figure size 1000x1000 with 1 Axes&gt;,
 {&#39;map&#39;: &lt;GeoAxes: title={&#39;center&#39;: &#39;In PAGES2k not PReSto2k&#39;}&gt;})
</pre></div>
</div>
<img alt="../../_images/567533e23253d6e6e81a131884bc7ee32f98278033abf09d513f0aade80a8923.png" src="../../_images/567533e23253d6e6e81a131884bc7ee32f98278033abf09d513f0aade80a8923.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">records</span><span class="p">)</span><span class="si">}</span><span class="s1"> in PReSto2k but NOT in PAGES2k&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">diff_other</span><span class="o">.</span><span class="n">records</span><span class="p">)</span><span class="si">}</span><span class="s1"> in PAGES2k but NOT in PReSto2k&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 61 in PReSto2k but NOT in PAGES2k
There are 60 in PAGES2k but NOT in PReSto2k
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="comparing-meta-vs-class-based-seasonality">
<h2>Comparing Meta vs. Class Based Seasonality<a class="headerlink" href="#comparing-meta-vs-class-based-seasonality" title="Link to this heading">#</a></h2>
<p>We will now run the same renaming/matching test on metadata based Proxy Database and class-based. One important difference of note is that we are doing this comparison before calibration. The calibration step automatically filters out a number of records that do not meet certain requirements (See: <em>Run Data Assimilation</em>). Due to this, the <code class="docutils literal notranslate"><span class="pre">class_og</span></code> proxy database is unfiltered from the get-go (initial LiPD dataframe) and not filtered by resolution unlike the metadata ones (both with and without interpolation). During calibration, ~120 records get removed and hence this current proxy database appears significantly larger than what is actually assimilated in the DA step.</p>
<p>In a further experiment, it will be helpful to compare just the records that were used post-calibration between the two Proxy Databases to get a full breakdown for why one reconstruction outperforms the other.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">class_og</span> <span class="o">=</span> <span class="n">cfr</span><span class="o">.</span><span class="n">ProxyDatabase</span><span class="p">()</span><span class="o">.</span><span class="n">load_nc</span><span class="p">(</span><span class="s1">&#39;./prev_data/lipd_pdb_pids.nc&#39;</span><span class="p">)</span>
<span class="n">class_og</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">matches_2</span><span class="p">,</span> <span class="n">conflicts_2</span><span class="p">,</span> <span class="n">missing_2</span> <span class="o">=</span> <span class="n">match_proxy_records</span><span class="p">(</span><span class="n">class_og</span><span class="p">,</span> <span class="n">no_interp_pdb</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-run the renaming with all matches</span>
<span class="n">no_interp_fully_renamed_2</span> <span class="o">=</span> <span class="n">rename_pids</span><span class="p">(</span><span class="n">no_interp_pdb</span><span class="p">,</span> <span class="n">matches_2</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diffo</span> <span class="o">=</span> <span class="n">class_og</span> <span class="o">-</span> <span class="n">no_interp_fully_renamed_2</span>
<span class="n">diffo2</span> <span class="o">=</span> <span class="n">no_interp_fully_renamed_2</span><span class="o">-</span><span class="n">class_og</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocean2kHR_095 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_031dD failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocean2kHR_157 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocean2kHR_158 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting FL17DTO02_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN03_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN07_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting LI04FIJ01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting LI06FIJ01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_066 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_324 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_156 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_010 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_051 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_045 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_040 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-EmeraldBasin.Keigwin.2007_LPD68872399 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant-DSS.DahlJensen.1999_LPD7abab671 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3810 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_194 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_193 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-MD98-2160.Newton.2010_LPD7e8e8eaa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-WestSpitzberg.Bonnet.2010_LPD995c6f3c failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_074 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3804 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-FiskBasin.Richey.2009_LPD57d40973 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_024 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_230 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_044 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-AlboranSea436B.Nieto-Moreno.2013_LPD0e0867fe failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_187 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_317 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_001 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_305 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-CH07-98-MC-22.Saenger.2011_LPDa03ec713 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3816 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-FeniDrift.Richter.2009_LPD47182517 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-WesternSvalbard.Spielhagen.2011_O2kLR_007 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3851 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_009 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-MD98-2177.Newton.2010_LPD30c5b95c failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-ODP984.Came.2007_LPDbd07f717 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_247 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_009 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_321 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_025 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-GulfofGuinea.Weldeab.2007_LPD9cc3baf6-dup failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_030 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_073 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-SouthChinaSea.Zhao.2006_LPD44b374e7 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_082 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_328 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-JacafFjord.Sepulveda.2009_LPD6315f935 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_320 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_114 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3801 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi-SihailongwaLake.Chu.2011_LPDdc74a376 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3870 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_013 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Aus-DuckholeLake.Saunders.2013_LPD335d863f failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_039 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_150 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_042 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-PigmyBasin.Richey.2015_LPD572f7cc3 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-MD95-2011.Grimalt.2002_O2kLR_105 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_125 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Afr-LakeMalawi.Powers.2011_Malawi05 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-MinorcaContourite.Moreno.2012_LPD10e9f8f7 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Afr_004 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3853 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_327 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-CariacoBasin.Lea.2003_LPDcda1c277 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_047 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_326 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Afr-P178-15P.Tierney.2015_LPD53e179ad failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Afr-P178-15P.Tierney.2015_LPD81e53153 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_101 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-WesternAntarcticPeninsula.Shevenell.2011_LPD2a3997a7 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3798 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_329 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-TagusMudPatch.Abrantes.2005_LPDb7ba9166 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant-WDC06A.Steig.2013_Ant_031dD failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_319 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3807 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_165 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_056 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_129 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_128 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-SouthAtlanticWestAfrica.Leduc.2010_LPDa77273bb failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-DryTortugas.Lund.2006_LPDf7bace53 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_325 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_036 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-GreatBahamaBank.Lund.2006_LPD7c7e19c5 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_008 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3867 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3868 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-WEqPacific.Stott.2007_O2kLR_131 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-SWCoastOfIndia.Saraswat.2013_O2kLR_118 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_052 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-EasternTropicalNorthAtlantic.Kuhnert.2011_LPD13a78f9b failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_126 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_127 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_175 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_146 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_195 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-Philippines.Stott.2007_LPD1a0245b7 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_148 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_012 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_037 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-GreatBahamaBank.Richter.2006_LPDefb3d2b0 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_041 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_078 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-RAPiD-12-1K.Thornalley.2009_LPDb17a5e9e-dup failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_043 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Eur_010 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_049 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting NAm_3819 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_335 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-CariacoBasin.Black.2007_LPDe51d17e8 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-AlboranSea384B.Nieto-Moreno.2013_LPDasan2012 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ant_035 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_157 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_158 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn-CapeGhir.McGregor.2007_LPD84ab67b9 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_079 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_053 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_017 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_048 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Arc_045 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Ocn_135 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting Asi_318 failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting CO00DRBE_Ocean2kHR_125_iso2k failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting SS03HAJA_Ocean2kHR_128_iso2k failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting FL17DTO02_FL17DTO02_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN03_AB20MEN03_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting AB20MEN07_AB20MEN07_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting DR00NBB01_DR00NBB01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting LI04FIJ01_LI04FIJ01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting RO19PAR01_RO19PAR01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting HE02GBR01_HE02GBR01_d18O failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting HE02GBR01_HE02GBR01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting KI08PAR01_KI08PAR01_SrCa failed.</span>
<span class=" -Color -Color-Bold -Color-Bold-Yellow">&gt;&gt;&gt; Subtracting LI06FIJ01_LI06FIJ01_d18O failed.</span>

</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diffo</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;in PReSto2k class not meta&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;Figure size 1000x1000 with 1 Axes&gt;,
 {&#39;map&#39;: &lt;GeoAxes: title={&#39;center&#39;: &#39;in PReSto2k class not meta&#39;}&gt;})
</pre></div>
</div>
<img alt="../../_images/afdec196eb8b191f01af704f7c31e5e2653623418ac7a402989bd4cd8de5ac58.png" src="../../_images/afdec196eb8b191f01af704f7c31e5e2653623418ac7a402989bd4cd8de5ac58.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diffo2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;in PReSto2k meta not class&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;Figure size 1000x1000 with 1 Axes&gt;,
 {&#39;map&#39;: &lt;GeoAxes: title={&#39;center&#39;: &#39;in PReSto2k meta not class&#39;}&gt;})
</pre></div>
</div>
<img alt="../../_images/3c9344fb14dfea469dccd0091c36b81c97c0644c5527b355973ca0b8d28cb6c8.png" src="../../_images/3c9344fb14dfea469dccd0091c36b81c97c0644c5527b355973ca0b8d28cb6c8.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/data_assembly"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="C01_b_db_assembly_cfr_PAGES2k.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Database Assembly using cfr’s built in PAGES 2k database</p>
      </div>
    </a>
    <a class="right-next"
       href="C01_d_db_assembly_LiPDGraph.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Assembling the proxy database from the LiPDGraph</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">Authors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goal">Goal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-description">Data Description</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exploring-the-records-in-each-of-the-compilations">Exploring the records in each of the compilations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pages2k">PAGES2k</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iso2k">iso2k</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coralhydro2k">CoralHydro2k</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#database-assemble">DataBase: Assemble!</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#special-handling-the-palmyra-record">Special handling: The Palmyra record</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-duplication-sr-ca">Handling duplication: Sr/Ca</a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-correlation">Option 1: Correlation</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-dynamic-time-wrapping">Option 2: Dynamic Time Wrapping</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#option-3-principal-component-analysis">Option 3: Principal Component Analysis</a></li>
</ul>
</li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-duplication-part-2-delta-18-mathrm-o">Handling duplication part 2: <span class="math notranslate nohighlight">\(\delta^{18}\mathrm{O}\)</span></a><ul class="nav section-nav flex-column">
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Option 1: Correlation</a></li>
<li class="toc-h6 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-dtw">Option 2: DTW</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-cleaning-and-pre-processing">Data Cleaning and Pre-processing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-remove-records-shorter-than-150-years">Step 1: Remove records shorter than 150 years</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-screen-for-duplicates">Step 2: Screen for duplicates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-the-cfr-proxydatabase">Building the cfr.ProxyDataBase</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-ptype-and-seasonality-info">Adding ptype and seasonality info</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quick-debug-before-saving-proxydatabases">Quick debug before saving ProxyDatabases</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-filter-by-dt-1">Option 1: Filter by dt &lt;= 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-interpolated-then-filtered-by-annual-subannual">Option 2: Interpolated then filtered by annual/subannual</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#proxy-database-comparisons">Proxy Database Comparisons</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-interpolated-vs-non-interpolated-presto2k-databases">Comparing Interpolated vs. Non-Interpolated PReSto2k databases</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-original-pages2k-with-presto2k">Comparing Original PAGES2k with PReSto2k</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-meta-vs-class-based-seasonality">Comparing Meta vs. Class Based Seasonality</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Tanaya Gondhalekar, Deborah Khider, Julien Emile-Geay
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>